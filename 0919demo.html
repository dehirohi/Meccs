<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備点検管理システム</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family-base: 'Noto Sans JP', 'Inter', sans-serif;
            --color-bg: #f9fafb;
            --color-surface: #ffffff;
            --color-border: #e5e7eb;
            --color-border-light: #f3f4f6;
            --color-text-primary: #1f2937;
            --color-text-secondary: #6b7280;
            --color-text-placeholder: #9ca3af;
            --color-primary: #3b82f6;
            --color-primary-hover: #2563eb;
            --color-primary-light: #eff6ff;
            --color-primary-text: #1e40af;
            --color-success: #10b981;
            --color-success-light: #ecfdf5;
            --color-success-text: #065f46;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-danger-light: #fef2f2;
            --color-danger-text: #991b1b;
            --color-warning: #f59e0b;
            --color-warning-light: #fffbeb;
            --color-warning-text: #92400e;
            --color-info: #3b82f6;
            --color-sidebar-bg: #111827;
            --color-sidebar-text: #d1d5db;
            --color-sidebar-text-hover: #ffffff;
            --color-sidebar-hover-bg: #1f2937;
            --color-sidebar-active: var(--color-primary);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-full: 9999px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: var(--font-family-base); background-color: var(--color-bg); color: var(--color-text-primary); line-height: 1.7; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--color-sidebar-bg); color: var(--color-sidebar-text); transition: transform 0.3s ease; position: fixed; height: 100vh; z-index: 1000; overflow-y: auto; }
        .sidebar.hidden { transform: translateX(-260px); }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #1f2937; display: flex; align-items: center; justify-content: space-between; }
        .sidebar-title { font-size: 1.125rem; font-weight: 600; color: white; margin: 10px;}
        .menu-toggle { background: none; border: none; color: var(--color-sidebar-text); font-size: 1.5rem; cursor: pointer; transition: color 0.2s; }
        .menu-toggle:hover { color: white; }
        .nav-menu { list-style: none; padding: 1rem 0; }
        .nav-item { margin: 0 0.75rem 0.25rem; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 1rem; color: var(--color-sidebar-text); text-decoration: none; transition: all 0.2s; cursor: pointer; border-radius: var(--radius-md); font-weight: 500; }
        .nav-link:hover { background-color: var(--color-sidebar-hover-bg); color: var(--color-sidebar-text-hover); }
        .nav-link.active { background-color: var(--color-primary); color: white; }
        .nav-link svg { width: 20px; height: 20px; }
        .nav-item.nav-item-group-b .nav-link:not(.active) { background-color: #207a64; }
        .nav-item.nav-item-group-b .nav-link:not(.active):hover { background-color: #4b5563; }
        .main-content { flex: 1; margin-left: 260px; transition: margin-left 0.3s ease; display: flex; flex-direction: column; }
        .main-content.sidebar-hidden { margin-left: 0; }
        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 900;
        }
        .menu-toggle-main { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-secondary); flex-shrink: 0; }
        #pageTitle { font-size: 1.75rem; font-weight: 700; color: var(--color-text-primary); flex-shrink: 0; white-space: nowrap; }
        #page-controls-wrapper {
            display: flex;
            flex-grow: 1;
            justify-content: space-between;
            align-items: center;
            min-width: 0;
        }
        #header-filters-mount {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            min-width: 0;
        }
        #header-actions-mount {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-shrink: 0;
        }
        .content { padding: 2rem; flex-grow: 1; }
        .page { display: none; }
        .page.active { display: block; }
        .card { background: var(--color-surface); border-radius: var(--radius-lg); padding: 1.75rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-md); border: 1px solid var(--color-border); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1.25rem; border-bottom: 1px solid var(--color-border-light); flex-wrap: wrap; gap: 1rem; }
        .card-header:empty { display: none; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--color-text-primary); flex-shrink: 0; }
        .header-filters { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; }
        .header-filters .form-input, .header-filters .form-select, .header-filters .custom-datalist-container { width: auto; min-width: 150px; }
        .search-input { width: 250px; }
        .btn { padding: 0.625rem 1.25rem; border: 1px solid transparent; border-radius: var(--radius-md); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
        .btn-primary:hover { background-color: var(--color-primary-hover); border-color: var(--color-primary-hover); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .btn-secondary { background: var(--color-surface); color: var(--color-text-secondary); border-color: var(--color-border); }
        .btn-secondary:hover { background: var(--color-bg); border-color: #d1d5db; }
        .btn-success { background: var(--color-success); color: white; border-color: var(--color-success); }
        .btn-success:hover { background-color: #059669; border-color: #059669; }
        .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.8rem; }
        .btn-danger { background: var(--color-danger); color: white; border-color: var(--color-danger); }
        .btn-danger:hover { background-color: var(--color-danger-hover); border-color: var(--color-danger-hover); }
        .btn-info { background: var(--color-info); color: white; border-color: var(--color-info); }
        .btn-info:hover { background-color: #2563eb; border-color: #2563eb; }
        .btn-icon { padding: 0.5rem; width: 38px; height: 38px; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--color-text-primary); font-size: 0.875rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--color-border); border-radius: var(--radius-md); font-size: 0.9rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: white; }
        .form-select { color: var(--color-text-primary); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .form-select.form-select-sm { padding-top: 0.375rem; padding-bottom: 0.375rem; font-size: 0.8rem; }
        .form-textarea { resize: vertical; min-height: 120px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .table-container { overflow-x: auto; margin-top: 1rem; }
        .table { width: 100%; border-collapse: collapse; background: var(--color-surface); table-layout: fixed; }
        .table th, .table td { padding: 0.875rem 1.25rem; text-align: left; border-bottom: 1px solid var(--color-border-light); vertical-align: middle; }
        .table td { max-width: 25ch; white-space: normal; word-wrap: break-word; vertical-align: top; }
        .table th { background: var(--color-bg); font-weight: 600; color: var(--color-text-secondary); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
        .table th.sortable { cursor: pointer; user-select: none; }
        .table th.sortable:hover { background: #f1f5f9; color: var(--color-text-primary); }
        .table th.sort-asc::after, .table th.sort-desc::after { content: ''; display: inline-block; margin-left: 0.5em; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; }
        .table th.sort-asc::after { border-bottom: 4px solid var(--color-text-primary); }
        .table th.sort-desc::after { border-top: 4px solid var(--color-text-primary); }
        .table tr:hover { background: var(--color-bg); }
        .table-thumbnail { width: 80px; height: 60px; object-fit: cover; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--color-border); }
        .table-thumbnail:hover { transform: scale(1.1); box-shadow: var(--shadow-md); }
        .inspection-grid-table { border: 1px solid var(--color-border); border-radius: var(--radius-lg); overflow: hidden; table-layout: auto;}
        .inspection-grid-table thead th { background: var(--color-bg); color: var(--color-text-primary); padding: 1rem; font-weight: 600; text-align: center; min-width: 170px; border-right: 1px solid var(--color-border); border-bottom: 2px solid var(--color-border); vertical-align: top; }
        .inspection-grid-table th .cycle-badge { display: inline-block; font-size: 0.75rem; font-weight: 500; padding: 0.2rem 0.6rem; border: 1px solid var(--color-border); border-radius: var(--radius-full); color: var(--color-text-secondary); margin-top: 0.5rem; background-color: white; }
        .inspection-grid-table tbody tr { border-bottom: 2px solid var(--color-border); }
        .inspection-grid-table tbody tr:last-child { border-bottom: none; }
        .inspection-grid-table tbody tr:nth-child(even) { background-color: var(--color-bg); }
        .inspection-grid-table td { padding: 1rem; border-right: 1px solid var(--color-border); vertical-align: top; min-width: 170px; }
        .inspection-grid-table .equipment-cell { background: #f8fafc; font-weight: 600; color: var(--color-text-primary); min-width: 250px; position: sticky; left: 0; z-index: 10; border-right: 2px solid var(--color-border); }
        .inspection-grid-table tr:nth-child(even) .equipment-cell { background-color: #f1f5f9; }
        .equipment-cell-content { display: flex; flex-direction: column; gap: 0.75rem; }
        .equipment-quantity-input { width: 80px; text-align: right; }
        .photo-upload-label { display: inline-flex; cursor: pointer; }
        .photo-upload-label input[type="file"] { display: none; }
        .photo-preview { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
        .photo-preview img { width: 48px; height: 48px; object-fit: cover; border-radius: var(--radius-md); border: 2px solid white; box-shadow: var(--shadow-sm); cursor: pointer; transition: transform 0.2s; }
        .photo-preview img:hover { transform: scale(1.1); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.6); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--color-surface); margin: 1rem auto; padding: 1rem; border-radius: var(--radius-lg); width: 95%; max-width: 750px; max-height: calc(100vh - 1rem); overflow-y: auto; box-shadow: var(--shadow-lg); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #equipmentModal .modal-content, #templateModal .modal-content, #equipmentTypeModal .modal-content, #itemSetModal .modal-content, #buildingModal .modal-content, #workOrderModal .modal-content, #datasetReferencePreviewModal .modal-content, #workOrderPreviewModal .modal-content, #resultDetailModal .modal-content, #inspectionHistoryModal .modal-content { max-width: 1200px; }
        #photoModal { z-index: 2100; }
        #photoModal .modal-content { width: 90vw; height: 90vh; max-width: 1200px; padding: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; background: transparent; box-shadow: none; backdrop-filter: none; }
        #photoModal img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: var(--radius-lg); }
        .modal-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .modal-column { display: flex; flex-direction: column; }
        .modal-column .table-container { flex-grow: 1; }
        .modal-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .modal-filters .search-input, .modal-filters .form-select, .modal-filters .custom-datalist-container { width: 100%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.1rem; padding-bottom: 0.1rem; border-bottom: 1px solid var(--color-border-light); }
        .modal-title { font-size: 1.2rem; font-weight: 700; color: var(--color-text-primary); }
        .close { color: var(--color-text-secondary); font-size: 2rem; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close:hover { color: var(--color-text-primary); }
        .option-input-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .option-input-group input { flex: 1; }
        .input-with-button { display: flex; gap: 0.5rem; }
        .input-with-unit { display: flex; align-items: center; gap: 0.5rem; }
        .input-with-unit input { flex: 1; }
        .input-with-unit span { color: var(--color-text-secondary); font-size: 0.9rem; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-badge.completed { background-color: var(--color-success-light); color: var(--color-success-text); }
        .status-badge.pending { background-color: var(--color-warning-light); color: var(--color-warning-text); }
        .status-badge.confirmed { background-color: var(--color-primary-light); color: var(--color-primary-text); }
        .status-badge.not-executed { background-color: var(--color-border-light); color: var(--color-text-secondary); }
        .common-items-container { margin-bottom: 2rem; padding: 1.5rem; border: 1px solid var(--color-border); border-radius: var(--radius-lg); background-color: var(--color-surface); }
        .common-items-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .pagination-container { display: flex; justify-content: flex-end; align-items: center; margin: 1.5rem 0; padding: 0 0.5rem; }
        .pagination { display: flex; padding-left: 0; list-style: none; }
        .page-item .page-link { position: relative; display: block; padding: 0.5rem 1rem; line-height: 1.25; color: var(--color-primary); background-color: var(--color-surface); border: 1px solid var(--color-border); cursor: pointer; text-decoration: none; transition: all 0.2s; }
        .page-item:not(:first-child) .page-link { margin-left: -1px; }
        .page-item.disabled .page-link { color: #9ca3af; pointer-events: none; background-color: var(--color-bg); }
        .page-item.active .page-link { z-index: 3; color: #fff; background-color: var(--color-primary); border-color: var(--color-primary); }
        .page-item:first-child .page-link { border-top-left-radius: var(--radius-md); border-bottom-left-radius: var(--radius-md); }
        .page-item:last-child .page-link { border-top-right-radius: var(--radius-md); border-bottom-right-radius: var(--radius-md); }
        .page-link:hover { color: var(--color-primary-hover); background-color: var(--color-primary-light); }
        #item-set-items-container { border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 1rem; max-height: 40vh; overflow-y: auto; background-color: var(--color-bg); }
        
        .item-set-item-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: flex-start;
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            background-color: white;
        }
        .item-set-item-row:last-child { border-bottom: none; }
        .item-set-item-row .reorder-handle { margin-top: 0.5rem; }
        .item-set-item-row .item-content { display: flex; flex-direction: column; gap: 0.75rem; }
        .item-set-item-row .item-controls-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; }
        .item-set-item-row .item-controls-row .form-select { font-size: 0.85rem; padding-top: 0.5rem; padding-bottom: 0.5rem;}
        .item-set-item-row .item-name-input { font-size: 1rem; }
        .item-set-item-row .item-options-container { margin-top: 0.5rem; }

        .reorder-handle { display: flex; flex-direction: column; gap: 4px; }
        .reorder-handle button { padding: 0.25rem; line-height: 1; }
        #equipment-list > .card, #building-management > .card, #organization-management > .card, #item-set-management > .card, #inspection-templates > .card, #work-order-management > .card, #work-order-selection > .card, #work-results-management > .card, #result-detail-view > .card, #dataset-reference > .card, #news-management > .card { display: flex; flex-direction: column; max-height: calc(100vh - 120px); }
        #equipment-list .table-container, #building-management .table-container, #organization-management .table-container, #item-set-management .table-container, #inspection-templates .table-container, #work-order-management .table-container, #work-order-selection .table-container, #work-results-management .table-container, #result-detail-view .card-content-wrapper, #dataset-reference .table-container, #news-management .table-container { flex-grow: 1; overflow-y: auto; min-height: 0; max-height: none; }
        .table th { position: -webkit-sticky; position: sticky; top: 0; z-index: 1; }
        .inspection-input-cell { display: flex; flex-direction: column; gap: 0.5rem; }
        .inspection-input-cell .na-checkbox { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--color-text-secondary); }
        #buildingFloorsContainer .floor-row { display: flex; align-items: center; gap: 1rem; background-color: var(--color-bg); padding: 0.75rem 1rem; border-radius: var(--radius-md); margin-bottom: 1rem; border: 1px solid var(--color-border); }
        #buildingFloorsContainer .floor-row .floor-name-input { width: 200px; flex-shrink: 0; }
        #buildingFloorsContainer .floor-row .photo-upload-label { flex-shrink: 0; }
        #buildingFloorsContainer .floor-row .photo-preview { margin-top: 0; flex-grow: 1; min-width: 0; }
        #buildingFloorsContainer .floor-row .photo-preview img { width: 60px; height: 45px; margin: 0; }
        #buildingFloorsContainer .floor-row .btn-danger { flex-shrink: 0; margin-left: auto; }
        #unlinked-equipment-list .list-group-item, #linked-equipment-list .list-group-item,
        #unlinked-equipment-list-preview .list-group-item, #linked-equipment-list-preview .list-group-item { padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--color-border-light); cursor: pointer; transition: background-color 0.2s, border-color 0.2s; background-color: white; border: 2px solid transparent;}
        #unlinked-equipment-list .list-group-item:last-child, #linked-equipment-list .list-group-item:last-child,
        #unlinked-equipment-list-preview .list-group-item:last-child, #linked-equipment-list-preview .list-group-item:last-child { border-bottom: none; }
        #unlinked-equipment-list .list-group-item:hover, #linked-equipment-list .list-group-item:hover,
        #unlinked-equipment-list-preview .list-group-item:hover, #linked-equipment-list-preview .list-group-item:hover { background-color: var(--color-bg); }
        #unlinked-equipment-list .list-group-item.active, #linked-equipment-list .list-group-item.active { background-color: var(--color-primary-light); color: var(--color-primary-text); font-weight: 600; border-color: var(--color-primary); }
        #unlinked-equipment-list-preview .list-group-item.active, #linked-equipment-list-preview .list-group-item.active { background-color: var(--color-warning-light); color: var(--color-warning-text); font-weight: 600; border-color: var(--color-warning); }
        .canvas-container { border: 1px solid var(--color-border); }
        .modal-step { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border-light); }
        .modal-step:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .modal-step-title { font-weight: 600; font-size: 1rem; color: var(--color-primary); margin-bottom: 1rem; }
        .inspection-tabs-container { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--color-border); padding-bottom: 1rem; }
        .inspection-tab { padding: 0.625rem 1.25rem; border: 1px solid var(--color-border); border-bottom: none; border-radius: var(--radius-md) var(--radius-md) 0 0; cursor: pointer; background-color: var(--color-bg); color: var(--color-text-secondary); font-weight: 500; transition: all 0.2s; }
        .inspection-tab:hover { background-color: var(--color-primary-light); }
        .inspection-tab.active { background-color: var(--color-surface); color: var(--color-primary); border-color: var(--color-border) var(--color-border) var(--color-surface) var(--color-border); margin-bottom: -2px; font-weight: 600; }
        .readonly-value { font-weight: 600; padding: 0.625rem 0.875rem; }
        .readonly-notes { white-space: pre-wrap; word-break: break-all; padding: 1rem; background: var(--color-bg); border-radius: var(--radius-md); min-height: 80px;}
        .news-item { padding: 1.5rem; border: 1px solid var(--color-border-light); border-radius: var(--radius-md); margin-bottom: 1rem; background-color: var(--color-bg); }
        .news-item h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .news-item .news-date { font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 1rem; }
        .news-item p { white-space: pre-wrap; }
        .dataset-wrapper { margin-bottom: 2rem; border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: 1.5rem; }
        .dataset-wrapper:last-child { margin-bottom: 0; }
        .dataset-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--color-border-light);}
        #floor-plan-wrapper, #result-floor-plan-wrapper, #result-detail-modal-floor-plan-wrapper, #preview-floor-plan-wrapper {
            position: relative;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        #floor-plan-display-container, #result-floor-plan-container, #preview-floor-plan-container {
            height: 60vh;
            min-height: 50px;
            max-height: 60vh;
            overflow: hidden; 
            position: relative;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border-light);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            resize: vertical;
        }
        #floor-plan-display-container canvas, #result-floor-plan-container canvas, #preview-floor-plan-container canvas {
            max-width: 100%;
            max-height: 100%;
        }
        #floor-plan-display-container p, #result-floor-plan-container p, #preview-floor-plan-container p {
            text-align: center;
            color: var(--color-text-secondary);
            padding: 2rem;
        }
        #resize-handle {
            width: 100%;
            height: 10px;
            background-color: var(--color-border);
            cursor: ns-resize;
            border-radius: 5px;
            transition: background-color 0.2s;
            margin-top: 4px;
        }
        #resize-handle:hover {
            background-color: var(--color-primary);
        }
        #floor-plan-wrapper.hidden, #result-floor-plan-wrapper.hidden, #result-detail-modal-floor-plan-wrapper.hidden, #preview-floor-plan-wrapper.hidden { display: none; }
        .selection-info-panel {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            background-color: var(--color-bg);
        }
        .selection-info-panel h5 {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .selection-info-panel p {
            line-height: 1.5;
            margin: 0;
            color: var(--color-text-secondary);
        }
        .selection-info-panel.shape-info { border-left: 4px solid var(--color-warning); }
        .selection-info-panel.equipment-info { border-left: 4px solid var(--color-success); }
        .selection-info-panel strong { color: var(--color-text-primary); font-weight: 500; }
        .custom-datalist-container { position: relative; width: 100%; }
        .custom-datalist-options {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1050;
        }
        .custom-datalist-options.visible { display: block; }
        .custom-datalist-option {
            padding: 0.625rem 0.875rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .custom-datalist-option:hover { background-color: var(--color-primary-light); color: var(--color-primary-text); }
        .custom-datalist-option.no-results { color: var(--color-text-secondary); cursor: default; }
        .custom-datalist-option:not(.no-results):hover { background-color: var(--color-primary-light); }
        #modal-item-set-list-container .list-group-item {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--color-border-light);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #modal-item-set-list-container .list-group-item:last-child { border-bottom: none; }
        #modal-item-set-list-container .list-group-item:hover { background-color: var(--color-bg); }
        #modal-item-set-list-container .list-group-item label { display: flex; align-items: center; width: 100%; cursor: pointer; }
        #modal-item-set-list-container .list-group-item input[type="radio"] { margin-right: 1rem; }
        #modal-item-set-list-container .list-group-item .item-set-info { display: flex; flex-direction: column; }
        #modal-item-set-list-container .list-group-item .item-set-info small { color: var(--color-text-secondary); }

        @media (max-width: 992px) { .modal-columns { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { transform: translateX(-260px); } .sidebar.mobile-visible { transform: translateX(0); } .main-content { margin-left: 0; } .form-row, .modal-filters { grid-template-columns: 1fr; flex-direction: column; gap: 1rem; } .search-input { width: 100%; } .content { padding: 1rem; } .header { padding: 1rem; flex-wrap: wrap; } }
    </style>
</head>
<body>
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">設備点検管理</h2>
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <ul class="nav-menu">
                <h2 class="sidebar-title">メインシステム機能</h2>
                <li class="nav-item"><a class="nav-link active" onclick="showPage('top-page')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg><span>トップページ</span></a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('news-management')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg><span>お知らせ管理</span></a></li>
                <hr style="border-color: #1f2937; margin: 0.5rem 1.5rem;">
                <li class="nav-item"><a class="nav-link" onclick="showPage('organization-management')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.282A2.25 2.25 0 0113.125 12h1.75a2.25 2.25 0 012.25 2.25v-2.25a2.25 2.25 0 012.25-2.25h1.5a2.25 2.25 0 012.25 2.25v.75M6.375 17.25a2.25 2.25 0 012.25-2.25h1.5a2.25 2.25 0 012.25 2.25v-2.25a2.25 2.25 0 012.25-2.25h1.5a2.25 2.25 0 012.25 2.25v-2.25a2.25 2.25 0 012.25-2.25h1.5a2.25 2.25 0 012.25 2.25v.75m-12 5.25v-2.25a2.25 2.25 0 012.25-2.25h1.5a2.25 2.25 0 012.25 2.25v2.25" /></svg><span>組織管理</span></a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('building-management')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M9 21v-3.375c0-.621.504-1.125 1.125-1.125h2.75c.621 0 1.125.504 1.125 1.125V21" /></svg><span>建物管理</span></a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('equipment-list')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.03 1.125 0 1.131.094 1.976 1.057 1.976 2.192V7.5M12 18.75m-2.625 0a2.625 2.625 0 105.25 0 2.625 2.625 0 10-5.25 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a8.25 8.25 0 005.284-14.253 8.25 8.25 0 00-10.568 0A8.25 8.25 0 0012 21z" /></svg><span>設備管理</span></a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('item-set-management')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z" /></svg><span>点検表管理</span></a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('inspection-templates')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><span>データセット管理</span></a></li>
                <li class="nav-item"><a class="nav-link" onclick="showPage('work-results-management')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>点検作業・結果管理</span></a></li>
                <hr style="border-color: #1f2937; margin: 0.5rem 1.5rem;">
                <h2 class="sidebar-title">点検アプリ機能</h2>
                <li class="nav-item nav-item-group-b"><a class="nav-link" onclick="showPage('top-page-app')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" /></svg><span>トップページ</span></a></li>
                <li class="nav-item nav-item-group-b"><a class="nav-link" onclick="showPage('dataset-reference')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.5h1.844A2.25 2.25 0 0018 18V6.75a2.25 2.25 0 00-2.25-2.25H15M9 12l3 3m0 0l3-3m-3 3v-6m-1.5-1.5H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><span>データセット参照</span></a></li>
                <li class="nav-item nav-item-group-b"><a class="nav-link" onclick="showPage('work-order-management')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75h16.5m-16.5 4.5h16.5m-16.5 4.5h16.5m-16.5-13.5h16.5" /></svg><span>点検作業管理</span></a></li>
                <li class="nav-item nav-item-group-b"><a class="nav-link" onclick="showPage('work-order-selection')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg><span>点検作業実施</span></a></li>
            </ul>
        </nav>

        <main class="main-content" id="mainContent">
            <header class="header">
                <button class="menu-toggle-main" onclick="toggleSidebar()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
                </button>
                <h1 id="pageTitle">トップページ</h1>
                <div id="page-controls-wrapper">
                    <div id="header-filters-mount"></div>
                    <div id="header-actions-mount"></div>
                </div>
            </header>
            <div class="content">
                <div id="top-page" class="page active">
                     <div class="card">
                        <div class="card-header"><h2 class="card-title">お知らせ</h2></div>
                        <div id="news-display-container" style="margin-top: 1rem;"></div>
                    </div>
                </div>
                <div id="top-page-app" class="page">
                    <div class="card">
                       <div class="card-header"><h2 class="card-title">お知らせ</h2></div>
                       <div id="news-display-container-app" style="margin-top: 1rem;"></div>
                   </div>
               </div>

                <div id="news-management" class="page">
                    <div class="card">
                       <div class="header-filters"></div>
                       <div class="header-actions">
                           <button class="btn btn-primary" onclick="openNewsModal()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>新規お知らせ追加</button>
                       </div>
                       <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('news', 'date')">日付</th><th class="sortable" onclick="handleSort('news', 'title')">タイトル</th><th>内容</th><th>操作</th></tr></thead><tbody id="newsTableBody"></tbody></table></div>
                       <div class="pagination-container" id="pagination-bottom-news"></div>
                   </div>
                </div>

                <div id="equipment-list" class="page">
                     <div class="card">
                        <div id="equipment-filters" class="header-filters">
                            <input type="text" id="equipmentSearchName" class="form-input search-input" placeholder="設備名..." oninput="renderEquipmentTable()">
                            <div class="custom-datalist-container">
                                <input class="form-input" id="equipmentSearchGroup" placeholder="区分..." oninput="filterCustomDatalist(this); renderEquipmentTable();" onfocus="showCustomDatalist(this, 'equipmentSearchGroup')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <div class="custom-datalist-container">
                                <input class="form-input" id="equipmentSearchType" placeholder="種別..." oninput="filterCustomDatalist(this); renderEquipmentTable();" onfocus="showCustomDatalist(this, 'equipmentSearchType')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <div class="custom-datalist-container">
                                 <input class="form-input" id="equipmentSearchBuilding" placeholder="建物..." oninput="filterCustomDatalist(this); renderEquipmentTable();" onfocus="showCustomDatalist(this, 'equipmentSearchBuilding')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="clearFilters('equipment')">クリア</button>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="openEquipmentModal()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>新規設備追加</button>
                        </div>
                        <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('equipment', 'name')">設備名</th><th class="sortable" onclick="handleSort('equipment', 'quantity')">個数</th><th class="sortable" onclick="handleSort('equipment', 'group')">区分</th><th class="sortable" onclick="handleSort('equipment', 'type')">種別</th><th class="sortable" onclick="handleSort('equipment', 'locationName')">拠点</th><th class="sortable" onclick="handleSort('equipment', 'buildingName')">建物</th><th class="sortable" onclick="handleSort('equipment', 'floorName')">フロア</th><th class="sortable" onclick="handleSort('equipment', 'lastInspectionDate')">最新点検日</th><th>点検履歴</th><th>操作</th></tr></thead><tbody id="equipmentTableBody"></tbody></table></div>
                        <div class="pagination-container" id="pagination-bottom-equipment"></div>
                    </div>
                </div>
                <div id="building-management" class="page">
                    <div class="card">
                        <div id="building-filters" class="header-filters">
                            <input type="text" id="buildingSearchName" class="form-input search-input" placeholder="建物名..." oninput="renderBuildingTable()">
                            <div class="custom-datalist-container">
                                 <input class="form-input" id="buildingSearchLocation" placeholder="管理拠点..." oninput="filterCustomDatalist(this); renderBuildingTable();" onfocus="showCustomDatalist(this, 'buildingSearchLocation')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="clearFilters('building')">クリア</button>
                       </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="openBuildingModal()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>新規建物追加</button>
                        </div>
                        <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('buildings', 'name')">建物名</th><th class="sortable" onclick="handleSort('buildings', 'address')">住所</th><th>フロア</th><th>平面図</th><th>フロア設備</th><th class="sortable" onclick="handleSort('buildings', 'locationName')">管理拠点</th><th>操作</th></tr></thead><tbody id="buildingTableBody"></tbody></table></div>
                        <div class="pagination-container" id="pagination-bottom-buildings"></div>
                    </div>
                </div>
                <div id="organization-management" class="page">
                    <div class="card">
                        <div id="organization-filters" class="header-filters">
                            <input type="text" id="orgSearchCompany" class="form-input search-input" placeholder="会社名..." oninput="renderOrganizationTable()">
                            <div class="custom-datalist-container">
                                 <input class="form-input" id="orgSearchLocation" placeholder="拠点..." oninput="filterCustomDatalist(this); renderOrganizationTable();" onfocus="showCustomDatalist(this, 'orgSearchLocation')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <div class="custom-datalist-container">
                                 <input class="form-input" id="orgSearchDepartment" placeholder="部署..." oninput="filterCustomDatalist(this); renderOrganizationTable();" onfocus="showCustomDatalist(this, 'orgSearchDepartment')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <button class="btn btn-secondary btn-sm" onclick="clearFilters('organization')">クリア</button>
                       </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="openOrganizationModal()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>新規組織追加</button>
                        </div>
                        <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('organizations', 'company')">会社</th><th class="sortable" onclick="handleSort('organizations', 'location')">拠点</th><th class="sortable" onclick="handleSort('organizations', 'department')">部署</th><th class="sortable" onclick="handleSort('organizations', 'manager')">担当組織</th><th>操作</th></tr></thead><tbody id="organizationTableBody"></tbody></table></div>
                        <div class="pagination-container" id="pagination-bottom-organizations"></div>
                    </div>
                </div>
                <div id="item-set-management" class="page">
                    <div class="card">
                        <div id="itemset-filters" class="header-filters">
                            <div class="custom-datalist-container">
                                <input type="text" id="itemSetSearchGroup" class="form-input" placeholder="区分..." oninput="filterCustomDatalist(this); renderItemSetTable();" onfocus="showCustomDatalist(this, 'itemSetSearchGroup')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <div class="custom-datalist-container">
                                <input type="text" id="itemSetSearchType" class="form-input" placeholder="種別..." oninput="filterCustomDatalist(this); renderItemSetTable();" onfocus="showCustomDatalist(this, 'itemSetSearchType')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <select id="itemSetSearchStandard" class="form-select form-input" onchange="renderItemSetTable()">
                                <option value="">標準 (すべて)</option>
                                <option value="true">○ のみ</option>
                                <option value="false">― のみ</option>
                            </select>
                            <input type="text" id="itemSetSearchInput" class="form-input search-input" placeholder="点検表名..." oninput="renderItemSetTable()">
                            <button class="btn btn-secondary btn-sm" onclick="clearFilters('itemset')">クリア</button>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="openItemSetModal()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>新規点検表追加</button>
                        </div>
                        <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('itemSets', 'name')">点検表名</th><th class="sortable" onclick="handleSort('itemSets', 'group')">区分</th><th class="sortable" onclick="handleSort('itemSets', 'type')">種別</th><th class="sortable" onclick="handleSort('itemSets', 'isStandard')">標準</th><th class="sortable" onclick="handleSort('itemSets', 'itemCount')">項目数</th><th>操作</th></tr></thead><tbody id="itemSetTableBody"></tbody></table></div>
                        <div class="pagination-container" id="pagination-bottom-itemSets"></div>
                    </div>
                </div>
                <div id="inspection-templates" class="page">
                    <div class="card">
                        <div id="template-filters" class="header-filters">
                            <div class="custom-datalist-container">
                                <input type="text" id="templateSearchLocation" class="form-input" placeholder="拠点で検索..." oninput="filterCustomDatalist(this); renderTemplateTable();" onfocus="showCustomDatalist(this, 'templateSearchLocation')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <div class="custom-datalist-container">
                                <input type="text" id="templateSearchBuilding" class="form-input" placeholder="建物で検索..." oninput="filterCustomDatalist(this); renderTemplateTable();" onfocus="showCustomDatalist(this, 'templateSearchBuilding')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <input type="text" id="templateSearchInput" class="form-input search-input" placeholder="データセット名..." oninput="renderTemplateTable()">
                            <button class="btn btn-secondary btn-sm" onclick="clearFilters('template')">クリア</button>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="openTemplateModal()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>新規データセット作成</button>
                        </div>
                        <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('templates', 'name')">データセット名</th><th class="sortable" onclick="handleSort('templates', 'locationName')">拠点</th><th class="sortable" onclick="handleSort('templates', 'buildingName')">建物</th><th class="sortable" onclick="handleSort('templates', 'itemSetName')">点検表</th><th class="sortable" onclick="handleSort('templates', 'equipmentCount')">対象設備数</th><th>操作</th></tr></thead><tbody id="templateTableBody"></tbody></table></div>
                        <div class="pagination-container" id="pagination-bottom-templates"></div>
                    </div>
                </div>

                <div id="work-order-management" class="page">
                    <div class="card">
                         <div id="workorder-filters" class="header-filters">
                            <div class="custom-datalist-container">
                                <input type="text" id="workOrderSearchLocation" class="form-input" placeholder="拠点で検索..." oninput="filterCustomDatalist(this); renderWorkOrderTable();" onfocus="showCustomDatalist(this, 'workOrderSearchLocation')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <div class="custom-datalist-container">
                                <input type="text" id="workOrderSearchBuilding" class="form-input" placeholder="建物で検索..." oninput="filterCustomDatalist(this); renderWorkOrderTable();" onfocus="showCustomDatalist(this, 'workOrderSearchBuilding')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <input type="text" id="workOrderSearchInput" class="form-input search-input" placeholder="点検作業名..." oninput="renderWorkOrderTable()">
                            <button class="btn btn-secondary btn-sm" onclick="clearFilters('workorder')">クリア</button>
                        </div>
                         <div class="header-actions">
                            <button class="btn btn-primary" onclick="openWorkOrderModal()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>新規点検作業作成</button>
                        </div>
                        <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('workOrders', 'name')">点検作業名</th><th class="sortable" onclick="handleSort('workOrders', 'locationName')">拠点</th><th class="sortable" onclick="handleSort('workOrders', 'buildingName')">建物</th><th class="sortable" onclick="handleSort('workOrders', 'templateCount')">データセット数</th><th class="sortable" onclick="handleSort('workOrders', 'creationDate')">作成日</th><th class="sortable" onclick="handleSort('workOrders', 'latestExecutionDate')">最新実施日</th><th>操作</th></tr></thead><tbody id="workOrderTableBody"></tbody></table></div>
                        <div class="pagination-container" id="pagination-bottom-workOrders"></div>
                    </div>
                </div>

                <div id="work-order-selection" class="page">
                    <div class="card">
                        <div id="workorder-selection-filters" class="header-filters">
                            <div class="custom-datalist-container">
                                <input type="text" id="workOrderSelectionSearchLocation" class="form-input" placeholder="拠点で検索..." oninput="filterCustomDatalist(this); renderWorkOrderSelectionList();" onfocus="showCustomDatalist(this, 'workOrderSelectionSearchLocation')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <div class="custom-datalist-container">
                                <input type="text" id="workOrderSelectionSearchBuilding" class="form-input" placeholder="建物で検索..." oninput="filterCustomDatalist(this); renderWorkOrderSelectionList();" onfocus="showCustomDatalist(this, 'workOrderSelectionSearchBuilding')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <input type="text" id="workOrderSelectionSearchInput" class="form-input search-input" placeholder="点検作業名..." oninput="renderWorkOrderSelectionList()">
                            <button class="btn btn-secondary btn-sm" onclick="clearFilters('workorder-selection')">クリア</button>
                        </div>
                        <div class="table-container" id="workOrderSelectionContainer"></div>
                        <div class="pagination-container" id="pagination-bottom-workOrderSelection"></div>
                    </div>
                </div>

                <div id="work-results-management" class="page">
                    <div class="card">
                        <div class="header-filters">
                            <input type="text" id="resultSearchInput" class="form-input search-input" placeholder="点検作業名で検索..." oninput="renderWorkResultsTable()">
                        </div>
                        <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('results', 'workOrderName')">点検作業名</th><th class="sortable" onclick="handleSort('results', 'locationName')">拠点</th><th class="sortable" onclick="handleSort('results', 'buildingName')">建物</th><th class="sortable" onclick="handleSort('results', 'creationDate')">作成日</th><th class="sortable" onclick="handleSort('results', 'executionDate')">実施日</th><th class="sortable" onclick="handleSort('results', 'status')">ステータス</th><th>操作</th></tr></thead><tbody id="resultsTableBody"></tbody></table></div>
                        <div class="pagination-container" id="pagination-bottom-results"></div>
                    </div>
                </div>
                
                <div id="dataset-reference" class="page">
                     <div class="card">
                        <div id="dataset-reference-filters" class="header-filters">
                            <div class="custom-datalist-container">
                                <input type="text" id="datasetRefSearchLocation" class="form-input" placeholder="拠点で検索..." oninput="filterCustomDatalist(this); renderDatasetReferenceTable();" onfocus="showCustomDatalist(this, 'datasetRefSearchLocation')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <div class="custom-datalist-container">
                                <input type="text" id="datasetRefSearchBuilding" class="form-input" placeholder="建物で検索..." oninput="filterCustomDatalist(this); renderDatasetReferenceTable();" onfocus="showCustomDatalist(this, 'datasetRefSearchBuilding')" autocomplete="off">
                                <div class="custom-datalist-options"></div>
                            </div>
                            <input type="text" id="datasetRefSearchInput" class="form-input search-input" placeholder="データセット名..." oninput="renderDatasetReferenceTable()">
                            <button class="btn btn-secondary btn-sm" onclick="clearFilters('datasetRef')">クリア</button>
                        </div>
                        <div class="table-container"><table class="table"><thead><tr><th class="sortable" onclick="handleSort('datasetRef', 'name')">データセット名</th><th class="sortable" onclick="handleSort('datasetRef', 'locationName')">拠点</th><th class="sortable" onclick="handleSort('datasetRef', 'buildingName')">建物</th><th class="sortable" onclick="handleSort('datasetRef', 'itemSetName')">点検表</th><th class="sortable" onclick="handleSort('datasetRef', 'equipmentCount')">対象設備数</th><th>操作</th></tr></thead><tbody id="datasetRefTableBody"></tbody></table></div>
                        <div class="pagination-container" id="pagination-bottom-datasetRef"></div>
                    </div>
                </div>

                <div id="inspection-execution" class="page">
                    <div class="card">
                        <div class="header-actions">
                            <button class="btn btn-secondary" onclick="showPage('work-order-selection')">一覧に戻る</button>
                            <button class="btn btn-success" onclick="saveWorkOrderInspection()">保存</button>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; gap: 1rem; border-bottom: 1px solid var(--color-border); margin-bottom: 1rem; flex-wrap: wrap;">
                            <div id="inspection-floor-tabs-container" class="inspection-tabs-container" style="padding-bottom: 0; margin-bottom: -1px; border-bottom: none; flex-grow: 1;"></div>
                            <button id="toggleFloorPlanBtn" class="btn btn-sm btn-secondary" style="display: none; margin-bottom: 1rem;">平面図を非表示</button>
                        </div>
                
                        <div id="floor-plan-wrapper" class="hidden">
                            <div id="floor-plan-display-container">
                                <canvas id="inspectionExecutionCanvas"></canvas>
                            </div>
                            <div id="resize-handle"></div>
                        </div>

                        <div id="inspection-tabs" class="inspection-tabs-container"></div>
                        <div class="card-content-wrapper" id="inspection-content-wrapper" style="max-height: 55vh; overflow-y: auto;"></div>
                    </div>
                </div>

                <div id="work-order-preview-detail" class="page">
                    <div class="card">
                        <div class="header-actions">
                            <button class="btn btn-secondary" onclick="showPage('work-order-management')">一覧に戻る</button>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; gap: 1rem; border-bottom: 1px solid var(--color-border); margin-bottom: 1rem; flex-wrap: wrap;">
                            <div id="preview-floor-tabs-container" class="inspection-tabs-container" style="padding-bottom: 0; margin-bottom: -1px; border-bottom: none; flex-grow: 1;"></div>
                            <button id="togglePreviewFloorPlanBtn" class="btn btn-sm btn-secondary" style="display: none; margin-bottom: 1rem;">平面図を非表示</button>
                        </div>
                
                        <div id="preview-floor-plan-wrapper" class="hidden">
                            <div id="preview-floor-plan-container">
                                <canvas id="previewExecutionCanvas"></canvas>
                            </div>
                        </div>

                        <div id="preview-tabs" class="inspection-tabs-container"></div>
                        <div class="card-content-wrapper" id="preview-content-wrapper" style="max-height: 55vh; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <div id="result-detail-view" class="page">
                    <div class="card">
                         <div id="resultDetailActions" class="header-actions">
                            <button class="btn btn-secondary" onclick="showPage('work-results-management')">一覧に戻る</button>
                            <button id="editResultBtn" class="btn btn-primary" style="display: none;">結果を編集</button>
                            <button id="confirmResultBtn" class="btn btn-success" style="display: none;">結果を確定</button>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; gap: 1rem; border-bottom: 1px solid var(--color-border); margin-bottom: 1rem; flex-wrap: wrap;">
                            <div id="result-detail-floor-tabs-container" class="inspection-tabs-container" style="padding-bottom: 0; margin-bottom: -1px; border-bottom: none; flex-grow: 1;"></div>
                            <button id="toggleResultFloorPlanBtn" class="btn btn-sm btn-secondary" style="display: none; margin-bottom: 1rem;">平面図を非表示</button>
                        </div>
                
                        <div id="result-floor-plan-wrapper" class="hidden">
                            <div id="result-floor-plan-container">
                                <canvas id="resultDetailCanvas"></canvas>
                            </div>
                        </div>
                        <div id="result-detail-tabs" class="inspection-tabs-container"></div>
                         <div class="card-content-wrapper">
                            <div id="result-common-items-container"></div>
                            <div class="table-container" style="max-height: 60vh;">
                                <table class="table inspection-grid-table" id="resultGridTable"></table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="newsModal" class="modal"><div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="modal-title" id="newsModalTitle">お知らせ作成</h3><span class="close" onclick="closeAllModals()">×</span></div><form id="newsForm"><input type="hidden" id="newsId"><div class="form-group"><label for="newsDate" class="form-label">日付</label><input type="date" class="form-input" id="newsDate" required></div><div class="form-group"><label for="newsTitle" class="form-label">タイトル</label><input type="text" class="form-input" id="newsTitle" required></div><div class="form-group"><label for="newsContent" class="form-label">内容</label><textarea id="newsContent" class="form-textarea" rows="8" required></textarea></div><div class="form-group" style="text-align: right;"><button type="submit" class="btn btn-primary">保存</button></div></form></div></div>
    <div id="equipmentModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">設備情報</h3><span class="close" onclick="closeAllModals()">×</span></div><form id="equipmentForm"><input type="hidden" id="equipmentId"><div class="form-row"><div class="form-group" style="grid-column: 1 / -1;"><label class="form-label">設備名</label><input type="text" class="form-input" id="equipmentName" required></div></div><div class="form-row"><div class="form-group"><label class="form-label">個数</label><input type="number" class="form-input" id="equipmentQuantity" value="1" min="0" required></div></div>
        <div class="form-group"><label class="form-label">設備分類</label><div class="form-row">
            <div class="custom-datalist-container"><label class="form-label" style="font-size:0.8rem;">区分</label><input type="text" id="equipmentGroup" class="form-input" placeholder="検索または選択..." oninput="filterCustomDatalist(this); document.getElementById('equipmentType').value = '';" onfocus="showCustomDatalist(this, 'equipmentGroup')" autocomplete="off" required><div class="custom-datalist-options"></div></div>
            <div class="custom-datalist-container"><label class="form-label" style="font-size:0.8rem;">種別</label><input type="text" id="equipmentType" class="form-input" placeholder="検索または選択..." oninput="filterCustomDatalist(this)" onfocus="showCustomDatalist(this, 'equipmentType')" autocomplete="off" required><div class="custom-datalist-options"></div></div>
        </div><div style="margin-top: 1rem;"><button type="button" class="btn btn-secondary btn-sm" onclick="openEquipmentTypeModal()">設備分類を追加</button></div></div>
        <div class="form-group"><label class="form-label">設置場所詳細</label><input type="text" class="form-input" id="equipmentLocation" required></div>
        <div class="form-group"><label class="form-label">建物</label><div class="input-with-button custom-datalist-container"><input type="text" id="equipmentBuildingSearch" class="form-input" placeholder="検索または選択..." oninput="filterCustomDatalist(this, 'equipmentBuildingSearch'); handleBuildingSearchChange(this.value);" onfocus="showCustomDatalist(this, 'equipmentBuildingSearch')" autocomplete="off" required><div class="custom-datalist-options"></div></div></div>
        <div class="form-group"><label class="form-label">フロア</label><select id="equipmentFloor" class="form-select"><option value="">建物にのみ紐づけ (フロアなし)</option></select></div>
        <div class="form-group" style="text-align: right;"><button type="submit" class="btn btn-primary">保存</button></div></form></div></div>
    <div id="equipmentTypeModal" class="modal"><div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="modal-title">設備分類を追加</h3><span class="close" onclick="closeAllModals()">×</span></div><form id="equipmentTypeForm"><div class="form-group custom-datalist-container"><label class="form-label">区分</label><input type="text" id="newGroup" class="form-input" placeholder="既存の区分を選択または新規入力..." oninput="filterCustomDatalist(this)" onfocus="showCustomDatalist(this, 'newGroup')" autocomplete="off" required><div class="custom-datalist-options"></div></div><div class="form-group"><label class="form-label">種別</label><input type="text" id="newType" class="form-input" placeholder="新規入力..." required></div><div class="form-group" style="text-align: right;"><button type="submit" class="btn btn-primary">この分類を登録</button></div></form></div></div>
    <div id="itemSetModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">点検表</h3><span class="close" onclick="closeAllModals()">×</span></div><form id="itemSetForm"><input type="hidden" id="itemSetId"><div class="form-group"><label class="form-label">対象の設備種別</label><div class="form-row"><div class="form-group"><label class="form-label">区分</label><select id="itemSetGroup" class="form-select" onchange="updateItemSetTypeSelect()" required></select></div><div class="form-group"><label class="form-label">種別</label><select id="itemSetType" class="form-select" required></select></div></div></div><div class="form-group"><label class="form-label">点検表名</label><input type="text" id="itemSetName" class="form-input" required></div>
        <div class="form-group">
            <label style="display: flex; align-items: center; cursor:pointer;">
                <input type="checkbox" id="itemSetIsStandard" style="margin-right: 0.5rem; width: 1.25em; height: 1.25em;">
                標準点検表として設定
            </label>
        </div>
        <div class="form-group"><label class="form-label">点検項目</label><div id="item-set-items-container"></div><button type="button" class="btn btn-sm btn-secondary" style="margin-top:1rem;" onclick="addDynamicItemToSet()">項目を追加</button></div><div class="form-group" style="text-align: right;"><button type="submit" class="btn btn-primary">保存</button></div></form></div></div>
    <div id="buildingModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">建物情報</h3><span class="close" onclick="closeAllModals()">×</span></div><form id="buildingForm"><input type="hidden" id="buildingId"><div class="form-group"><label class="form-label">建物名</label><input type="text" id="buildingName" class="form-input" required></div><div class="form-group"><label class="form-label">住所</label><input type="text" id="buildingAddress" class="form-input"></div><div class="form-group"><label class="form-label">管理拠点</label><select id="buildingLocation" class="form-select" required></select></div><hr style="margin: 2rem 0; border-color: var(--color-border-light);"><div class="form-group"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"><label class="form-label" style="margin-bottom: 0;">フロア</label><button type="button" class="btn btn-sm btn-secondary" onclick="addFloorToBuildingModal()">フロアを追加</button></div><div id="buildingFloorsContainer"></div></div><div class="form-group" style="text-align: right; margin-top: 2rem;"><button type="submit" class="btn btn-primary">保存</button></div></form></div></div>
    <div id="organizationModal" class="modal"><div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="modal-title">組織情報</h3><span class="close" onclick="closeAllModals()">×</span></div><form id="organizationForm"><input type="hidden" id="organizationId"><div class="form-group"><label class="form-label">会社</label><input type="text" id="organizationCompany" class="form-input" required></div><div class="form-group"><label class="form-label">拠点</label><input type="text" id="organizationLocation" class="form-input"></div><div class="form-group"><label class="form-label">部署</label><input type="text" id="organizationDepartment" class="form-input"></div><div class="form-group"><label class="form-label">担当組織</label><input type="text" id="organizationManager" class="form-input"></div><div class="form-group" style="text-align: right;"><button type="submit" class="btn btn-primary">保存</button></div></form></div></div>
    <div id="templateModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">データセット作成</h3><span class="close" onclick="closeAllModals()">×</span></div><form id="templateForm"><input type="hidden" id="templateId">
        <div class="modal-step">
            <h3 class="modal-step-title">1. 対象の建物と設備種別を選択</h3>
            <div class="form-row">
                <div class="form-group custom-datalist-container"><label class="form-label">拠点</label><input type="text" id="modalTemplateLocationFilter" class="form-input" placeholder="拠点名で検索..." oninput="filterCustomDatalist(this); updateBuildingFilter('template');" onfocus="showCustomDatalist(this, 'modalTemplateLocationFilter')" autocomplete="off"><div class="custom-datalist-options"></div></div>
                <div class="form-group custom-datalist-container"><label class="form-label">建物</label><input type="text" id="modalTemplateBuildingFilter" class="form-input" placeholder="建物名で検索..." oninput="filterCustomDatalist(this); handleTemplateModalFiltersChanged();" onfocus="showCustomDatalist(this, 'modalTemplateBuildingFilter')" autocomplete="off"><div class="custom-datalist-options"></div></div>
                <div class="form-group custom-datalist-container"><label class="form-label">設備区分</label><input type="text" id="modalTemplateGroupFilter" class="form-input" placeholder="区分名で検索..." oninput="filterCustomDatalist(this); updateTemplateTypeFilter(); handleTemplateModalFiltersChanged();" onfocus="showCustomDatalist(this, 'modalTemplateGroupFilter')" autocomplete="off"><div class="custom-datalist-options"></div></div>
                <div class="form-group custom-datalist-container"><label class="form-label">設備種別</label><input type="text" id="modalTemplateTypeFilter" class="form-input" placeholder="種別名で検索..." oninput="filterCustomDatalist(this); handleTemplateModalFiltersChanged();" onfocus="showCustomDatalist(this, 'modalTemplateTypeFilter')" autocomplete="off"><div class="custom-datalist-options"></div></div>
            </div>
        </div>
        <div class="modal-columns">
            <div class="modal-column">
                <div class="modal-step" style="border-bottom: none; padding-bottom: 0;">
                    <h3 class="modal-step-title">2. データセット情報と対象設備を登録</h3>
                    <div class="form-group"><label class="form-label">データセット名</label><input type="text" class="form-input" id="templateName" required></div>
                    <div class="form-group"><label class="form-label">対象設備を選択 (同じ種別の設備のみ選択可)</label>
                        <div class="modal-filters" style="margin-top:0.5rem;"><input type="text" class="form-input search-input" id="modalEquipmentSearch" onkeyup="renderEquipmentCheckboxesTable()" placeholder="設備名..."></div>
                        <div class="table-container" id="equipmentCheckboxesTableContainer" style="max-height: 30vh;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-column">
                 <div class="modal-step" style="border-bottom: none; padding-bottom: 0;">
                    <h3 class="modal-step-title">3. 点検表を選択</h3>
                     <div class="form-group">
                        <input type="text" id="modalItemSetSearch" class="form-input" placeholder="点検表名で検索..." oninput="renderItemSetListForTemplateModal()">
                    </div>
                    <div id="modal-item-set-list-container" style="max-height: 38vh; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                    </div>
                </div>
            </div>
        </div>
        <div id="templatePreviewStep" class="modal-step" style="display: none; margin-top: 1.5rem;">
            <h3 class="modal-step-title">4. プレビュー</h3>
            <div id="templatePreviewContainer">
                <div id="templatePreviewCommonItems"></div>
                <div class="table-container" style="max-height: 40vh;">
                    <table class="table inspection-grid-table" id="templatePreviewGridTable"></table>
                </div>
            </div>
        </div>
        <div class="form-group" style="margin-top: 1.5rem; text-align: right;"><button type="submit" class="btn btn-primary">作成・保存</button></div>
    </form></div></div>
    <div id="workOrderModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">点検作業の作成</h3><span class="close" onclick="closeAllModals()">×</span></div><form id="workOrderForm"><input type="hidden" id="workOrderId">
        <div class="modal-step"><h3 class="modal-step-title">1. 対象の建物を選択</h3>
            <div class="form-row">
                <div class="form-group custom-datalist-container"><label class="form-label">拠点</label>
                    <input type="text" id="modalWorkOrderLocationFilter" class="form-input" placeholder="拠点を選択..." oninput="filterCustomDatalist(this); updateBuildingFilter('workOrder');" onfocus="showCustomDatalist(this, 'modalWorkOrderLocationFilter')" autocomplete="off">
                    <div class="custom-datalist-options"></div>
                </div>
                <div class="form-group custom-datalist-container"><label class="form-label">建物</label>
                    <input type="text" id="modalWorkOrderBuildingFilter" class="form-input" placeholder="建物を選択..." oninput="filterCustomDatalist(this); renderTemplateCheckboxesForWorkOrder();" onfocus="showCustomDatalist(this, 'modalWorkOrderBuildingFilter')" autocomplete="off">
                    <div class="custom-datalist-options"></div>
                </div>
            </div>
        </div>
        <div class="modal-step"><h3 class="modal-step-title">2. 点検作業情報と含めるデータセットを登録</h3><div class="form-group"><label class="form-label">点検作業名</label><input type="text" class="form-input" id="workOrderName" required></div><div class="form-group"><label class="form-label">含めるデータセットを選択</label><div class="modal-filters" style="margin-top:0.5rem;"><input type="text" class="form-input search-input" id="modalTemplateSearch" onkeyup="renderTemplateCheckboxesForWorkOrder()" placeholder="データセット名..."></div><div class="table-container" id="templateCheckboxesContainer" style="max-height: 45vh;"></div></div></div>
        <div id="workOrderPreviewStep" class="modal-step" style="display: none;"><h3 class="modal-step-title">3. プレビュー</h3><div id="workOrderPreviewContainer" style="max-height: 50vh; overflow-y: auto;"></div></div>
        <div class="form-group" style="margin-top: 1.5rem; text-align: right;"><button type="submit" class="btn btn-primary">作成・保存</button></div></form></div></div>
    <div id="remarksModal" class="modal"><div class="modal-content" style="max-width: 600px;"><div class="modal-header"><h3 class="modal-title">備考編集</h3><span class="close" onclick="closeAllModals()">×</span></div><input type="hidden" id="remarksEquipmentId"><input type="hidden" id="remarksTemplateId"><div class="form-group"><textarea id="remarksTextarea" class="form-textarea" rows="10"></textarea></div><div class="form-group" style="text-align: right;"><button class="btn btn-primary" onclick="saveRemarks()">保存</button></div></div></div>
    <div id="photoModal" class="modal" onclick="closePhotoModal()"><div class="modal-content"><img id="photoModalImage" src=""></div></div>
    <div id="datasetReferencePreviewModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="datasetRefPreviewTitle">データセットプレビュー</h3><span class="close" onclick="closeAllModals()">×</span></div><div id="datasetRefPreviewCommonItems"></div><div class="table-container" style="max-height: 60vh;"><table class="table inspection-grid-table" id="datasetRefPreviewGridTable"></table></div></div></div>
    <div id="mappingModal" class="modal">
        <div class="modal-content" style="max-width: 95vw; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title" id="mappingModalTitle">平面図への設備紐づけ</h3>
                <span class="close" onclick="closeAllModals()">×</span>
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-shrink: 0;">
                <div id="mapping-toolbar" style="display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; padding: 0.5rem; background: var(--color-bg); border-radius: var(--radius-md);">
                    <div style="font-weight: 600; font-size: 0.875rem; margin-right: 0.5rem;">図形:</div>
                    <button class="btn btn-secondary btn-sm" onclick="addShapeToCanvas('rect')">四角</button>
                    <button class="btn btn-secondary btn-sm" onclick="addShapeToCanvas('circle')">円</button>
                    <button class="btn btn-secondary btn-sm" onclick="addShapeToCanvas('triangle')">三角</button>
                    <button class="btn btn-secondary btn-sm" onclick="addShapeToCanvas('rhombus')">ひし形</button>
                    <div style="border-left: 1px solid var(--color-border); height: 24px; margin: 0 0.5rem;"></div>
                    <div style="font-weight: 600; font-size: 0.875rem;">色:</div>
                    <input type="color" id="shapeColorPicker" value="#ef4444" onchange="changeSelectedShapeColor(this.value)" style="border-radius: 4px; border: 1px solid var(--color-border); cursor: pointer;">
                    <div style="border-left: 1px solid var(--color-border); height: 24px; margin: 0 0.5rem;"></div>
                    <button class="btn btn-primary btn-sm" onclick="linkEquipmentToShape()">選択項目を紐づけ</button>
                    <button class="btn btn-danger btn-sm" onclick="unlinkEquipmentFromShape()">紐づけ解除</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSelectedShape()">選択図形を削除</button>
                </div>
            </div>
            <div class="modal-columns" style="flex-grow: 1; min-height: 0; grid-template-columns: 1fr 2fr;">
                <div class="modal-column card" style="padding: 1rem; display: flex; flex-direction: column;">
                    <div id="selected-shape-info" class="selection-info-panel shape-info"></div>
                    <div id="selected-equipment-info" class="selection-info-panel equipment-info"></div>
                    <h4 style="margin-bottom: 1rem; flex-shrink: 0;">建物内の設備リスト</h4>
                    <div id="mapping-filters" class="modal-filters" style="flex-shrink: 0;">
                        <input type="text" id="mappingSearchName" class="form-input" placeholder="設備名で検索...">
                        <input type="text" id="mappingSearchCategory" class="form-input" placeholder="分類で検索...">
                    </div>
                    <div style="display: flex; gap: 1rem; flex-grow: 1; min-height: 0; margin-top: 1rem;">
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <h5 style="margin-bottom: 0.5rem; text-align: center; font-weight: 600; color: var(--color-text-secondary);">未紐付け</h5>
                            <div id="unlinked-equipment-list" style="overflow-y: auto; flex-grow: 1; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg);"></div>
                        </div>
                        <div style="flex: 1; display: flex; flex-direction: column;">
                            <h5 style="margin-bottom: 0.5rem; text-align: center; font-weight: 600; color: var(--color-text-secondary);">紐付け済み</h5>
                            <div id="linked-equipment-list" style="overflow-y: auto; flex-grow: 1; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg);"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-column" style="display: flex; justify-content: center; align-items: center; background: var(--color-bg); border-radius: var(--radius-lg); overflow: hidden;">
                    <canvas id="mappingCanvas"></canvas>
                </div>
            </div>
             <div class="form-group" style="text-align: right; margin-top: 1.5rem; flex-shrink: 0;">
                <button class="btn btn-secondary" onclick="closeAllModals()">キャンセル</button>
                <button class="btn btn-primary" onclick="saveMappingData()">保存して閉じる</button>
            </div>
        </div>
    </div>
    <div id="mappingPreviewModal" class="modal">
    <div class="modal-content" style="max-width: 95vw; height: 90vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h3 class="modal-title" id="mappingPreviewModalTitle">フロア設備参照</h3>
            <span class="close" onclick="closeAllModals()">×</span>
        </div>
        <div class="modal-columns" style="flex-grow: 1; min-height: 0; margin-top: 1rem; grid-template-columns: 1fr 2fr;">
            <div class="modal-column card" style="padding: 1rem; display: flex; flex-direction: column;">
                <div id="selected-shape-info-preview" class="selection-info-panel shape-info"></div>
                <div id="selected-equipment-info-preview" class="selection-info-panel equipment-info"></div>
                <h4 style="margin-bottom: 1rem; flex-shrink: 0;">建物内の設備リスト</h4>
                <div id="mapping-filters-preview" class="modal-filters" style="flex-shrink: 0;">
                    <input type="text" id="mappingSearchNamePreview" class="form-input" placeholder="設備名で検索...">
                    <input type="text" id="mappingSearchCategoryPreview" class="form-input" placeholder="分類で検索...">
                </div>
                <div style="display: flex; gap: 1rem; flex-grow: 1; min-height: 0; margin-top: 1rem;">
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <h5 style="margin-bottom: 0.5rem; text-align: center; font-weight: 600; color: var(--color-text-secondary);">未紐付け</h5>
                        <div id="unlinked-equipment-list-preview" style="overflow-y: auto; flex-grow: 1; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg);"></div>
                    </div>
                    <div style="flex: 1; display: flex; flex-direction: column;">
                        <h5 style="margin-bottom: 0.5rem; text-align: center; font-weight: 600; color: var(--color-text-secondary);">紐付け済み</h5>
                        <div id="linked-equipment-list-preview" style="overflow-y: auto; flex-grow: 1; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg);"></div>
                    </div>
                </div>
            </div>
            <div class="modal-column" style="display: flex; justify-content: center; align-items: center; background: var(--color-bg); border-radius: var(--radius-lg); overflow: hidden;">
                <canvas id="mappingPreviewCanvas"></canvas>
            </div>
        </div>
         <div class="form-group" style="text-align: right; margin-top: 1.5rem; flex-shrink: 0;">
            <button class="btn btn-secondary" onclick="closeAllModals()">閉じる</button>
        </div>
    </div>
</div>
    <div id="workOrderPreviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="workOrderPreviewTitle">点検作業プレビュー</h3>
                <span class="close" onclick="closeAllModals()">×</span>
            </div>
            <div id="workOrderPreviewModalContainer" style="max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="resultDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="resultDetailModalTitle">点検結果詳細</h3>
                <span class="close" onclick="closeAllModals()">×</span>
            </div>
             <div style="display: flex; justify-content: space-between; align-items: flex-end; gap: 1rem; border-bottom: 1px solid var(--color-border); margin-bottom: 1rem; flex-wrap: wrap;">
                <div id="result-detail-modal-floor-tabs-container" class="inspection-tabs-container" style="padding-bottom: 0; margin-bottom: -1px; border-bottom: none; flex-grow: 1;"></div>
                <button id="toggleResultDetailModalFloorPlanBtn" class="btn btn-sm btn-secondary" style="display: none; margin-bottom: 1rem;">平面図を非表示</button>
            </div>
            <div id="result-detail-modal-floor-plan-wrapper" class="hidden">
                <div id="result-floor-plan-container" style="height: 40vh;">
                    <canvas id="resultDetailModalCanvas"></canvas>
                </div>
            </div>
            <div id="result-detail-modal-tabs" class="inspection-tabs-container"></div>
            <div class="card-content-wrapper" style="max-height: calc(80vh - 250px); overflow-y: auto;">
                <div id="result-common-items-container-modal"></div>
                <div class="table-container">
                    <table class="table inspection-grid-table" id="resultGridTableModal"></table>
                </div>
            </div>
        </div>
    </div>

    <div id="inspectionHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="inspectionHistoryModalTitle">点検履歴</h3>
                <span class="close" onclick="closeAllModals()">×</span>
            </div>
            <div id="inspectionHistoryContent">
                <!-- Content will be generated by JS -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script>
        let data = { news: [], equipmentTypes: [], equipment: [], buildings: [], organizations: [], itemSets: [], templates: [], workOrders: [], workOrderResults: [] };
        let sortState = {};
        const ITEMS_PER_PAGE = 10;
        let currentPage = { news: 1, equipment: 1, buildings: 1, organizations: 1, itemSets: 1, templates: 1, workOrders: 1, workOrderSelection: 1, results: 1, datasetRef: 1 };
        let mappingCanvas, inspectionExecutionCanvas, resultDetailCanvas, resultDetailModalCanvas, previewExecutionCanvas;
        let resizeObserver;
        let activeBuildingId, activeFloorName;
        let currentWorkOrderExecution = null;
        let currentWorkOrderPreview = null;
        let currentResultDetailState = { resultId: null, floorName: 'all', templateId: null, highlightEquipmentId: null };
        let shapeIdCounter = 1;
        let selectedEquipmentId = null;
        let currentControls = { filters: null, actions: null, parent: null };

        // --- 初期化 & データ ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSampleData();
            renderAllTables();
            addEventListeners();
            showPage('top-page');
            
            document.addEventListener('click', (e) => {
                const openDatalist = document.querySelector('.custom-datalist-options.visible');
                if (openDatalist && !openDatalist.parentElement.contains(e.target)) {
                    openDatalist.classList.remove('visible');
                }
            });
        });

        function addEventListeners() {
            document.getElementById('newsForm').addEventListener('submit', handleNewsFormSubmit);
            setupFloorPlanResizer();
            document.getElementById('toggleFloorPlanBtn').addEventListener('click', toggleFloorPlanDisplay);
            document.getElementById('toggleResultFloorPlanBtn').addEventListener('click', () => {
                const wrapper = document.getElementById('result-floor-plan-wrapper');
                const btn = document.getElementById('toggleResultFloorPlanBtn');
                wrapper.classList.toggle('hidden');
                btn.textContent = wrapper.classList.contains('hidden') ? '平面図を表示' : '平面図を非表示';
            });
            document.getElementById('togglePreviewFloorPlanBtn').addEventListener('click', () => {
                const wrapper = document.getElementById('preview-floor-plan-wrapper');
                const btn = document.getElementById('togglePreviewFloorPlanBtn');
                wrapper.classList.toggle('hidden');
                btn.textContent = wrapper.classList.contains('hidden') ? '平面図を表示' : '平面図を非表示';
            });
        }

        function loadSampleData() {
            // Buildings
            data.buildings = [
                { id: 1, name: '渋谷ヒカリエ', address: '東京都渋谷区渋谷2-21-1', locationName: '東京', floors: [{ name: '10F', photos: ['https://placehold.co/1200x800/e2e8f0/64748b?text=10F%20Floor%20Plan'], mappings: [{type: "rect", left: 100, top: 150, scaleX: 1, scaleY: 1, angle: 0, fill: "#ef4444", equipmentId: 1, width: 80, height: 60}] }, { name: '25F', photos: [], mappings: [] }, { name: '屋上', photos: ['https://placehold.co/1200x800/e2e8f0/64748b?text=Rooftop%20Floor%20Plan'], mappings: [{type: "circle", left: 300, top: 200, scaleX: 1, scaleY: 1, angle: 0, fill: "#f59e0b", equipmentId: 2, radius: 40}] }] },
                { id: 2, name: '六本木ヒルズ森タワー', address: '東京都港区六本木6-10-1', locationName: '東京', floors: [{ name: 'B2F', photos: ['https://placehold.co/1200x800/e2e8f0/64748b?text=B2F%20Floor%20Plan'], mappings: [] }, { name: '49F', photos: [], mappings: [] }, { name: '50F', photos: [], mappings: [] }] },
                { id: 3, name: 'グランフロント大阪', address: '大阪府大阪市北区大深町4-20', locationName: '大阪', floors: [{ name: '5F', photos: [], mappings: [] }, { name: 'B2F', photos: [], mappings: [] }] },
                { id: 4, name: 'あべのハルカス', address: '大阪府大阪市阿倍野区阿倍野筋1-1-43', locationName: '大阪', floors: [{ name: '60F展望台', photos: [], mappings: [] }] },
                { id: 5, name: 'JR博多シティ', address: '福岡県福岡市博多区博多駅中央街1-1', locationName: '福岡', floors: [{ name: '屋上', photos: [], mappings: [] }] },
                { id: 6, name: '名古屋ミッドランドスクエア', address: '愛知県名古屋市中村区名駅4-7-1', locationName: '名古屋', floors: [] },
                { id: 7, name: '札幌JRタワー', address: '北海道札幌市中央区北5条西2丁目', locationName: '札幌', floors: [] },
                { id: 8, name: '横浜ランドマークタワー', address: '神奈川県横浜市西区みなとみらい2-2-1', locationName: '東京', floors: [] },
                { id: 9, name: '神戸ポートタワー', address: '兵庫県神戸市中央区波止場町5-5', locationName: '大阪', floors: [] },
                { id: 10, name: '福岡PayPayドーム', address: '福岡県福岡市中央区地行浜2-2-2', locationName: '福岡', floors: [] },
                { id: 11, name: '東京スカイツリー', address: '東京都墨田区押上1-1-2', locationName: '東京', floors: [] },
                { id: 12, name: '東京タワー', address: '東京都港区芝公園4-2-8', locationName: '東京', floors: [] },
            ];

             // News
             data.news = [
                { id: 1, date: '2025-08-05', title: 'システムリニューアルのお知らせ', content: '本日、設備点検管理システムをリニューアルしました。\nトップページおよびお知らせ機能が追加されています。' },
                { id: 2, date: '2025-08-01', title: '夏季メンテナンス期間について', content: '8月13日から8月15日まではシステムメンテナンス期間となります。\nご迷惑をおかけしますが、ご理解のほどよろしくお願いいたします。' }
            ];
             for (let i = 3; i <= 25; i++) {
                data.news.push({ id: i, date: `2025-07-${String(31-i).padStart(2,'0')}`, title: `定期メンテナンス完了のお知らせ ${i-2}`, content: `No.${i-2}の定期システムメンテナンスが完了しました。ご協力いただきありがとうございました。`});
            }

            // Organizations
            data.organizations = [
                { id: 1, company: '株式会社A&M', location: '東京', department: '第一ビル管理部', manager: '首都圏担当チーム' },
                { id: 2, company: '株式会社A&M', location: '大阪', department: '関西ビル管理部', manager: '近畿担当チーム' },
                { id: 3, company: '株式会社ビルメンテナンス西日本', location: '大阪', department: 'プロパティマネジメント課', manager: '大阪PMチーム' },
                { id: 4, company: '株式会社ビルメンテナンス西日本', location: '福岡', department: '九州支社', manager: '福岡PMチーム' },
                { id: 5, company: '東方設備サービス株式会社', location: '東京', department: '設備部', manager: '設備保守グループ' },
                { id: 6, company: '株式会社A&M', location: '名古屋', department: '中部ビル管理部', manager: '東海担当チーム' },
                { id: 7, company: '株式会社A&M', location: '札幌', department: '北海道ビル管理部', manager: '北海道担当チーム' },
                { id: 8, company: '東方設備サービス株式会社', location: '大阪', department: '関西設備部', manager: '関西設備保守グループ' },
            ];
            for (let i = 9; i <= 30; i++) {
                const locations = ['東京','大阪','福岡','名古屋','札幌'];
                const companies = ['株式会社A&M', '株式会社ビルメンテナンス西日本', '東方設備サービス株式会社', '首都圏ファシリティーズ'];
                data.organizations.push({id: i, company: companies[i%4], location:locations[i%5], department: `第${i%3 + 1}事業部`, manager: `担当チーム${String.fromCharCode(65 + i%5)}`});
            }


             // Equipment Types
             data.equipmentTypes = [
                { id: 1, group: '空調設備', type: 'パッケージエアコン' }, { id: 2, group: '空調設備', type: '冷却塔' },
                { id: 3, group: '衛生設備', type: '給水ポンプ' }, { id: 4, group: '衛生設備', type: '排水槽' },
                { id: 5, group: '電気設備', type: '受変電設備' }, { id: 6, group: '電気設備', type: '非常用発電機' },
                { id: 7, group: '昇降機設備', type: 'エレベーター' }, { id: 8, group: '消防設備', type: '自動火災報知設備' },
            ];
            
            // Equipment
            data.equipment = [
                { id: 1, name: '西側 空調機(PAC-01)', quantity: 1, typeId: 1, location: '機械室A', buildingId: 1, floorName: '10F' },
                { id: 2, name: '冷却塔(CT-01)', quantity: 1, typeId: 2, location: '屋上機械室', buildingId: 1, floorName: '屋上' },
                { id: 3, name: '給水ポンプユニット(PU-B2)', quantity: 1, typeId: 3, location: 'ポンプ室', buildingId: 2, floorName: 'B2F' },
                { id: 4, name: '東側 空調機(PAC-50E)', quantity: 1, typeId: 1, location: '機械室B', buildingId: 2, floorName: '50F' },
                { id: 5, name: 'メイン変圧器(Tr-1)', quantity: 1, typeId: 5, location: '電気室', buildingId: 2, floorName: 'B2F' },
                { id: 6, name: '南館 非常用エレベーター', quantity: 1, typeId: 7, location: '南館EVホール', buildingId: 3, floorName: '' },
                { id: 7, name: '北館 排水槽', quantity: 1, typeId: 4, location: '地下機械室', buildingId: 3, floorName: 'B2F' },
                { id: 8, name: '展望台空調パッケージ', quantity: 1, typeId: 1, location: '60F機械室', buildingId: 4, floorName: '60F展望台' },
                { id: 9, name: '防災センター受信機', quantity: 1, typeId: 8, location: '防災センター', buildingId: 4, floorName: '' },
                { id: 10, name: '非常用発電機', quantity: 1, typeId: 6, location: '屋上発電機室', buildingId: 5, floorName: '屋上' },
            ];
            for (let i = 11; i <= 50; i++) {
                const buildingId = (i % 12) + 1;
                const building = data.buildings.find(b => b.id === buildingId);
                const typeId = (i % 8) + 1;
                const type = data.equipmentTypes.find(t => t.id === typeId);
                data.equipment.push({ id: i, name: `${building.name.substring(0,2)}_${type.type.substring(0,3)}_${i}`, quantity: 1, typeId: typeId, location: `エリア${String.fromCharCode(65 + i%4)}-${i%10}`, buildingId: buildingId, floorName: '' });
            }

            // Item Sets
            data.itemSets = [
                { id: 1, name: 'パッケージエアコン月次点検', typeId: 1, isStandard: true, items: [
                    { id: 101, name: 'フィルター状態確認', inputType: 'select', options: ['良好', '清掃要', '破損'], scope: '標準', category: '設備', unit: '' }, 
                    { id: 102, name: 'ドレンパン汚れ確認', inputType: 'text', options: [], scope: '現場', category: '設備', unit: '' },
                    { id: 103, name: '室外機周辺温度', inputType: 'number', options: [], scope: '現場', category: '共通', unit: '℃' }
                ] },
                { id: 2, name: '冷却塔定期点検', typeId: 2, isStandard: true, items: [
                    { id: 201, name: '循環水量確認', inputType: 'number', options: [], scope: '標準', category: '設備', unit: 'm3/h' }, 
                    { id: 202, name: 'ファン異音確認', inputType: 'select', options: ['無し', '有り'], scope: '現場', category: '設備', unit: '' }
                ] },
                { id: 3, name: '給水ポンプ定期点検', typeId: 3, isStandard: false, items: [
                    { id: 301, name: '運転圧力確認', inputType: 'number', options: [], scope: '標準', category: '設備', unit: 'MPa' }, 
                    { id: 302, name: 'グランド部漏水確認', inputType: 'select', options: ['適量', '過多', '無し'], scope: '現場', category: '設備', unit: '' }
                ] },
                { id: 8, name: '自火報受信機点検', typeId: 8, isStandard: true, items: [
                    { id: 801, name: '予備電源試験', inputType: 'select', options: ['正常', '異常'], scope: '標準', category: '設備', unit: '' }
                ] }
            ];
             for (let i = 4; i <= 20; i++) {
                const typeId = (i % 8) + 1;
                const typeInfo = data.equipmentTypes.find(t=> t.id === typeId);
                data.itemSets.push({ id: i, name: `${typeInfo.type}法定点検`, typeId: typeId, isStandard: i%3==0, items: [{id: i*100+1, name: '外観目視確認', inputType: 'text', options: [], scope: '標準', category: '設備', unit: ''}] });
            }


            // Templates
            data.templates = [
                { id: 1, name: '空調月次点検セット', buildingId: 1, locationName: '東京', equipmentIds: [1], itemSetId: 1 },
                { id: 2, name: '冷却設備月次点検セット', buildingId: 1, locationName: '東京', equipmentIds: [2], itemSetId: 2 },
                { id: 3, name: '衛生設備日常点検セット', buildingId: 2, locationName: '東京', equipmentIds: [3], itemSetId: 3 },
                { id: 4, name: '空調・電気重点点検', buildingId: 2, locationName: '東京', equipmentIds: [4, 5], itemSetId: 1 },
                { id: 5, name: '防災設備半年点検', buildingId: 4, locationName: '大阪', equipmentIds: [9], itemSetId: 8 }
            ];
            for (let i = 6; i <= 25; i++) {
                const buildingId = (i % 12) + 1;
                const building = data.buildings.find(b => b.id === buildingId);
                data.templates.push({ id: i, name: `${building.name} 第${i%4+1}四半期点検`, buildingId: building.id, locationName: building.locationName, equipmentIds: [i+5], itemSetId: (i%4)+1 });
            }

            // WorkOrders
            data.workOrders = [
                { id: 1, name: '月次A工事', buildingId: 1, locationName: '東京', templateIds: [1, 2], creationDate: '2025-08-01' },
                { id: 2, name: '日常巡回点検B', buildingId: 2, locationName: '東京', templateIds: [3], creationDate: '2025-08-02' },
                { id: 3, name: '防災設備法定点検', buildingId: 4, locationName: '大阪', templateIds: [5], creationDate: '2025-08-03' }
            ];
            for (let i = 4; i <= 22; i++) {
                 const buildingId = (i % 12) + 1;
                 const building = data.buildings.find(b => b.id === buildingId);
                 data.workOrders.push({ id: i, name: `${building.name} 2025年8月度定期点検`, buildingId: building.id, locationName: building.locationName, templateIds: [i-2], creationDate: `2025-07-${String(31-i).padStart(2,'0')}` });
            }


            // WorkOrderResults
            data.workOrderResults = [{
                id: 1,
                workOrderId: 1,
                workOrderName: '月次A工事',
                executionDate: '2025/08/05',
                status: 'pending',
                templateResults: {
                    '1': {
                        templateId: 1,
                        templateName: '空調月次点検セット',
                        commonResults: [ { itemId: 103, value: '32.5' } ],
                        equipmentResults: [{ equipmentId: 1, remarks: 'フィルター清掃実施。', photos: [], itemResults: [{ itemId: 101, value: '清掃要', isExcluded: false }, { itemId: 102, value: '汚れあり', isExcluded: false }] }]
                    },
                     '2': {
                        templateId: 2,
                        templateName: '冷却設備月次点検セット',
                        commonResults: [],
                        equipmentResults: [{ equipmentId: 2, remarks: 'ファンより僅かに異音。要経過観察。', photos: [], itemResults: [{ itemId: 201, value: '50.5', isExcluded: false }, { itemId: 202, value: '有り', isExcluded: false }] }]
                    }
                }
            }];
        }

        // --- ページ・UI制御 ---
        function showPage(pageId) {
            const currentPageEl = document.querySelector('.page.active');
            if (currentPageEl && (currentPageEl.id === 'inspection-execution' || currentPageEl.id === 'result-detail-view' || currentPageEl.id === 'work-order-preview-detail')) {
                if (currentWorkOrderExecution) {
                    if (!confirm('点検の変更は保存されていません。このページから移動しますか？')) {
                        return;
                    }
                }
                currentWorkOrderExecution = null;
                currentResultDetailState = { resultId: null, floorName: 'all', templateId: null, highlightEquipmentId: null };
                currentWorkOrderPreview = null;
            }

            const filtersMount = document.getElementById('header-filters-mount');
            const actionsMount = document.getElementById('header-actions-mount');

            if (currentControls.parent) {
                if (currentControls.actions) currentControls.parent.prepend(currentControls.actions);
                if (currentControls.filters) currentControls.parent.prepend(currentControls.filters);
            }
            filtersMount.innerHTML = '';
            actionsMount.innerHTML = '';
            currentControls = { filters: null, actions: null, parent: null };

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                const cardElement = targetPage.querySelector('.card');
                if (cardElement) {
                    const filters = cardElement.querySelector('.header-filters');
                    const actions = cardElement.querySelector('.header-actions');
                    if (filters) {
                        filtersMount.appendChild(filters);
                        currentControls.filters = filters;
                    }
                    if (actions) {
                        actionsMount.appendChild(actions);
                        currentControls.actions = actions;
                    }
                    if(filters || actions) {
                        currentControls.parent = cardElement;
                    }
                }
            }
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const clickedLink = Array.from(document.querySelectorAll('.nav-link')).find(l => l.getAttribute('onclick') === `showPage('${pageId}')`);
            if (clickedLink) {
                 clickedLink.classList.add('active');
            }


            const titles = {
                'top-page': 'トップページ',
                'top-page-app': 'トップページ',
                'news-management': 'お知らせ管理',
                'equipment-list': '設備管理',
                'building-management': '建物管理',
                'organization-management': '組織管理',
                'item-set-management': '点検表管理',
                'inspection-templates': 'データセット管理',
                'work-order-management': '点検作業管理',
                'work-order-selection': '点検作業実施',
                'work-results-management': '点検作業・結果管理',
                'dataset-reference': 'データセット参照'
            };

            if (titles[pageId]) {
                document.getElementById('pageTitle').textContent = titles[pageId];
            } else if (pageId !== 'inspection-execution' && pageId !== 'result-detail-view' && pageId !== 'work-order-preview-detail') {
                 document.getElementById('pageTitle').textContent = 'ダッシュボード';
            }
            
            if (pageId === 'top-page') renderTopPageNews('news-display-container');
            if (pageId === 'top-page-app') renderTopPageNews('news-display-container-app');
            if (pageId === 'news-management') renderNewsManagementTable();
            if (pageId === 'work-order-selection') renderWorkOrderSelectionList();
            if (pageId === 'work-results-management') renderWorkResultsTable();
        }

        function toggleSidebar() { const sb = document.getElementById('sidebar'); sb.classList.toggle('hidden'); document.getElementById('mainContent').classList.toggle('sidebar-hidden'); if (window.innerWidth <= 768) sb.classList.toggle('mobile-visible'); }
        
        function getDatalistOptionsFor(inputId, triggerValue = null) {
            const listType = inputId.toLowerCase();
            
            if (listType.includes('group')) {
                return [...new Set(data.equipmentTypes.map(t => t.group))];
            }
            if (listType.includes('type')) {
                const groupInputId = inputId.replace('Type', 'Group').replace('SearchType','SearchGroup');
                const groupVal = triggerValue || document.getElementById(groupInputId).value;
                let types = data.equipmentTypes;
                if (groupVal) {
                    types = types.filter(t => t.group === groupVal);
                }
                return [...new Set(types.map(t => t.type))];
            }
             if (listType.includes('location')) {
                 const uniqueLocations = [...new Set(data.buildings.map(b => b.locationName).concat(data.organizations.map(o => o.location)))];
                 return uniqueLocations.filter(Boolean);
            }
             if (listType.includes('department')) {
                return [...new Set(data.organizations.map(o => o.department).filter(Boolean))];
            }
            if (listType.includes('building')) {
                const locationInputId = inputId.replace('Building', 'Location');
                const locVal = triggerValue || (document.getElementById(locationInputId) ? document.getElementById(locationInputId).value : null);
                let buildings = data.buildings;
                if (locVal) {
                    buildings = buildings.filter(b => b.locationName === locVal);
                }
                return buildings.map(b => ({ value: b.name, id: b.id }));
            }
            return [];
        }

        function showCustomDatalist(inputEl, listType) {
            let triggerValue = null;
            if (listType.toLowerCase().includes('type')) {
                const groupInputId = listType.replace('Type', 'Group').replace('SearchType','SearchGroup');
                triggerValue = document.getElementById(groupInputId).value;
            } else if (listType.toLowerCase().includes('building')) {
                 const locationInputId = listType.replace('Building', 'Location');
                 if(document.getElementById(locationInputId)) {
                    triggerValue = document.getElementById(locationInputId).value;
                 }
            }
            
            const options = getDatalistOptionsFor(listType, triggerValue);
            const optionsContainer = inputEl.parentElement.querySelector('.custom-datalist-options');
            
            optionsContainer.innerHTML = '';
            if (options.length > 0) {
                options.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-datalist-option';
                    if (typeof option === 'object') {
                        optionDiv.textContent = option.value;
                        optionDiv.dataset.id = option.id;
                    } else {
                        optionDiv.textContent = option;
                    }
                    optionDiv.onmousedown = () => selectDatalistOption(optionDiv, inputEl);
                    optionsContainer.appendChild(optionDiv);
                });
            } else {
                optionsContainer.innerHTML = `<div class="custom-datalist-option no-results">候補がありません</div>`;
            }
            optionsContainer.classList.add('visible');
            filterCustomDatalist(inputEl);
        }

        function filterCustomDatalist(inputEl) {
            const filterText = inputEl.value.toLowerCase();
            const optionsContainer = inputEl.parentElement.querySelector('.custom-datalist-options');
            const options = optionsContainer.querySelectorAll('.custom-datalist-option');
            let hasVisibleOptions = false;

            options.forEach(opt => {
                if (opt.classList.contains('no-results')) return;
                const isVisible = opt.textContent.toLowerCase().includes(filterText);
                opt.style.display = isVisible ? '' : 'none';
                if (isVisible) hasVisibleOptions = true;
            });
            
            const noResultsEl = optionsContainer.querySelector('.no-results');
            if(noResultsEl) noResultsEl.style.display = hasVisibleOptions ? 'none' : '';
        }

        function selectDatalistOption(optionEl, inputEl) {
            inputEl.value = optionEl.textContent;
            if (optionEl.dataset.id) {
                inputEl.dataset.selectedId = optionEl.dataset.id;
            } else {
                delete inputEl.dataset.selectedId;
            }
            inputEl.parentElement.querySelector('.custom-datalist-options').classList.remove('visible');
            const event = new Event('input', { bubbles: true });
            inputEl.dispatchEvent(event);
        }

        function renderAllTables() { 
            [renderNewsManagementTable, renderTopPageNews, renderEquipmentTable, renderBuildingTable, renderOrganizationTable, renderItemSetTable, renderTemplateTable, renderWorkOrderTable, renderWorkResultsTable, renderDatasetReferenceTable].forEach(fn => {
                if (fn.name === 'renderTopPageNews') {
                    renderTopPageNews('news-display-container');
                    renderTopPageNews('news-display-container-app');
                } else {
                    fn();
                }
            }); 
            updateFormSelects(); 
        }

        function handleSort(dataType, key) {
            const state = sortState[dataType] || {};
            const newDir = (state.key === key && state.dir === 'asc') ? 'desc' : 'asc';
            sortState[dataType] = { key, dir: newDir };
            document.querySelectorAll(`th.sortable[onclick*="'${dataType}'"]`).forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.getAttribute('onclick').includes(`'${key}'`)) {
                    th.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            currentPage[dataType] = 1;
            const renderMap = { 'news': renderNewsManagementTable, 'equipment': renderEquipmentTable, 'buildings': renderBuildingTable, 'organizations': renderOrganizationTable, 'itemSets': renderItemSetTable, 'templates': renderTemplateTable, 'workOrders': renderWorkOrderTable, 'results': renderWorkResultsTable, 'workOrderSelection': renderWorkOrderSelectionList, 'datasetRef': renderDatasetReferenceTable };
            const renderFn = renderMap[dataType]; if (renderFn) renderFn();
        }

        function sortData(array, state) {
            if (!state || !state.key) return array;
            return [...array].sort((a, b) => {
                let valA = a[state.key];
                let valB = b[state.key];

                if (state.key === 'date' || state.key === 'lastInspectionDate' || state.key.includes('Date')) {
                    const dateA = (valA && !isNaN(new Date(valA))) ? new Date(valA) : new Date(0);
                    const dateB = (valB && !isNaN(new Date(valB))) ? new Date(valB) : new Date(0);
                    return state.dir === 'asc' ? dateA - dateB : dateB - dateA;
                }

                if (typeof valA === 'boolean') { valA = valA ? 1 : 0; valB = valB ? 1 : 0; }
                if (typeof valA === 'number' && typeof valB === 'number') { return state.dir === 'asc' ? valA - valB : valB - valA; }
                if(typeof valA === 'string') { valA = (valA || '').toLowerCase(); }
                if(typeof valB === 'string') { valB = (valB || '').toLowerCase(); }
                if (valA < valB) return state.dir === 'asc' ? -1 : 1;
                if (valA > valB) return state.dir === 'asc' ? 1 : -1;
                return 0;
            });
        }


        function clearFilters(page) {
            const pageElement = document.getElementById(page + '-filters') || document.getElementById('header-filters-mount');
            pageElement.querySelectorAll('input, select').forEach(el => {
                el.value = '';
                delete el.dataset.selectedId;
                const event = new Event('input', { bubbles: true });
                el.dispatchEvent(event);
            });
            const renderMap = {
                'equipment': renderEquipmentTable,
                'template': renderTemplateTable,
                'workorder': renderWorkOrderTable,
                'workorder-selection': renderWorkOrderSelectionList,
                'itemset': renderItemSetTable,
                'datasetRef': renderDatasetReferenceTable,
                'organization': renderOrganizationTable,
                'building': renderBuildingTable
            };
            const renderFn = renderMap[page];
            if(renderFn) renderFn();
        }

        function renderPagination(dataType, totalItems) {
            const bottomContainer = document.getElementById(`pagination-bottom-${dataType}`);
            if (!bottomContainer) return;

            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const page = currentPage[dataType];

            if (totalPages <= 1) {
                bottomContainer.innerHTML = '';
                return;
            }

            let html = `<nav><ul class="pagination">`;
            html += `<li class="page-item ${page === 1 ? 'disabled' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); goToPage('${dataType}', ${page - 1})">前へ</a></li>`;

            let startPage = Math.max(1, page - 2);
            let endPage = Math.min(totalPages, page + 2);

            if (startPage > 1) html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); goToPage('${dataType}', 1)">1</a></li>`;
            if (startPage > 2) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); goToPage('${dataType}', ${i})">${i}</a></li>`;
            }

            if (endPage < totalPages - 1) html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            if (endPage < totalPages) html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); goToPage('${dataType}', ${totalPages})">${totalPages}</a></li>`;

            html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" onclick="event.preventDefault(); goToPage('${dataType}', ${page + 1})">次へ</a></li>`;
            html += `</ul></nav>`;

            bottomContainer.innerHTML = html;
        }

        function goToPage(dataType, page) {
            const renderMap = { 'news': renderNewsManagementTable, 'equipment': renderEquipmentTable, 'buildings': renderBuildingTable, 'organizations': renderOrganizationTable, 'itemSets': renderItemSetTable, 'templates': renderTemplateTable, 'workOrders': renderWorkOrderTable, 'workOrderSelection': renderWorkOrderSelectionList, 'results': renderWorkResultsTable, 'datasetRef': renderDatasetReferenceTable };
            const renderFn = renderMap[dataType];
            if (!renderFn) return;
            if(page < 1) return;
            currentPage[dataType] = page;
            renderFn();
        }
        
        function renderTopPageNews(containerId = 'news-display-container') {
            const container = document.getElementById(containerId);
            if (!container) return;

            const sortedNews = sortData(data.news, { key: 'date', dir: 'desc' });
            const latestNews = sortedNews.slice(0, 5);

            if (latestNews.length === 0) {
                container.innerHTML = '<p>現在、新しいお知らせはありません。</p>';
                return;
            }

            container.innerHTML = latestNews.map(news => `
                <div class="news-item">
                    <h3>${news.title}</h3>
                    <div class="news-date">${news.date}</div>
                    <p>${news.content}</p>
                </div>
            `).join('');
        }

        function renderNewsManagementTable() {
            const sorted = sortData(data.news, sortState['news'] || { key: 'date', dir: 'desc' });
            renderPagination('news', sorted.length);

            const start = (currentPage.news - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);

            const tbody = document.getElementById('newsTableBody');
            tbody.innerHTML = paginated.map(news => {
                const shortContent = news.content.length > 50 ? news.content.substring(0, 50) + '...' : news.content;
                return `<tr>
                            <td>${news.date}</td>
                            <td>${news.title}</td>
                            <td>${shortContent}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="openNewsModal(${news.id})">編集</button> 
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('news', ${news.id})">削除</button>
                            </td>
                        </tr>`;
            }).join('') || '<tr><td colspan="4" style="text-align:center; padding: 2rem;">お知らせがありません。</td></tr>';
        }

        function getInspectionHistoryForEquipment(equipmentId) {
            const history = [];
            data.workOrderResults.forEach(result => {
                let wasFound = false;
                for (const templateId in result.templateResults) {
                    const templateResult = result.templateResults[templateId];
                    if (templateResult.equipmentResults.some(er => er.equipmentId === equipmentId)) {
                        wasFound = true;
                        break;
                    }
                }
                if (wasFound) {
                    history.push({
                        date: result.executionDate,
                        resultId: result.id,
                        workOrderName: result.workOrderName
                    });
                }
            });
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            return history;
        }

        function renderEquipmentTable() {
            const filters = { name: document.getElementById('equipmentSearchName').value.toLowerCase(), group: document.getElementById('equipmentSearchGroup').value.toLowerCase(), type: document.getElementById('equipmentSearchType').value.toLowerCase(), building: document.getElementById('equipmentSearchBuilding').value.toLowerCase() };
            
            let enrichedEquipmentData = data.equipment.map(eq => {
                const type = data.equipmentTypes.find(t => t.id === eq.typeId) || {};
                const building = data.buildings.find(b => b.id === eq.buildingId) || {};
                const inspectionHistory = getInspectionHistoryForEquipment(eq.id);
                const lastInspectionDate = inspectionHistory.length > 0 ? inspectionHistory[0].date : null;

                return { ...eq, group: type.group, type: type.type, buildingName: building.name, locationName: building.locationName, lastInspectionDate: lastInspectionDate, inspectionHistory: inspectionHistory };
            });

            let filtered = enrichedEquipmentData.filter(eq => (eq.name.toLowerCase().includes(filters.name)) && (eq.group?.toLowerCase() || '').includes(filters.group) && (eq.type?.toLowerCase() || '').includes(filters.type) && (eq.buildingName?.toLowerCase() || '').includes(filters.building) );

            const sorted = sortData(filtered, sortState['equipment']);
            
            renderPagination('equipment', sorted.length);
            const start = (currentPage.equipment - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);

            const tbody = document.getElementById('equipmentTableBody');
            tbody.innerHTML = paginated.map(eq => {
                const history = eq.inspectionHistory;

                let lastDateHtml = '―';
                if (eq.lastInspectionDate) {
                    lastDateHtml = `<a href="#" onclick="event.preventDefault(); showResultDetailModal(${history[0].resultId}, ${eq.id})">${eq.lastInspectionDate}</a>`;
                }
                
                let historyHtml = '―';
                if (history && history.length > 0) {
                    historyHtml = `<button class="btn btn-sm btn-secondary" onclick="openInspectionHistoryModal(${eq.id}, '${eq.name}')">履歴 (${history.length})</button>`;
                }

                return `<tr>
                            <td>${eq.name}</td>
                            <td>${eq.quantity}</td>
                            <td>${eq.group || ''}</td>
                            <td>${eq.type || ''}</td>
                            <td>${eq.locationName || ''}</td>
                            <td>${eq.buildingName || ''}</td>
                            <td>${eq.floorName || '―'}</td>
                            <td>${lastDateHtml}</td>
                            <td>${historyHtml}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="editEquipment(${eq.id})">編集</button> 
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('equipment', ${eq.id})">削除</button>
                            </td>
                        </tr>`;
            }).join('') || '<tr><td colspan="10" style="text-align:center; padding: 2rem;">該当する設備がありません。</td></tr>';
        }

        function renderBuildingTable() {
            const filters = {
                name: document.getElementById('buildingSearchName').value.toLowerCase(),
                location: document.getElementById('buildingSearchLocation').value.toLowerCase()
            };

            // 1. ビルデータをフロア単位のデータに変換（フラット化）
            const flatBuildingData = [];
            data.buildings.forEach(building => {
                if (building.floors && building.floors.length > 0) {
                    building.floors.forEach(floor => {
                        flatBuildingData.push({
                            // ...building, // このように展開すると元のオブジェクトが参照されてしまうため、個別にプロパティをコピー
                            id: building.id,
                            name: building.name,
                            address: building.address,
                            locationName: building.locationName,
                            floorName: floor.name,
                            floorPhotos: floor.photos || [],
                            floorMappings: floor.mappings || []
                        });
                    });
                } else {
                    // フロアがないビルも表示対象とする
                    flatBuildingData.push({
                        id: building.id,
                        name: building.name,
                        address: building.address,
                        locationName: building.locationName,
                        floorName: '未設定',
                        floorPhotos: [],
                        floorMappings: []
                    });
                }
            });

            // 2. フラット化されたデータに対してフィルタリング
            const filteredData = flatBuildingData.filter(item => 
                item.name.toLowerCase().includes(filters.name) &&
                item.locationName.toLowerCase().includes(filters.location)
            );

            // 3. フィルタリング後のデータでソートとページネーション
            const sorted = sortData(filteredData, sortState['buildings']);
            renderPagination('buildings', sorted.length);
            const start = (currentPage.buildings - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);

            const tbody = document.getElementById('buildingTableBody');
            
            // 4. 新しいデータ構造を元にテーブル行を生成
            tbody.innerHTML = paginated.map(item => {
                let floorPlanHtml = '―';
                let floorEquipmentButton = '―';
                
                if(item.floorPhotos.length > 0) {
                    floorPlanHtml = `<img src="${item.floorPhotos[0]}" alt="平面図" class="table-thumbnail" onclick="openPhotoModal('${item.floorPhotos[0]}')">`;
                    floorEquipmentButton = `<button class="btn btn-sm btn-secondary" onclick="openMappingPreviewModal(${item.id}, '${item.floorName}')">参照</button>`;
                }

                return `<tr>
                            <td>${item.name}</td>
                            <td>${item.address}</td>
                            <td>${item.floorName}</td>
                            <td>${floorPlanHtml}</td>
                            <td>${floorEquipmentButton}</td>
                            <td>${item.locationName}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="editBuilding(${item.id})">編集</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('buildings', ${item.id})">削除</button>
                            </td>
                        </tr>`;
            }).join('') || '<tr><td colspan="7" style="text-align:center; padding: 2rem;">データがありません。</td></tr>';
        }

        function renderOrganizationTable() {
            const filters = {
                company: document.getElementById('orgSearchCompany').value.toLowerCase(),
                location: document.getElementById('orgSearchLocation').value.toLowerCase(),
                department: document.getElementById('orgSearchDepartment').value.toLowerCase()
            };
            const filtered = data.organizations.filter(o => 
                o.company.toLowerCase().includes(filters.company) &&
                o.location.toLowerCase().includes(filters.location) &&
                o.department.toLowerCase().includes(filters.department)
            );

            const sorted = sortData(filtered, sortState['organizations']);
            renderPagination('organizations', sorted.length);
            const start = (currentPage.organizations - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);

            const tbody = document.getElementById('organizationTableBody');
            tbody.innerHTML = paginated.map(o => `<tr><td>${o.company}</td><td>${o.location}</td><td>${o.department}</td><td>${o.manager}</td><td><button class="btn btn-sm btn-secondary" onclick="editOrganization(${o.id})">編集</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('organizations', ${o.id})">削除</button></td></tr>`).join('') || '<tr><td colspan="5" style="text-align:center; padding: 2rem;">データがありません。</td></tr>';
        }

        function renderItemSetTable() {
            const filters = {
                name: document.getElementById('itemSetSearchInput').value.toLowerCase(),
                group: document.getElementById('itemSetSearchGroup').value.toLowerCase(),
                type: document.getElementById('itemSetSearchType').value.toLowerCase(),
                standard: document.getElementById('itemSetSearchStandard').value
            };
            let filtered = data.itemSets.map(s => {
                const typeInfo = data.equipmentTypes.find(t => t.id === s.typeId) || {};
                return { ...s, itemCount: s.items.length, group: typeInfo.group, type: typeInfo.type };
            }).filter(s => {
                const nameMatch = s.name.toLowerCase().includes(filters.name);
                const groupMatch = (s.group || '').toLowerCase().includes(filters.group);
                const typeMatch = (s.type || '').toLowerCase().includes(filters.type);
                const standardMatch = filters.standard ? String(s.isStandard) === filters.standard : true;
                return nameMatch && groupMatch && typeMatch && standardMatch;
            });

            const sorted = sortData(filtered, sortState['itemSets']);
            renderPagination('itemSets', sorted.length);
            const start = (currentPage.itemSets - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);
            const tbody = document.getElementById('itemSetTableBody');
            tbody.innerHTML = paginated.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.group}</td>
                    <td>${s.type}</td>
                    <td style="text-align: center;">${s.isStandard ? '○' : '―'}</td>
                    <td>${s.itemCount}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editItemSet(${s.id})">編集</button> 
                        <button class="btn btn-sm btn-info" onclick="copyItemSet(${s.id})">コピー</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteItem('itemSets', ${s.id})">削除</button>
                    </td>
                </tr>`).join('') || '<tr><td colspan="6" style="text-align:center; padding: 2rem;">データがありません。</td></tr>';
        }

        function renderTemplateTable() {
            const filters = {
                name: document.getElementById('templateSearchInput')?.value.toLowerCase() || '',
                location: document.getElementById('templateSearchLocation')?.value.toLowerCase() || '',
                building: document.getElementById('templateSearchBuilding')?.value.toLowerCase() || '',
            };
            let tData = data.templates.map(t => {
                const itemSet = data.itemSets.find(s => s.id === t.itemSetId) || {};
                const building = data.buildings.find(b => b.id === t.buildingId) || {};
                return {...t, equipmentCount: t.equipmentIds.length, itemSetName: itemSet.name, buildingName: building.name };
            });
            const filtered = tData.filter(t => 
                t.name.toLowerCase().includes(filters.name) &&
                t.locationName.toLowerCase().includes(filters.location) &&
                (t.buildingName || '').toLowerCase().includes(filters.building)
            );
            const sorted = sortData(filtered, sortState['templates']);
            renderPagination('templates', sorted.length);
            const start = (currentPage.templates - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);

            const tbody = document.getElementById('templateTableBody');
            tbody.innerHTML = paginated.map(t => `<tr><td>${t.name}</td><td>${t.locationName}</td><td>${t.buildingName}</td><td>${t.itemSetName}</td><td>${t.equipmentCount}台</td><td><button class="btn btn-sm btn-secondary" onclick="editTemplate(${t.id})">編集</button> <button class="btn btn-sm btn-danger" onclick="deleteItem('templates', ${t.id})">削除</button></td></tr>`).join('') || '<tr><td colspan="6" style="text-align:center; padding: 2rem;">データがありません。</td></tr>';
        }
        
        function renderWorkOrderTable() {
            const filters = {
                name: document.getElementById('workOrderSearchInput').value.toLowerCase(),
                location: document.getElementById('workOrderSearchLocation').value.toLowerCase(),
                building: document.getElementById('workOrderSearchBuilding').value.toLowerCase(),
            };
            const enrichedWorkOrders = data.workOrders.map(w => {
                const building = data.buildings.find(b => b.id === w.buildingId) || {};
                const relatedResults = data.workOrderResults.filter(r => r.workOrderId === w.id);
                let latestExecutionDate = '―';
                if (relatedResults.length > 0) {
                    relatedResults.sort((a, b) => new Date(b.executionDate) - new Date(a.executionDate));
                    latestExecutionDate = relatedResults[0].executionDate;
                }
                return { ...w, templateCount: w.templateIds.length, buildingName: building.name, latestExecutionDate };
            });

            const filtered = enrichedWorkOrders.filter(w => {
                 return w.name.toLowerCase().includes(filters.name) &&
                        w.locationName.toLowerCase().includes(filters.location) &&
                        (w.buildingName || '').toLowerCase().includes(filters.building)
            });

            const sorted = sortData(filtered, sortState['workOrders']);
            renderPagination('workOrders', sorted.length);
            const start = (currentPage.workOrders - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);
            const tbody = document.getElementById('workOrderTableBody');
            tbody.innerHTML = paginated.map(w => `<tr>
                <td>${w.name}</td>
                <td>${w.locationName}</td>
                <td>${w.buildingName}</td>
                <td>${w.templateCount}</td>
                <td>${w.creationDate}</td>
                <td>${w.latestExecutionDate}</td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="openWorkOrderPreviewDetail(${w.id})">参照</button>
                    <button class="btn btn-sm btn-secondary" onclick="editWorkOrder(${w.id})">編集</button> 
                    <button class="btn btn-sm btn-danger" onclick="deleteItem('workOrders', ${w.id})">削除</button>
                </td>
            </tr>`).join('') || '<tr><td colspan="7" style="text-align:center; padding: 2rem;">データがありません。</td></tr>';
        }

        function renderWorkOrderSelectionList() {
            const filters = {
                name: document.getElementById('workOrderSelectionSearchInput').value.toLowerCase(),
                location: document.getElementById('workOrderSelectionSearchLocation').value.toLowerCase(),
                building: document.getElementById('workOrderSelectionSearchBuilding').value.toLowerCase(),
            };
            const cont = document.getElementById('workOrderSelectionContainer');
            const filtered = data.workOrders.filter(w => {
                 const building = data.buildings.find(b => b.id === w.buildingId) || {};
                 return w.name.toLowerCase().includes(filters.name) &&
                        w.locationName.toLowerCase().includes(filters.location) &&
                        (building.name || '').toLowerCase().includes(filters.building)
            }).map(w => ({ ...w, buildingName: (data.buildings.find(b=>b.id === w.buildingId) || {}).name }));
            
            const sorted = sortData(filtered, sortState['workOrderSelection']);
            renderPagination('workOrderSelection', sorted.length);
            const start = (currentPage.workOrderSelection - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);
            
            if (paginated.length === 0) {
                cont.innerHTML = '<p style="text-align:center; padding: 2rem;">該当する点検作業がありません。</p>';
                return;
            }
            let html = `<table class="table"><thead><tr><th class="sortable" onclick="handleSort('workOrderSelection', 'name')">点検作業名</th><th class="sortable" onclick="handleSort('workOrderSelection', 'locationName')">拠点</th><th class="sortable" onclick="handleSort('workOrderSelection', 'buildingName')">建物</th><th>データセット数</th><th></th></tr></thead><tbody>`;
            html += paginated.map(w => {
                return `<tr><td>${w.name}</td><td>${w.locationName}</td><td>${w.buildingName}</td><td>${w.templateIds.length}</td><td><button class="btn btn-primary btn-sm" onclick="startWorkOrderInspection(${w.id})">この点検を開始</button></td></tr>`;
            }).join('');
            html += `</tbody></table>`;
            cont.innerHTML = html;
        }

        function renderWorkResultsTable() {
            const term = document.getElementById('resultSearchInput').value.toLowerCase();
            
            const allTasks = data.workOrders.flatMap(wo => {
                const relatedResults = data.workOrderResults.filter(r => r.workOrderId === wo.id);
                const building = data.buildings.find(b => b.id === wo.buildingId) || {};

                if (relatedResults.length === 0) {
                    return [{
                        ...wo,
                        buildingName: building.name,
                        executionDate: '―',
                        status: 'not-executed',
                        resultId: null
                    }];
                } else {
                    return relatedResults.map(r => ({
                        ...wo,
                        buildingName: building.name,
                        executionDate: r.executionDate,
                        status: r.status,
                        resultId: r.id
                    }));
                }
            });

            const filtered = allTasks.filter(task => task.name.toLowerCase().includes(term));
            const sorted = sortData(filtered, sortState['results']);
            renderPagination('results', sorted.length);
            const start = (currentPage.results - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);

            const statusMap = {
                completed: '完了',
                pending: '要確認',
                confirmed: '確認済',
                'not-executed': '未実施'
            };

            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = paginated.map(task => `
                <tr>
                    <td>${task.name}</td>
                    <td>${task.locationName || 'N/A'}</td>
                    <td>${task.buildingName || 'N/A'}</td>
                    <td>${task.creationDate}</td>
                    <td>${task.executionDate}</td>
                    <td><span class="status-badge ${task.status}">${statusMap[task.status] || task.status}</span></td>
                    <td>${task.resultId ? `<button class="btn btn-sm btn-secondary" onclick="showResultDetail(${task.resultId})">詳細</button>` : '―'}</td>
                </tr>
            `).join('') || '<tr><td colspan="7" style="text-align:center; padding: 2rem;">データがありません。</td></tr>';
        }

        function renderDatasetReferenceTable() {
            const filters = {
                name: document.getElementById('datasetRefSearchInput')?.value.toLowerCase() || '',
                location: document.getElementById('datasetRefSearchLocation')?.value.toLowerCase() || '',
                building: document.getElementById('datasetRefSearchBuilding')?.value.toLowerCase() || '',
            };
            let tData = data.templates.map(t => {
                const itemSet = data.itemSets.find(s => s.id === t.itemSetId) || {};
                const building = data.buildings.find(b => b.id === t.buildingId) || {};
                return {...t, equipmentCount: t.equipmentIds.length, itemSetName: itemSet.name, buildingName: building.name };
            });
            const filtered = tData.filter(t => 
                t.name.toLowerCase().includes(filters.name) &&
                t.locationName.toLowerCase().includes(filters.location) &&
                (t.buildingName || '').toLowerCase().includes(filters.building)
            );
            const sorted = sortData(filtered, sortState['datasetRef']);
            renderPagination('datasetRef', sorted.length);
            const start = (currentPage.datasetRef - 1) * ITEMS_PER_PAGE;
            const paginated = sorted.slice(start, start + ITEMS_PER_PAGE);

            const tbody = document.getElementById('datasetRefTableBody');
            tbody.innerHTML = paginated.map(t => `<tr><td>${t.name}</td><td>${t.locationName}</td><td>${t.buildingName}</td><td>${t.itemSetName}</td><td>${t.equipmentCount}台</td><td><button class="btn btn-sm btn-secondary" onclick="openDatasetReferencePreview(${t.id})">プレビュー</button></td></tr>`).join('') || '<tr><td colspan="6" style="text-align:center; padding: 2rem;">データがありません。</td></tr>';
        }

        function openDatasetReferencePreview(templateId) {
            const template = data.templates.find(t => t.id === templateId);
            if (!template) return;
            document.getElementById('datasetRefPreviewTitle').textContent = `「${template.name}」のプレビュー`;
            
            const targetElements = {
                commonContainer: document.getElementById('datasetRefPreviewCommonItems'),
                table: document.getElementById('datasetRefPreviewGridTable')
            };
            generateInspectionGrid(template, true, null, targetElements, false);
            openModal('datasetReferencePreviewModal');
        }

        function getUniqueLocations() { return [...new Set(data.organizations.map(o => o.location).filter(Boolean))]; }
        
        function updateFormSelects() { 
             const popSel = (sel, d, txt, val, def) => { document.querySelectorAll(sel).forEach(s => { const cur = s.value; s.innerHTML = def; d.forEach(i => s.add(new Option(typeof txt === 'function' ? txt(i) : i[txt], i[val]))); if(cur) s.value = cur; }); }; 
             popSel('#buildingLocation', getUniqueLocations().map(loc => ({name: loc})), 'name', 'name', '<option value="">拠点を選択</option>'); 
             popSel('#itemSetGroup', [...new Set(data.equipmentTypes.map(t => t.group))].map(g => ({name:g})), 'name', 'name', '<option value="">区分を選択</option>'); 
        }

        function getEquipmentTypePath(typeId, separator = ' / ') { const t = data.equipmentTypes.find(type => type.id === typeId); if (!t) return 'N/A'; return `${t.group}${separator}${t.type}`; }
        
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        
        function openNewsModal(id = null) {
            const form = document.getElementById('newsForm');
            form.reset();
            document.getElementById('newsId').value = '';
            const modalTitle = document.getElementById('newsModalTitle');

            if (id) {
                const newsItem = data.news.find(n => n.id === id);
                if (newsItem) {
                    modalTitle.textContent = 'お知らせ編集';
                    document.getElementById('newsId').value = newsItem.id;
                    document.getElementById('newsDate').value = newsItem.date;
                    document.getElementById('newsTitle').value = newsItem.title;
                    document.getElementById('newsContent').value = newsItem.content;
                }
            } else {
                modalTitle.textContent = 'お知らせ作成';
                 document.getElementById('newsDate').valueAsDate = new Date();
            }
            openModal('newsModal');
        }

        function handleNewsFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('newsId').value;
            const newsItem = {
                id: id ? +id : Date.now(),
                date: document.getElementById('newsDate').value,
                title: document.getElementById('newsTitle').value,
                content: document.getElementById('newsContent').value,
            };
            saveItem('news', id, newsItem);
            closeAllModals();
        }
        function openPhotoModal(src) { document.getElementById('photoModalImage').src = src; openModal('photoModal'); }
        function closePhotoModal() { document.getElementById('photoModal').style.display = 'none'; }
        function openEquipmentModal() { 
            document.getElementById('equipmentForm').reset(); 
            document.getElementById('equipmentId').value = ''; 
            document.getElementById('equipmentQuantity').value = 1;
            delete document.getElementById('equipmentBuildingSearch').dataset.selectedId;
            updateFloorSelect(null); 
            openModal('equipmentModal'); 
        }
        function openItemSetModal() { 
            document.getElementById('itemSetForm').reset(); 
            document.getElementById('itemSetId').value = ''; 
            document.getElementById('itemSetIsStandard').checked = false;
            document.getElementById('item-set-items-container').innerHTML = ''; 
            updateItemSetTypeSelect(); 
            addDynamicItemToSet(); 
            openModal('itemSetModal'); 
        }
        
        function openTemplateModal() { 
            document.getElementById('templateForm').reset();
            document.getElementById('templateId').value = '';
            
            ['modalTemplateLocationFilter', 'modalTemplateBuildingFilter', 'modalTemplateGroupFilter', 'modalTemplateTypeFilter'].forEach(id => {
                delete document.getElementById(id).dataset.selectedId;
            });
            
            updateBuildingFilter('template');
            updateTemplateTypeFilter();
            handleTemplateModalFiltersChanged();
            
            openModal('templateModal'); 
        }

        function openBuildingModal() { document.getElementById('buildingForm').reset(); document.getElementById('buildingId').value = ''; document.getElementById('buildingFloorsContainer').innerHTML = ''; addFloorToBuildingModal(); openModal('buildingModal'); }
        function openOrganizationModal() { document.getElementById('organizationForm').reset(); document.getElementById('organizationId').value = ''; openModal('organizationModal'); }
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.querySelectorAll('.custom-datalist-options').forEach(o => o.classList.remove('visible'));
            if (mappingCanvas) { mappingCanvas.dispose(); mappingCanvas = null; }
            if (inspectionExecutionCanvas) { inspectionExecutionCanvas.dispose(); inspectionExecutionCanvas = null; }
            if (resultDetailCanvas) { resultDetailCanvas.dispose(); resultDetailCanvas = null; }
            if (resultDetailModalCanvas) { resultDetailModalCanvas.dispose(); resultDetailModalCanvas = null; }
            if (previewExecutionCanvas) { previewExecutionCanvas.dispose(); previewExecutionCanvas = null; }
            if(resizeObserver) resizeObserver.disconnect();
        }

        function openRemarksModal(eqId, templateId) {
            document.getElementById('remarksEquipmentId').value = eqId;
            document.getElementById('remarksTemplateId').value = templateId;
            const remarks = currentWorkOrderExecution.results[templateId]?.equipmentResults?.[eqId]?.remarks || '';
            document.getElementById('remarksTextarea').value = remarks;
            openModal('remarksModal');
        }

        function saveRemarks() {
            const eqId = document.getElementById('remarksEquipmentId').value;
            const templateId = document.getElementById('remarksTemplateId').value;
            const text = document.getElementById('remarksTextarea').value;
            
            if (currentWorkOrderExecution && currentWorkOrderExecution.results[templateId]) {
                 if(!currentWorkOrderExecution.results[templateId].equipmentResults[eqId]) {
                    currentWorkOrderExecution.results[templateId].equipmentResults[eqId] = { remarks: '', photos: [], itemResults: {} };
                }
                currentWorkOrderExecution.results[templateId].equipmentResults[eqId].remarks = text;
                const displayId = `remarks_display_${templateId}_${eqId}`;
                 const displayEl = document.getElementById(displayId);
                 if(displayEl) displayEl.value = text;
            }
            closeAllModals();
        }

        function openEquipmentTypeModal() {
            document.getElementById('equipmentTypeForm').reset();
            delete document.getElementById('newGroup').dataset.selectedId;
            openModal('equipmentTypeModal');
        }
        
        document.getElementById('equipmentTypeForm').addEventListener('submit', e => {
            e.preventDefault();
            const newGroup = document.getElementById('newGroup').value.trim();
            const newType = document.getElementById('newType').value.trim();
            if (!newGroup || !newType) { alert('区分と種別を両方入力してください。'); return; }
            if (data.equipmentTypes.some(t => t.group === newGroup && t.type === newType)) { alert('この設備分類は既に存在します。'); return; }
            data.equipmentTypes.push({ id: Date.now(), group: newGroup, type: newType });
            updateFormSelects();
            document.getElementById('equipmentGroup').value = newGroup;
            document.getElementById('equipmentType').value = newType;
            closeAllModals();
            openModal('equipmentModal');
        });

        function saveItem(type, id, item) { 
            const idx = data[type].findIndex(d => d.id == id); 
            if (idx > -1) data[type][idx] = item; 
            else data[type].push(item); 
            renderAllTables(); 
            updateFormSelects(); 
        }

        function deleteItem(type, id) { 
            if(confirm('本当に削除しますか？')) { 
                data[type] = data[type].filter(d => d.id !== id); 
                currentPage[type] = 1; 
                renderAllTables(); 
                updateFormSelects();
            } 
        }

        function copyItemSet(id) {
            const originalItemSet = data.itemSets.find(s => s.id === id);
            if (!originalItemSet) {
                alert('コピー元の点検表が見つかりません。');
                return;
            }

            if (!confirm(`「${originalItemSet.name}」をコピーしますか？`)) {
                return;
            }

            const today = new Date().toISOString().slice(0, 10);
            const newName = `${originalItemSet.name}_コピー_${today}`;

            const newItemSet = JSON.parse(JSON.stringify(originalItemSet));
            newItemSet.id = Date.now();
            newItemSet.name = newName;

            data.itemSets.push(newItemSet);
            renderItemSetTable();
            alert(`「${newName}」を作成しました。`);
        }

        document.getElementById('equipmentForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('equipmentId').value;
            const group = document.getElementById('equipmentGroup').value;
            const type = document.getElementById('equipmentType').value;
            const equipmentType = data.equipmentTypes.find(t => t.group === group && t.type === type);
            const buildingInput = document.getElementById('equipmentBuildingSearch');
            const buildingId = buildingInput.dataset.selectedId;
            if (!equipmentType || !buildingId) { alert('リストから有効な設備分類と建物を選択してください。\n見つからない場合は、先に追加登録してください。'); return; }
            const typeId = equipmentType.id;
            const floorName = document.getElementById('equipmentFloor').value;

            saveItem('equipment', id, {id: id ? +id : Date.now(), name: document.getElementById('equipmentName').value, quantity: +document.getElementById('equipmentQuantity').value, typeId: +typeId, location: document.getElementById('equipmentLocation').value, buildingId: +buildingId, floorName: floorName });
            closeAllModals();
        });

        document.getElementById('buildingForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('buildingId').value;
            const existingBuilding = id ? data.buildings.find(b => b.id == id) : null;
            const newFloors = [];

            document.querySelectorAll('#buildingFloorsContainer .floor-row').forEach(row => {
                const newFloorName = row.querySelector('.floor-name-input').value.trim();
                if (!newFloorName) return;

                const originalName = row.dataset.originalName;
                const img = row.querySelector('.photo-preview img');
                const photos = img ? [img.src] : [];
                
                let mappings = [];
                // Find the original floor data to preserve mappings
                const originalFloor = existingBuilding ? existingBuilding.floors.find(f => f.name === originalName) : null;
                if (originalFloor) {
                    mappings = originalFloor.mappings;
                }

                newFloors.push({ 
                    name: newFloorName, 
                    photos: photos,
                    mappings: mappings
                });
            });

            const building = {
                id: id ? +id : Date.now(),
                name: document.getElementById('buildingName').value,
                address: document.getElementById('buildingAddress').value,
                locationName: document.getElementById('buildingLocation').value,
                floors: newFloors
            };
            saveItem('buildings', id, building);
            closeAllModals();
        });

        document.getElementById('organizationForm').addEventListener('submit', e => { e.preventDefault(); const id = document.getElementById('organizationId').value; const org = { id: id ? +id : Date.now(), company: document.getElementById('organizationCompany').value, location: document.getElementById('organizationLocation').value, department: document.getElementById('organizationDepartment').value, manager: document.getElementById('organizationManager').value }; saveItem('organizations', id, org); closeAllModals(); });
        document.getElementById('templateForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('templateId').value;
            const eqIds = Array.from(document.querySelectorAll('#equipmentCheckboxesTableContainer input:checked')).map(cb => +cb.value);
            const itemSetRadio = document.querySelector('#modal-item-set-list-container input[name="templateItemSet"]:checked');
            const itemSetId = itemSetRadio ? +itemSetRadio.value : null;

            const buildingInput = document.getElementById('modalTemplateBuildingFilter');
            const buildingId = buildingInput.dataset.selectedId;
            if (!buildingId) { alert('有効な建物が選択されていません。'); return; }
            const building = data.buildings.find(b => b.id == buildingId);

            if (eqIds.length === 0 || !itemSetId || !building) { alert('建物、対象設備、点検表をすべて選択してください。'); return; }
            saveItem('templates', id, {id: id ? +id : Date.now(), name: document.getElementById('templateName').value, equipmentIds: eqIds, itemSetId: itemSetId, buildingId: +buildingId, locationName: building.locationName});
            closeAllModals();
        });
        document.getElementById('itemSetForm').addEventListener('submit', e => { 
            e.preventDefault(); 
            const id = document.getElementById('itemSetId').value; 
            const typeId = +document.getElementById('itemSetType').value; 
            if(!typeId){ alert('対象の設備種別を選択してください。'); return; } 
            const items = []; 
            document.querySelectorAll('#item-set-items-container .item-set-item-row').forEach(row => { 
                const itemName = row.querySelector('.item-name-input').value.trim(); 
                if (!itemName) return; 
                const scope = row.querySelector('.item-scope-select').value; 
                const category = row.querySelector('.item-category-select').value; 
                const inputType = row.querySelector('.item-type-select').value; 
                const unit = inputType === 'number' ? row.querySelector('.item-unit-input').value : ''; 
                const options = inputType === 'select' ? Array.from(row.querySelectorAll('.option-input')).map(opt => opt.value).filter(Boolean) : []; 
                items.push({ id: row.dataset.id || (Date.now() + Math.random()), name: itemName, scope, category, inputType, unit, options }); 
            }); 
            const itemSet = { 
                id: id ? +id : Date.now(), 
                name: document.getElementById('itemSetName').value, 
                typeId: typeId, 
                isStandard: document.getElementById('itemSetIsStandard').checked,
                items: items 
            };
            saveItem('itemSets', id, itemSet); 
            closeAllModals(); 
        });
        document.getElementById('workOrderForm').addEventListener('submit', e => {
            e.preventDefault(); 
            const id = document.getElementById('workOrderId').value; 
            const templateIds = Array.from(document.querySelectorAll('#templateCheckboxesContainer input:checked')).map(cb => +cb.value); 
            const buildingId = +document.getElementById('modalWorkOrderBuildingFilter').dataset.selectedId;
            const building = data.buildings.find(b => b.id === buildingId); 
            if (templateIds.length === 0 || !building) { 
                alert('建物と、含めるデータセットを1つ以上選択してください。'); 
                return; 
            } 
            const wo = { 
                id: id ? +id : Date.now(), 
                name: document.getElementById('workOrderName').value, 
                templateIds: templateIds, 
                buildingId: buildingId, 
                locationName: building.locationName, 
                creationDate: new Date().toISOString().slice(0, 10) 
            }; 
            saveItem('workOrders', id, wo); 
            closeAllModals(); 
        });

        function editEquipment(id) {
            const e = data.equipment.find(eq => eq.id === id);
            if(!e) return;
            openEquipmentModal();
            const t = data.equipmentTypes.find(type => type.id === e.typeId) || {};
            const b = data.buildings.find(bld => bld.id === e.buildingId) || {};
            document.getElementById('equipmentId').value = e.id;
            document.getElementById('equipmentName').value = e.name;
            document.getElementById('equipmentQuantity').value = e.quantity;
            document.getElementById('equipmentGroup').value = t.group || '';
            document.getElementById('equipmentType').value = t.type || '';
            document.getElementById('equipmentLocation').value = e.location;
            const buildingInput = document.getElementById('equipmentBuildingSearch');
            buildingInput.value = b.name || '';
            buildingInput.dataset.selectedId = b.id;
            handleBuildingSearchChange(b.name || '');
            document.getElementById('equipmentFloor').value = e.floorName || '';
        }
        function editBuilding(id) { const b = data.buildings.find(bld => bld.id === id); if (!b) return; openBuildingModal(); document.getElementById('buildingId').value = b.id; document.getElementById('buildingName').value = b.name; document.getElementById('buildingAddress').value = b.address; document.getElementById('buildingLocation').value = b.locationName; const floorsContainer = document.getElementById('buildingFloorsContainer'); floorsContainer.innerHTML = ''; if (b.floors && b.floors.length > 0) { b.floors.forEach(floor => addFloorToBuildingModal(floor)); } else { addFloorToBuildingModal(); } }
        function editOrganization(id) { const o = data.organizations.find(org => org.id === id); if (!o) return; openOrganizationModal(); document.getElementById('organizationId').value = o.id; document.getElementById('organizationCompany').value = o.company; document.getElementById('organizationLocation').value = o.location; document.getElementById('organizationDepartment').value = o.department; document.getElementById('organizationManager').value = o.manager; }
        function editItemSet(id) { 
            const s = data.itemSets.find(set => set.id === id); 
            if (!s) return; 
            openItemSetModal(); 
            const typeInfo = data.equipmentTypes.find(t => t.id === s.typeId) || {}; 
            document.getElementById('itemSetId').value = s.id; 
            document.getElementById('itemSetName').value = s.name; 
            document.getElementById('itemSetIsStandard').checked = s.isStandard || false;
            document.getElementById('itemSetGroup').value = typeInfo.group; 
            updateItemSetTypeSelect(s.typeId); 
            document.getElementById('item-set-items-container').innerHTML = ''; 
            s.items.forEach(item => addDynamicItemToSet(item)); 
        }
        
        function editTemplate(id) {
            const t = data.templates.find(tpl => tpl.id === id);
            if (!t) return;
            openTemplateModal();
            const building = data.buildings.find(b => b.id === t.buildingId);
            const firstEquipment = data.equipment.find(e => e.id === t.equipmentIds[0]);
            const typeInfo = firstEquipment ? data.equipmentTypes.find(type => type.id === firstEquipment.typeId) : null;

            document.getElementById('templateId').value = t.id;
            document.getElementById('templateName').value = t.name;

            document.getElementById('modalTemplateLocationFilter').value = t.locationName;
            updateBuildingFilter('template');
            const buildingInput = document.getElementById('modalTemplateBuildingFilter');
            buildingInput.value = building ? building.name : '';
            if (building) buildingInput.dataset.selectedId = building.id;
            
            if(typeInfo) {
                document.getElementById('modalTemplateGroupFilter').value = typeInfo.group;
                updateTemplateTypeFilter();
                document.getElementById('modalTemplateTypeFilter').value = typeInfo.type;
            }

            handleTemplateModalFiltersChanged();
            renderEquipmentCheckboxesTable(t.equipmentIds);
            
            setTimeout(() => {
                const itemSetRadio = document.querySelector(`#modal-item-set-list-container input[value="${t.itemSetId}"]`);
                if(itemSetRadio) itemSetRadio.checked = true;
                renderTemplatePreview();
            }, 0);
        }
        function editWorkOrder(id) { 
            const w = data.workOrders.find(wo => wo.id === id); 
            if (!w) return; 
            openWorkOrderModal(); 
            document.getElementById('workOrderId').value = w.id; 
            document.getElementById('workOrderName').value = w.name; 
            
            const locInput = document.getElementById('modalWorkOrderLocationFilter');
            locInput.value = w.locationName;
            
            updateBuildingFilter('workOrder', w.buildingId);
            const buildInput = document.getElementById('modalWorkOrderBuildingFilter');
            const building = data.buildings.find(b => b.id === w.buildingId);
            if(building) {
                buildInput.value = building.name;
                buildInput.dataset.selectedId = building.id;
            }

            renderTemplateCheckboxesForWorkOrder();
            
            setTimeout(() => {
                 const checkboxes = document.querySelectorAll('#templateCheckboxesContainer input[type="checkbox"]');
                 checkboxes.forEach(cb => {
                     if (w.templateIds.includes(+cb.value)) {
                         cb.checked = true;
                     }
                 });
                 renderWorkOrderPreview();
            }, 100);
        }

        function addDynamicItemToSet(item = {}) {
            const container = document.getElementById('item-set-items-container');
            const row = document.createElement('div');
            row.className = 'item-set-item-row';
            row.dataset.id = item.id || '';

            const reorderHandle = `<div class="reorder-handle"><button type="button" class="btn btn-sm btn-icon btn-secondary" onclick="moveItemInSet(this, 'up')" title="上に移動">▲</button><button type="button" class="btn btn-sm btn-icon btn-secondary" onclick="moveItemInSet(this, 'down')" title="下に移動">▼</button></div>`;
            
            const scopeSelect = `<select class="form-select item-scope-select"><option value="標準" ${item.scope === '標準' ? 'selected' : ''}>標準</option><option value="現場" ${item.scope === '現場' ? 'selected' : ''}>現場</option></select>`;
            const categorySelect = `<select class="form-select item-category-select"><option value="設備" ${item.category === '設備' ? 'selected' : ''}>設備</option><option value="共通" ${item.category === '共通' ? 'selected' : ''}>共通</option></select>`;
            const typeSelect = `<select class="form-select item-type-select" onchange="updateItemRowControls(this)"><option value="text" ${item.inputType === 'text' ? 'selected' : ''}>テキスト</option><option value="number" ${item.inputType === 'number' ? 'selected' : ''}>数値</option><option value="select" ${item.inputType === 'select' ? 'selected' : ''}>選択肢</option></select>`;
            
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'item-options-wrapper';
            let optionsHtml = '<div class="item-options-container" style="display: none;">';
            if (item.inputType === 'select') { (item.options || []).forEach(opt => { optionsHtml += `<div class="option-input-group"><input type="text" class="form-input option-input" value="${opt}"><button type="button" class="btn btn-sm btn-danger btn-icon" onclick="this.parentElement.remove()">×</button></div>`; }); }
            optionsHtml += `<button type="button" class="btn btn-sm btn-secondary" onclick="addOptionToItemSet(this)">選択肢追加</button></div>`;
            const unitHtml = `<div class="item-unit-container input-with-unit" style="display: none;"><input type="text" class="form-input item-unit-input" placeholder="単位..." value="${item.unit || ''}"></div>`;
            controlsDiv.innerHTML = optionsHtml + unitHtml;

            const nameInput = `<textarea class="form-input item-name-input" placeholder="点検項目の内容..." rows="2" required>${item.name || ''}</textarea>`;
            
            const removeBtn = `<button type="button" class="btn btn-sm btn-danger btn-icon" onclick="this.closest('.item-set-item-row').remove()" title="この項目を削除" style="margin-top: 0.5rem;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg></button>`;

            row.innerHTML = `
                ${reorderHandle}
                <div class="item-content">
                    <div class="item-controls-row">
                        ${scopeSelect}
                        ${categorySelect}
                        ${typeSelect}
                    </div>
                    ${nameInput}
                    <div class="options-cell"></div>
                </div>
                ${removeBtn}
            `;
            row.querySelector('.options-cell').appendChild(controlsDiv);
            container.appendChild(row);
            updateItemRowControls(row.querySelector('.item-type-select'));
        }

        function moveItemInSet(button, direction) {
            const row = button.closest('.item-set-item-row');
            if (direction === 'up' && row.previousElementSibling) {
                row.parentElement.insertBefore(row, row.previousElementSibling);
            } else if (direction === 'down' && row.nextElementSibling) {
                row.parentElement.insertBefore(row.nextElementSibling, row);
            }
        }
        
        function updateItemSetTypeSelect(selectedTypeId = null) {
            const groupSelect = document.getElementById('itemSetGroup');
            const typeSelect = document.getElementById('itemSetType');
            const selectedGroup = groupSelect.value;
            typeSelect.innerHTML = '<option value="">種別を選択</option>';
            if(selectedGroup) {
                data.equipmentTypes.filter(t => t.group === selectedGroup).forEach(t => {
                    typeSelect.add(new Option(t.type, t.id));
                });
            }
            if(selectedTypeId) typeSelect.value = selectedTypeId;
        }

        function updateItemRowControls(selectElement) { 
            const row = selectElement.closest('.item-set-item-row'); 
            const optionsContainer = row.querySelector('.item-options-container'); 
            const unitContainer = row.querySelector('.item-unit-container'); 
            optionsContainer.style.display = selectElement.value === 'select' ? 'block' : 'none'; 
            unitContainer.style.display = selectElement.value === 'number' ? 'flex' : 'none'; 
        }
        function addOptionToItemSet(buttonElement) { const container = buttonElement.parentElement; const newOption = document.createElement('div'); newOption.className = 'option-input-group'; newOption.innerHTML = `<input type="text" class="form-input option-input"><button type="button" class="btn btn-sm btn-danger btn-icon" onclick="this.parentElement.remove()">×</button>`; container.insertBefore(newOption, buttonElement); }
        
        function handleTemplateModalFiltersChanged() {
            renderEquipmentCheckboxesTable();
            renderItemSetListForTemplateModal();
            renderTemplatePreview();
        }

        function renderEquipmentCheckboxesTable(checkedIds = []) {
            const cont = document.getElementById('equipmentCheckboxesTableContainer');
            const buildingInput = document.getElementById('modalTemplateBuildingFilter');
            const bId = buildingInput.dataset.selectedId ? +buildingInput.dataset.selectedId : null;
            
            const groupFilter = document.getElementById('modalTemplateGroupFilter').value;
            const typeFilter = document.getElementById('modalTemplateTypeFilter').value;
            const term = document.getElementById('modalEquipmentSearch').value.toLowerCase();
            
            if (!bId) {
                cont.innerHTML = '<p style="text-align:center; padding: 2rem;">最初に建物を選択してください。</p>';
                return;
            }

            let filteredEquipment = data.equipment.filter(eq => {
                if (eq.buildingId !== bId) return false;
                const typeInfo = data.equipmentTypes.find(t => t.id === eq.typeId);
                if (!typeInfo) return false;
                if (groupFilter && typeInfo.group !== groupFilter) return false;
                if (typeFilter && typeInfo.type !== typeFilter) return false;
                if (term && !eq.name.toLowerCase().includes(term)) return false;
                return true;
            });

            if (filteredEquipment.length === 0) {
                cont.innerHTML = '<p style="text-align:center; padding: 2rem;">該当する設備がありません。</p>';
                return;
            }

            const firstSelectedTypeId = checkedIds.length > 0 ? (data.equipment.find(e => e.id === checkedIds[0]) || {}).typeId : null;

            let html = '<table class="table"><thead><tr><th><input type="checkbox" onchange="toggleAllCheckboxes(event, \'equipmentCheckboxesTableContainer\')"></th><th>設備名</th><th>区分 / 種別</th></tr></thead><tbody>';
            html += filteredEquipment.map(eq => { 
                const chk = checkedIds.includes(eq.id) ? 'checked' : ''; 
                const disabled = firstSelectedTypeId && eq.typeId !== firstSelectedTypeId ? 'disabled' : '';
                return `<tr><td><input type="checkbox" value="${eq.id}" ${chk} ${disabled} onchange="handleEquipmentCheckboxChange(event)"></td><td>${eq.name}</td><td>${getEquipmentTypePath(eq.typeId)}</td></tr>`; 
            }).join('');
            html += '</tbody></table>';
            cont.innerHTML = html;
        }

        function handleEquipmentCheckboxChange(event) {
            const checkboxes = document.querySelectorAll('#equipmentCheckboxesTableContainer input[type="checkbox"]:not([onchange*="toggleAllCheckboxes"])');
            const checkedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
            
            if(checkedCheckboxes.length === 0) {
                checkboxes.forEach(cb => cb.disabled = false);
            } else {
                const firstCheckedId = checkedCheckboxes[0].value;
                const firstTypeId = (data.equipment.find(e => e.id == firstCheckedId) || {}).typeId;

                checkboxes.forEach(cb => {
                    const currentTypeId = (data.equipment.find(e => e.id == cb.value) || {}).typeId;
                    cb.disabled = currentTypeId !== firstTypeId;
                    if(cb.checked && cb.disabled) cb.checked = false;
                });
            }
            renderItemSetListForTemplateModal();
            renderTemplatePreview();
        }

        function renderItemSetListForTemplateModal() {
            const container = document.getElementById('modal-item-set-list-container');
            const searchInput = document.getElementById('modalItemSetSearch').value.toLowerCase();
            
            const checkedEqs = Array.from(document.querySelectorAll('#equipmentCheckboxesTableContainer input:checked')).map(cb => +cb.value);
            let targetTypeId = null;

            if (checkedEqs.length > 0) {
                targetTypeId = (data.equipment.find(e => e.id === checkedEqs[0]) || {}).typeId;
            } else {
                 const groupFilter = document.getElementById('modalTemplateGroupFilter').value;
                 const typeFilter = document.getElementById('modalTemplateTypeFilter').value;
                 if (typeFilter) {
                    const typeInfo = data.equipmentTypes.find(t => t.group === groupFilter && t.type === typeFilter);
                    if(typeInfo) targetTypeId = typeInfo.id;
                 }
            }

            if (!targetTypeId) {
                container.innerHTML = '<div class="list-group-item" style="text-align: center;">対象設備を選択してください</div>';
                return;
            }

            const availableItemSets = data.itemSets.filter(is => 
                is.typeId === targetTypeId && is.name.toLowerCase().includes(searchInput)
            );

            if (availableItemSets.length === 0) {
                 container.innerHTML = '<div class="list-group-item" style="text-align: center;">適合する点検表がありません</div>';
                 return;
            }

            container.innerHTML = availableItemSets.map(is => `
                <div class="list-group-item">
                    <label>
                        <input type="radio" name="templateItemSet" value="${is.id}" onchange="renderTemplatePreview()">
                        <div class="item-set-info">
                            <span>${is.name}</span>
                            <small>${is.isStandard ? '標準' : '個別'} / ${is.items.length}項目</small>
                        </div>
                    </label>
                </div>
            `).join('');
        }


        function toggleAllCheckboxes(event, contId) { document.querySelectorAll(`#${contId} tbody input[type="checkbox"]`).forEach(cb => { if(!cb.disabled) cb.checked = event.target.checked; }); handleEquipmentCheckboxChange(); renderWorkOrderPreview(); }
        
        function openWorkOrderModal() {
            document.getElementById('workOrderForm').reset();
            document.getElementById('workOrderId').value = '';
            document.getElementById('modalTemplateSearch').value = '';
            delete document.getElementById('modalWorkOrderLocationFilter').dataset.selectedId;
            delete document.getElementById('modalWorkOrderBuildingFilter').dataset.selectedId;
            updateBuildingFilter('workOrder');
            renderTemplateCheckboxesForWorkOrder();
            renderWorkOrderPreview();
            openModal('workOrderModal');
        }

        function renderTemplateCheckboxesForWorkOrder() {
            const cont = document.getElementById('templateCheckboxesContainer');
            const bId = +document.getElementById('modalWorkOrderBuildingFilter').dataset.selectedId;
            const term = document.getElementById('modalTemplateSearch').value.toLowerCase();

            if (!bId) {
                cont.innerHTML = '<p style="text-align:center; padding: 2rem;">最初に建物を選択してください。</p>';
                return;
            }
            const filteredTemplates = data.templates.filter(t => t.buildingId === bId && t.name.toLowerCase().includes(term));

            if (filteredTemplates.length === 0) {
                cont.innerHTML = '<p style="text-align:center; padding: 2rem;">この建物で利用可能なデータセットがありません。</p>';
                return;
            }
            let html = '<table class="table"><thead><tr><th><input type="checkbox" onchange="toggleAllCheckboxes(event, \'templateCheckboxesContainer\')"></th><th>データセット名</th><th>点検表</th><th>設備数</th></tr></thead><tbody>';
            html += filteredTemplates.map(t => {
                const itemSet = data.itemSets.find(s => s.id === t.itemSetId) || {};
                return `<tr>
                    <td><input type="checkbox" value="${t.id}" onchange="renderWorkOrderPreview()"></td>
                    <td>${t.name}</td>
                    <td>${itemSet.name || 'N/A'}</td>
                    <td>${t.equipmentIds.length}</td>
                </tr>`;
            }).join('');
            html += '</tbody></table>';
            cont.innerHTML = html;
        }

        function updateBuildingFilter(modalType, selectedBuildingId = null) {
            const locationFilter = document.getElementById(modalType === 'template' ? 'modalTemplateLocationFilter' : 'modalWorkOrderLocationFilter');
            const buildingInput = document.getElementById(modalType === 'template' ? 'modalTemplateBuildingFilter' : 'modalWorkOrderBuildingFilter');
            
            buildingInput.value = '';
            delete buildingInput.dataset.selectedId;

            if(modalType === 'template') handleTemplateModalFiltersChanged();
            if(modalType === 'workOrder') { 
                renderTemplateCheckboxesForWorkOrder(); 
                renderWorkOrderPreview();
            }
        }

        function updateTemplateTypeFilter() {
             document.getElementById('modalTemplateTypeFilter').value = '';
             delete document.getElementById('modalTemplateTypeFilter').dataset.selectedId;
        }

        // ★★★ ここからが修正の主要部分です ★★★

        // ★修正1: 点検作業プレビュー機能の追加
        function openWorkOrderPreviewDetail(workOrderId) {
            const workOrder = data.workOrders.find(w => w.id === workOrderId);
            if (!workOrder) { alert('点検作業が見つかりません。'); return; }

            document.getElementById('pageTitle').textContent = `「${workOrder.name}」のプレビュー`;
            currentWorkOrderPreview = {
                workOrder: workOrder,
                activeTemplateId: 'all',
                activeFloorName: 'all'
            };

            const allEquipmentIds = [...new Set(workOrder.templateIds.flatMap(tid => (data.templates.find(t => t.id === tid) || {equipmentIds: []}).equipmentIds))];
            const allFloors = [...new Set(
                allEquipmentIds.map(eqId => {
                    const eq = data.equipment.find(e => e.id === eqId);
                    return (eq && eq.floorName && eq.floorName.trim() !== '') ? eq.floorName : 'フロア指定なし';
                })
            )].sort();
            
            const floorTabsContainer = document.getElementById('preview-floor-tabs-container');
            let floorTabsHtml = `<div class="inspection-tab active" id="preview-floor-tab-all" onclick="switchPreviewActiveFloor('all')">すべて</div>`;
            allFloors.forEach(floor => {
                const floorId = floor.replace(/[^a-zA-Z0-9]/g, '-');
                floorTabsHtml += `<div class="inspection-tab" id="preview-floor-tab-${floorId}" onclick="switchPreviewActiveFloor('${floor}')">${floor}</div>`;
            });
            floorTabsContainer.innerHTML = floorTabsHtml;

            const tabsContainer = document.getElementById('preview-tabs');
            let datasetTabsHtml = `<div class="inspection-tab active" id="preview-tab-all" onclick="switchPreviewActiveTemplate('all')">すべて</div>`;
            workOrder.templateIds.forEach(templateId => {
                const template = data.templates.find(t => t.id === templateId);
                if (template) {
                    datasetTabsHtml += `<div class="inspection-tab" id="preview-tab-${templateId}" onclick="switchPreviewActiveTemplate(${templateId})">${template.name}</div>`;
                }
            });
            tabsContainer.innerHTML = datasetTabsHtml;

            showPage('work-order-preview-detail');
            switchPreviewActiveFloor('all');
        }

        function switchPreviewActiveFloor(floorName) {
            if (!currentWorkOrderPreview) return;
            currentWorkOrderPreview.activeFloorName = floorName;

            document.querySelectorAll('#preview-floor-tabs-container .inspection-tab').forEach(tab => tab.classList.remove('active'));
            const floorId = floorName === 'all' ? 'all' : floorName.replace(/[^a-zA-Z0-9]/g, '-');
            const activeTab = document.getElementById(`preview-floor-tab-${floorId}`);
            if(activeTab) activeTab.classList.add('active');
            
            const floorPlanWrapper = document.getElementById('preview-floor-plan-wrapper');
            const toggleBtn = document.getElementById('togglePreviewFloorPlanBtn');
            const canvasContainer = document.getElementById('preview-floor-plan-container');

            canvasContainer.innerHTML = '<canvas id="previewExecutionCanvas"></canvas>'; 
            
            if (floorName !== 'all' && currentWorkOrderPreview.workOrder.buildingId) {
                const building = data.buildings.find(b => b.id === currentWorkOrderPreview.workOrder.buildingId);
                if (building) {
                    const floor = building.floors.find(f => f.name === floorName);
                    if (floor && floor.photos && floor.photos.length > 0) {
                        floorPlanWrapper.classList.remove('hidden');
                        toggleBtn.style.display = 'inline-flex';
                        toggleBtn.textContent = '平面図を非表示';
                        setTimeout(() => {
                           if (previewExecutionCanvas) previewExecutionCanvas.dispose();
                           previewExecutionCanvas = setupFloorPlanCanvas('previewExecutionCanvas', floor.photos[0], floor.mappings || [], true);
                        }, 100);
                    } else {
                        floorPlanWrapper.classList.add('hidden');
                        toggleBtn.style.display = 'none';
                    }
                }
            } else {
                floorPlanWrapper.classList.add('hidden');
                toggleBtn.style.display = 'none';
            }
            
            if (currentWorkOrderPreview.activeTemplateId) {
                switchPreviewActiveTemplate(currentWorkOrderPreview.activeTemplateId);
            }
        }

        function switchPreviewActiveTemplate(targetTemplateId) {
            if(!currentWorkOrderPreview) return;
            currentWorkOrderPreview.activeTemplateId = targetTemplateId;
            document.querySelectorAll('#preview-tabs .inspection-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`preview-tab-${targetTemplateId}`).classList.add('active');

            const contentWrapper = document.getElementById('preview-content-wrapper');
            contentWrapper.innerHTML = '';

            const templatesToRender = targetTemplateId === 'all' 
                ? currentWorkOrderPreview.workOrder.templateIds 
                : [targetTemplateId];
            
            templatesToRender.forEach(templateId => {
                const template = data.templates.find(t => t.id === templateId);
                if (template) {
                    const datasetWrapper = document.createElement('div');
                    if (targetTemplateId === 'all') datasetWrapper.className = 'dataset-wrapper';

                    const title = document.createElement('h3');
                    title.className = 'dataset-title';
                    title.textContent = template.name;
                    datasetWrapper.appendChild(title);
                    
                    const commonContainer = document.createElement('div');
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-container';
                    const table = document.createElement('table');
                    table.className = 'table inspection-grid-table';
                    tableContainer.appendChild(table);

                    datasetWrapper.appendChild(commonContainer);
                    datasetWrapper.appendChild(tableContainer);
                    contentWrapper.appendChild(datasetWrapper);

                    generateInspectionGrid(template, true, null, { commonContainer: commonContainer, table: table }, true);
                }
            });
        }
        
        function startWorkOrderInspection(workOrderId, resultId = null) {
            const workOrder = data.workOrders.find(w => w.id === workOrderId);
            if (!workOrder) { alert('点検作業が見つかりません。'); return; }

            const isEditing = resultId !== null;
            const resultToEdit = isEditing ? data.workOrderResults.find(r => r.id === resultId) : null;
            
            const titlePrefix = isEditing ? `「${workOrder.name}」の結果編集` : `「${workOrder.name}」の実施`;
            document.getElementById('pageTitle').textContent = titlePrefix;

            currentWorkOrderExecution = {
                workOrder: workOrder,
                activeTemplateId: 'all', 
                activeFloorName: 'all',
                results: {},
                isEditingResultId: isEditing ? resultId : null
            };
            
            const allEquipmentIdsInWorkOrder = [...new Set(workOrder.templateIds.flatMap(tid => (data.templates.find(t => t.id === tid) || {equipmentIds: []}).equipmentIds))];
            const allFloors = [...new Set(
                allEquipmentIdsInWorkOrder.map(eqId => {
                    const eq = data.equipment.find(e => e.id === eqId);
                    return (eq && eq.floorName && eq.floorName.trim() !== '') ? eq.floorName : 'フロア指定なし';
                })
            )].sort();
            
            const floorTabsContainer = document.getElementById('inspection-floor-tabs-container');
            let floorTabsHtml = `<div class="inspection-tab active" id="floor-tab-all" onclick="switchActiveFloor('all')">すべて</div>`;
            allFloors.forEach(floor => {
                const floorId = floor.replace(/[^a-zA-Z0-9]/g, '-');
                floorTabsHtml += `<div class="inspection-tab" id="floor-tab-${floorId}" onclick="switchActiveFloor('${floor}')">${floor}</div>`;
            });
            floorTabsContainer.innerHTML = floorTabsHtml;

            const tabsContainer = document.getElementById('inspection-tabs');
            let datasetTabsHtml = `<div class="inspection-tab active" id="tab-all" onclick="switchActiveTemplate('all')">すべて</div>`;
            workOrder.templateIds.forEach(templateId => {
                const template = data.templates.find(t => t.id === templateId);
                if (template) {
                    datasetTabsHtml += `<div class="inspection-tab" id="tab-${templateId}" onclick="switchActiveTemplate(${templateId})">${template.name}</div>`;
                    
                    let equipmentResults = {};
                    if(isEditing && resultToEdit && resultToEdit.templateResults[templateId]) {
                        resultToEdit.templateResults[templateId].equipmentResults.forEach(eqRes => {
                            let itemResults = {};
                            eqRes.itemResults.forEach(itemRes => {
                                itemResults[itemRes.itemId] = { value: itemRes.value, isExcluded: itemRes.isExcluded };
                            });
                            equipmentResults[eqRes.equipmentId] = {
                                remarks: eqRes.remarks,
                                photos: eqRes.photos || [],
                                itemResults: itemResults
                            };
                        });
                    }
                    
                    let commonResults = {};
                     if(isEditing && resultToEdit && resultToEdit.templateResults[templateId]) {
                        (resultToEdit.templateResults[templateId].commonResults || []).forEach(comRes => {
                             commonResults[comRes.itemId] = comRes.value;
                        });
                    }

                    currentWorkOrderExecution.results[templateId] = {
                        templateId: templateId,
                        templateName: template.name,
                        commonResults: commonResults,
                        equipmentResults: equipmentResults,
                    };
                }
            });
            tabsContainer.innerHTML = datasetTabsHtml;

            showPage('inspection-execution');
            
            switchActiveFloor('all');
        }

        function switchActiveFloor(floorName) {
            if (!currentWorkOrderExecution) return;
            currentWorkOrderExecution.activeFloorName = floorName;

            document.querySelectorAll('#inspection-floor-tabs-container .inspection-tab').forEach(tab => tab.classList.remove('active'));
            const floorId = floorName === 'all' ? 'all' : floorName.replace(/[^a-zA-Z0-9]/g, '-');
            const activeTab = document.getElementById(`floor-tab-${floorId}`);
            if(activeTab) activeTab.classList.add('active');
            
            const floorPlanWrapper = document.getElementById('floor-plan-wrapper');
            const toggleBtn = document.getElementById('toggleFloorPlanBtn');
            const canvasContainer = document.getElementById('floor-plan-display-container');

            canvasContainer.innerHTML = '<canvas id="inspectionExecutionCanvas"></canvas>'; 
            
            if (floorName !== 'all' && currentWorkOrderExecution.workOrder.buildingId) {
                const building = data.buildings.find(b => b.id === currentWorkOrderExecution.workOrder.buildingId);
                if (building) {
                    const floor = building.floors.find(f => f.name === floorName);
                    if (floor && floor.photos && floor.photos.length > 0) {
                        floorPlanWrapper.classList.remove('hidden');
                        toggleBtn.style.display = 'inline-flex';
                        toggleBtn.textContent = '平面図を非表示';
                        setTimeout(() => {
                           if (inspectionExecutionCanvas) inspectionExecutionCanvas.dispose();
                           inspectionExecutionCanvas = setupFloorPlanCanvas('inspectionExecutionCanvas', floor.photos[0], floor.mappings || [], true);
                        }, 100);
                    } else {
                        floorPlanWrapper.classList.add('hidden');
                        toggleBtn.style.display = 'none';
                    }
                }
            } else {
                floorPlanWrapper.classList.add('hidden');
                toggleBtn.style.display = 'none';
            }
            
            if (currentWorkOrderExecution.activeTemplateId) {
                switchActiveTemplate(currentWorkOrderExecution.activeTemplateId);
            }
        }
        
        function switchActiveTemplate(targetTemplateId) {
            if(!currentWorkOrderExecution) return;
            const currentActiveId = currentWorkOrderExecution.activeTemplateId;
            if (currentActiveId) {
                saveCurrentGridState(currentActiveId);
            }
            
            currentWorkOrderExecution.activeTemplateId = targetTemplateId;
            document.querySelectorAll('#inspection-tabs .inspection-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${targetTemplateId}`).classList.add('active');

            const contentWrapper = document.getElementById('inspection-content-wrapper');
            contentWrapper.innerHTML = '';

            if (targetTemplateId === 'all') {
                currentWorkOrderExecution.workOrder.templateIds.forEach(templateId => {
                    const template = data.templates.find(t => t.id === templateId);
                    if (template) {
                        const datasetWrapper = document.createElement('div');
                        datasetWrapper.className = 'dataset-wrapper';

                        const title = document.createElement('h3');
                        title.className = 'dataset-title';
                        title.textContent = template.name;
                        datasetWrapper.appendChild(title);
                        
                        const commonContainer = document.createElement('div');
                        const tableContainer = document.createElement('div');
                        tableContainer.className = 'table-container';
                        const table = document.createElement('table');
                        table.className = 'table inspection-grid-table';
                        tableContainer.appendChild(table);

                        datasetWrapper.appendChild(commonContainer);
                        datasetWrapper.appendChild(tableContainer);
                        contentWrapper.appendChild(datasetWrapper);

                        generateInspectionGrid(template, false, null, { commonContainer: commonContainer, table: table }, true);
                    }
                });
            } else {
                const template = data.templates.find(t => t.id === targetTemplateId);
                if (template) {
                    const commonContainer = document.createElement('div');
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-container';
                    const table = document.createElement('table');
                    table.className = 'table inspection-grid-table';
                    tableContainer.appendChild(table);

                    contentWrapper.appendChild(commonContainer);
                    contentWrapper.appendChild(tableContainer);

                    generateInspectionGrid(template, false, null, { commonContainer: commonContainer, table: table }, true);
                }
            }
            restoreGridState(targetTemplateId);
        }

        function saveCurrentGridState(activeTemplateId) {
            if (!currentWorkOrderExecution) return;

            const templatesToSave = (activeTemplateId === 'all') 
                ? currentWorkOrderExecution.workOrder.templateIds
                : [activeTemplateId];

            templatesToSave.forEach(templateId => {
                const resultsForTemplate = currentWorkOrderExecution.results[templateId];
                if (!resultsForTemplate) return;
                
                const template = data.templates.find(t => t.id === templateId);
                if(!template) return;
                const itemSet = data.itemSets.find(s => s.id === template.itemSetId);
                if(!itemSet) return;

                itemSet.items.filter(i => i.category === '共通').forEach(item => {
                    const input = document.getElementById(`input_common_${templateId}_${item.id}`);
                    if (input) resultsForTemplate.commonResults[item.id] = input.value;
                });

                template.equipmentIds.forEach(eqId => {
                    const qtyInput = document.getElementById(`quantity_${templateId}_${eqId}`);
                    if (!resultsForTemplate.equipmentResults[eqId]) {
                        resultsForTemplate.equipmentResults[eqId] = { remarks: '', photos: [], itemResults: {} };
                    }
                    if(qtyInput) {
                        const eqIndex = data.equipment.findIndex(e => e.id === eqId);
                        if (eqIndex !== -1) data.equipment[eqIndex].quantity = +qtyInput.value;
                    }
                    itemSet.items.filter(i => i.category !== '共通').forEach(item => {
                        const inputElement = document.getElementById(`input_${templateId}_${eqId}_${item.id}`);
                        if(inputElement) {
                            const cell = inputElement.closest('.inspection-input-cell');
                            const checkbox = cell.querySelector('.na-checkbox input');
                            const isExcluded = checkbox ? checkbox.checked : false;
                            
                            resultsForTemplate.equipmentResults[eqId].itemResults[item.id] = {
                                value: isExcluded ? null : inputElement.value,
                                isExcluded: isExcluded
                            };
                        }
                    });
                });
            });
        }
        
        function restoreGridState(activeTemplateId) {
             const templatesToRestore = (activeTemplateId === 'all') 
                ? currentWorkOrderExecution.workOrder.templateIds
                : [activeTemplateId];

            templatesToRestore.forEach(templateId => {
                const resultsForTemplate = currentWorkOrderExecution.results[templateId];
                if (!resultsForTemplate) return;

                const template = data.templates.find(t => t.id === templateId);
                 if(!template) return;
                const itemSet = data.itemSets.find(s => s.id === template.itemSetId);
                if(!itemSet) return;

                itemSet.items.filter(i => i.category === '共通').forEach(item => {
                    const input = document.getElementById(`input_common_${templateId}_${item.id}`);
                    if (input && resultsForTemplate.commonResults[item.id] !== undefined) {
                        input.value = resultsForTemplate.commonResults[item.id];
                    }
                });

                const displayedEquipmentElements = document.querySelectorAll(`#inspection-content-wrapper [id^="remarks_display_${templateId}_"]`);
                displayedEquipmentElements.forEach(remarksDisplay => {
                    const eqId = remarksDisplay.id.split('_')[3]; 

                    const eqResult = resultsForTemplate.equipmentResults[eqId];
                    if (!eqResult) return;
                    
                    remarksDisplay.value = eqResult.remarks || '';
                    
                    const preview = document.getElementById(`preview-${templateId}-${eqId}`);
                    if(preview) {
                        preview.innerHTML = '';
                        (eqResult.photos || []).forEach(src => {
                             const img = document.createElement('img');
                             img.src = src;
                             img.onclick = () => openPhotoModal(src);
                             preview.appendChild(img);
                        });
                    }

                    itemSet.items.filter(i => i.category !== '共通').forEach(item => {
                        const input = document.getElementById(`input_${templateId}_${eqId}_${item.id}`);
                        if (!input) return;

                        const itemResult = eqResult.itemResults[item.id];
                        if (itemResult) {
                            input.disabled = itemResult.isExcluded;
                            input.value = itemResult.isExcluded ? '' : (itemResult.value || '');
                            const cell = input.closest('.inspection-input-cell');
                            if (cell) {
                                const checkbox = cell.querySelector('.na-checkbox input');
                                if(checkbox) checkbox.checked = itemResult.isExcluded;
                            }
                        }
                    });
                });
            });
        }

        function generateInspectionGrid(template, isReadonly, resultData, targetElements, applyFloorFilter = false, activeFloorName = null) {
            const { commonContainer, table } = targetElements;
            if (!template || !commonContainer || !table) return;

            const isPreview = isReadonly && !resultData;
            const templateId = template.id;
            const itemSet = data.itemSets.find(s => s.id === template.itemSetId);
            
            commonContainer.innerHTML = '';
            table.innerHTML = '';
            if (!itemSet) { table.innerHTML = '<tr><td>点検表が見つかりません。</td></tr>'; return; }

            let targetEq = data.equipment.filter(eq => template.equipmentIds.includes(eq.id));
            
            let floorToFilter = activeFloorName;
            if (applyFloorFilter) {
                if(currentWorkOrderExecution) floorToFilter = currentWorkOrderExecution.activeFloorName;
                else if(currentResultDetailState.resultId) floorToFilter = currentResultDetailState.floorName;
                else if(currentWorkOrderPreview) floorToFilter = currentWorkOrderPreview.activeFloorName;
            }


            if (applyFloorFilter && floorToFilter && floorToFilter !== 'all') {
                targetEq = targetEq.filter(eq => {
                    const floor = (eq.floorName && eq.floorName.trim() !== '') ? eq.floorName : 'フロア指定なし';
                    return floor === floorToFilter;
                });
            }

            const commonItems = itemSet.items.filter(i => i.category === '共通');
            const gridItems = itemSet.items.filter(i => i.category !== '共通');

            if (commonItems.length > 0) {
                let commonHtml = '<div class="common-items-container"><h3 class="card-title" style="margin-bottom: 1rem;">共通項目</h3><div class="common-items-grid">';
                commonItems.forEach(item => {
                    const value = resultData ? (resultData.commonResults.find(cr => cr.itemId === item.id) || {}).value : null;
                    commonHtml += `<div class="form-group"><label class="form-label">${item.name}</label>${generateInputField(item, `common_${templateId}`, isReadonly, value, false, isPreview)}</div>`;
                });
                commonHtml += '</div></div>';
                commonContainer.innerHTML = commonHtml;
            }

            let head = `<thead><tr><th class="equipment-cell">設備</th>`;
            gridItems.forEach(it => { head += `<th>${it.name}<br><span class="cycle-badge">${it.scope}</span></th>`});
            head += `<th style="min-width:280px;">備考 & 写真</th></tr></thead>`;
             
            let body = '<tbody>';
            if(targetEq.length === 0 && gridItems.length > 0) {
                body += `<tr><td colspan="${gridItems.length + 2}" style="text-align: center; padding: 2rem;">このフロアに該当する設備はありません。</td></tr>`;
            } else if (targetEq.length === 0 && gridItems.length === 0) {
                // 共通項目のみの場合、テーブル本体は表示しない
                table.style.display = 'none';
            } else {
                targetEq.forEach(eq => {
                    const building = data.buildings.find(b => b.id === eq.buildingId) || {};
                    const eqResult = resultData ? (resultData.equipmentResults.find(er => er.equipmentId === eq.id) || {}) : {};

                    body += `<tr><td class="equipment-cell"><div class="equipment-cell-content"><div>${eq.name}<br><small style="color: var(--color-text-secondary);">${building.name} / ${eq.floorName || 'フロア指定なし'}<br>${eq.location}</small></div>`;
                    if(!isReadonly) {
                        body += `<div style="display:flex; align-items:center; gap:0.5rem;"><span>個数:</span><input type="number" class="form-input equipment-quantity-input" id="quantity_${templateId}_${eq.id}" value="${eq.quantity}" min="0"></div>`;
                    } else {
                        body += `<div style="display:flex; align-items:center; gap:0.5rem;"><span>個数:</span><span class="readonly-value" style="padding:0;">${eq.quantity}</span></div>`;
                    }
                    body += `</div></td>`;

                    gridItems.forEach(it => {
                        const itemResult = eqResult.itemResults ? (eqResult.itemResults.find(ir => ir.itemId === it.id) || {}) : {};
                        const value = itemResult.value;
                        const isExcluded = itemResult.isExcluded;
                        
                        let inputCellHtml = '<div class="inspection-input-cell">';
                        if (!isReadonly) {
                             inputCellHtml += `<label class="na-checkbox"><input type="checkbox" onchange="toggleInputDisabled(this)" ${isExcluded ? 'checked' : ''}>対象外</label>`;
                        }
                        inputCellHtml += generateInputField(it, `${templateId}_${eq.id}`, isReadonly, value, isExcluded, isPreview);
                        inputCellHtml += '</div>';

                        body += `<td>${inputCellHtml}</td>`;
                    });

                    body += '<td>';
                    if(isReadonly && !isPreview) {
                        body += `<div class="readonly-notes">${(eqResult.remarks || '（備考なし）')}</div>`;
                    } else if (!isReadonly) {
                        body += `<textarea id="remarks_display_${templateId}_${eq.id}" class="form-input" placeholder="クリックして備考を編集" style="height:50px; cursor:pointer;" onfocus="this.blur(); openRemarksModal(${eq.id}, ${templateId})" readonly></textarea>`;
                    } else {
                        body += `<textarea class="form-input" placeholder="備考入力欄" style="height:50px;" disabled></textarea>`;
                    }
                    
                    const photos = eqResult.photos || [];
                    if (photos.length > 0) {
                        body += `<div class="photo-preview" style="margin-top: 1rem;">${photos.map(p => `<img src="${p.src ? p.src : p}" onclick="openPhotoModal('${p.src ? p.src : p}')">`).join('')}</div>`;
                    } else if (isReadonly && !isPreview) {
                         body += `<div style="margin-top: 1rem; color: var(--color-text-secondary);">（写真なし）</div>`;
                    }

                    if (!isReadonly) {
                        body += `<div style="display:flex; align-items:center; gap:0.75rem; margin-top:0.75rem;">
                                    <label class="photo-upload-label btn btn-secondary btn-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M1 8a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 018.07 3h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0016.07 6H17a2 2 0 012 2v7a2 2 0 01-2 2H3a2 2 0 01-2-2V8zm5 4a3 3 0 116 0 3 3 0 01-6 0z" clip-rule="evenodd" /></svg>
                                        <span>写真を追加</span>
                                        <input type="file" accept="image/*" multiple onchange="handleWorkOrderPhotoUpload(event, ${eq.id}, ${templateId})">
                                    </label>
                                    <div class="photo-preview" id="preview-${templateId}-${eq.id}"></div>
                                </div>`;
                    } else if (isPreview) {
                        body += `<div style="margin-top:0.75rem;"><label class="photo-upload-label btn btn-secondary btn-sm disabled" style="cursor: not-allowed;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M1 8a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 018.07 3h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0016.07 6H17a2 2 0 012 2v7a2 2 0 01-2 2H3a2 2 0 01-2-2V8zm5 4a3 3 0 116 0 3 3 0 01-6 0z" clip-rule="evenodd" /></svg><span>写真を追加</span></label></div>`;
                    }
                     body += '</td></tr>';
                });
            }

            body += '</tbody>';
            table.innerHTML = head + body;
        }
                function saveWorkOrderInspection() {
            if (!currentWorkOrderExecution) return;
            saveCurrentGridState(currentWorkOrderExecution.activeTemplateId);
            
            let isPending = false;
            const finalResults = {};

            for (const tId in currentWorkOrderExecution.results) {
                const templateResult = currentWorkOrderExecution.results[tId];
                const finalTemplateResult = {
                    templateId: templateResult.templateId,
                    templateName: templateResult.templateName,
                    commonResults: Object.entries(templateResult.commonResults).map(([itemId, value]) => ({ itemId: +itemId, value })),
                    equipmentResults: []
                };

                for (const eqId in templateResult.equipmentResults) {
                    const eqResult = templateResult.equipmentResults[eqId];
                    const finalEqResult = {
                        equipmentId: +eqId,
                        remarks: eqResult.remarks,
                        photos: eqResult.photos.map(p => ({ src: p })),
                        itemResults: []
                    };
                    for (const itemId in eqResult.itemResults) {
                        const itemRes = eqResult.itemResults[itemId];
                        finalEqResult.itemResults.push({
                            itemId: +itemId,
                            value: itemRes.value,
                            isExcluded: itemRes.isExcluded
                        });
                        if (!isPending && ['異常', '要交換', '損傷あり', '不点灯', 'ちらつき','有り'].includes(itemRes.value)) {
                            isPending = true;
                        }
                    }
                    finalTemplateResult.equipmentResults.push(finalEqResult);
                }
                finalResults[tId] = finalTemplateResult;
            }

            const isEditing = currentWorkOrderExecution.isEditingResultId !== null;
            const finalWorkOrderResult = {
                id: isEditing ? currentWorkOrderExecution.isEditingResultId : Date.now(),
                workOrderId: currentWorkOrderExecution.workOrder.id,
                workOrderName: currentWorkOrderExecution.workOrder.name,
                executionDate: new Date().toLocaleDateString('ja-JP'),
                status: 'pending',
                templateResults: finalResults
            };
            
            if (isEditing) {
                const resultIndex = data.workOrderResults.findIndex(r => r.id === finalWorkOrderResult.id);
                if (resultIndex !== -1) {
                    data.workOrderResults[resultIndex] = finalWorkOrderResult;
                    alert('点検結果を更新しました。ステータスは「要確認」となります。');
                }
            } else {
                data.workOrderResults.push(finalWorkOrderResult);
                alert('点検結果を保存しました。ステータスは「要確認」です。');
            }

            currentWorkOrderExecution = null;
            renderAllTables();
            showPage('work-results-management');
        }
        
        function handleWorkOrderPhotoUpload(event, eqId, templateId) {
            const preview = document.getElementById(`preview-${templateId}-${eqId}`);
            if (!currentWorkOrderExecution.results[templateId].equipmentResults[eqId]) {
                 currentWorkOrderExecution.results[templateId].equipmentResults[eqId] = { remarks: '', photos: [], itemResults: {} };
            }
            const photos = currentWorkOrderExecution.results[templateId].equipmentResults[eqId].photos || [];
            
            Array.from(event.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const imgSrc = e.target.result;
                    photos.push(imgSrc);

                    const img = document.createElement('img');
                    img.src = imgSrc;
                    img.onclick = () => openPhotoModal(imgSrc);
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
            currentWorkOrderExecution.results[templateId].equipmentResults[eqId].photos = photos;
        }

        function showResultDetail(resultId, highlightEquipmentId = null) {
            const result = data.workOrderResults.find(r => r.id === resultId);
            if (!result) return;
            
            const workOrder = data.workOrders.find(wo => wo.id === result.workOrderId);
            if (!workOrder) { alert("関連する点検作業が見つかりません。"); return; }
            
            currentResultDetailState = { resultId, floorName: 'all', templateId: null, highlightEquipmentId };
            
            document.getElementById('pageTitle').textContent = `「${result.workOrderName}」の結果詳細`;

            const editBtn = document.getElementById('editResultBtn');
            const confirmBtn = document.getElementById('confirmResultBtn');
            
            if (result.status === 'pending') {
                editBtn.style.display = 'inline-flex';
                confirmBtn.style.display = 'inline-flex';
                editBtn.onclick = () => startWorkOrderInspection(result.workOrderId, result.id);
                confirmBtn.onclick = () => confirmWorkOrderResult(result.id);
            } else {
                editBtn.style.display = 'none';
                confirmBtn.style.display = 'none';
            }
            
            const allEquipmentIdsInResult = [...new Set(Object.values(result.templateResults).flatMap(tr => tr.equipmentResults.map(er => er.equipmentId)))];
            const allFloors = [...new Set(allEquipmentIdsInResult.map(eqId => {
                const eq = data.equipment.find(e => e.id === eqId);
                return (eq && eq.floorName && eq.floorName.trim() !== '') ? eq.floorName : 'フロア指定なし';
            }))].sort();

            const floorTabsContainer = document.getElementById('result-detail-floor-tabs-container');
            let floorTabsHtml = `<div class="inspection-tab active" id="result-floor-tab-all" onclick="switchResultDetailFloor('all')">すべて</div>`;
            allFloors.forEach(floor => {
                const floorId = floor.replace(/[^a-zA-Z0-9]/g, '-');
                floorTabsHtml += `<div class="inspection-tab" id="result-floor-tab-${floorId}" onclick="switchResultDetailFloor('${floor}')">${floor}</div>`;
            });
            floorTabsContainer.innerHTML = floorTabsHtml;

            const templateTabsContainer = document.getElementById('result-detail-tabs');
            let templateTabsHtml = '';
            workOrder.templateIds.forEach(templateId => {
                const template = data.templates.find(t => t.id === templateId);
                if (template && result.templateResults[templateId]) {
                     templateTabsHtml += `<div class="inspection-tab" id="result-tab-${templateId}" onclick="switchResultDetailTemplate(${templateId})">${template.name}</div>`;
                }
            });
            templateTabsContainer.innerHTML = templateTabsHtml;

            showPage('result-detail-view');

            const firstAvailableTemplateId = workOrder.templateIds.find(tid => result.templateResults[tid]);
            
            if(firstAvailableTemplateId) {
                switchResultDetailFloor('all', firstAvailableTemplateId);
            }
        }

        function switchResultDetailFloor(floorName, templateId = null) {
            currentResultDetailState.floorName = floorName;
            
            document.querySelectorAll('#result-detail-floor-tabs-container .inspection-tab').forEach(tab => tab.classList.remove('active'));
            const floorId = floorName === 'all' ? 'all' : floorName.replace(/[^a-zA-Z0-9]/g, '-');
            document.getElementById(`result-floor-tab-${floorId}`).classList.add('active');

            switchResultDetailTemplate(templateId || currentResultDetailState.templateId);
        }

        function switchResultDetailTemplate(templateId){
            if (!templateId) return;
            currentResultDetailState.templateId = templateId;
            const { resultId, floorName, highlightEquipmentId } = currentResultDetailState;
            const result = data.workOrderResults.find(r => r.id === resultId);
            const template = data.templates.find(t => t.id === templateId);
            const resultForTemplate = result.templateResults[templateId];

            document.querySelectorAll('#result-detail-tabs .inspection-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`result-tab-${templateId}`).classList.add('active');

            const targetElements = {
                commonContainer: document.getElementById('result-common-items-container'),
                table: document.getElementById('resultGridTable')
            };

            if (template && resultForTemplate) {
                generateInspectionGrid(template, true, resultForTemplate, targetElements, true);
            } else {
                targetElements.table.innerHTML = '<tr><td>このデータセットの点検結果はありません。</td></tr>';
                targetElements.commonContainer.innerHTML = '';
            }
             updateResultFloorPlan();
        }

        function updateResultFloorPlan() {
            const { resultId, floorName, highlightEquipmentId } = currentResultDetailState;
            const result = data.workOrderResults.find(r => r.id === resultId);
            const workOrder = data.workOrders.find(wo => wo.id === result.workOrderId);

            const floorPlanWrapper = document.getElementById('result-floor-plan-wrapper');
            const toggleBtn = document.getElementById('toggleResultFloorPlanBtn');
            const canvasContainer = document.getElementById('result-floor-plan-container');
            
            if (resultDetailCanvas) {
                resultDetailCanvas.dispose();
                resultDetailCanvas = null;
            }
            
            canvasContainer.innerHTML = '<canvas id="resultDetailCanvas"></canvas>';

            if (floorName === 'all') {
                floorPlanWrapper.classList.add('hidden');
                toggleBtn.style.display = 'none';
                return;
            }

            const building = data.buildings.find(b => b.id === workOrder.buildingId);
            const floor = building ? building.floors.find(f => f.name === floorName) : null;

            if (floor && floor.photos && floor.photos.length > 0) {
                const imageUrl = floor.photos[0];
                floorPlanWrapper.classList.remove('hidden');
                toggleBtn.style.display = 'inline-flex';
                toggleBtn.textContent = '平面図を非表示';

                setTimeout(() => {
                   if (resultDetailCanvas) resultDetailCanvas.dispose();
                   resultDetailCanvas = setupFloorPlanCanvas('resultDetailCanvas', imageUrl, floor.mappings || [], true, highlightEquipmentId);
                }, 100);
            } else {
                floorPlanWrapper.classList.add('hidden');
                toggleBtn.style.display = 'none';
            }
        }
        
        function openInspectionHistoryModal(equipmentId, equipmentName) {
            const modalTitle = document.getElementById('inspectionHistoryModalTitle');
            modalTitle.textContent = `「${equipmentName}」の点検履歴`;
            const contentDiv = document.getElementById('inspectionHistoryContent');
            
            contentDiv.innerHTML = `
                <div class="modal-filters">
                    <input type="text" id="historySearchInput" class="form-input" placeholder="点検作業名で検索...">
                </div>
                <div class="table-container" style="max-height: 60vh;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>実施日</th>
                                <th>点検作業名</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="inspectionHistoryTableBody"></tbody>
                    </table>
                </div>`;

            const history = getInspectionHistoryForEquipment(equipmentId);
            const searchInput = document.getElementById('historySearchInput');
            
            searchInput.oninput = () => renderInspectionHistoryTable(history, equipmentId);

            renderInspectionHistoryTable(history, equipmentId);
            openModal('inspectionHistoryModal');
        }

        function renderInspectionHistoryTable(history, equipmentId) {
            const tbody = document.getElementById('inspectionHistoryTableBody');
            const filterText = document.getElementById('historySearchInput').value.toLowerCase();
            
            const filteredHistory = history.filter(h => h.workOrderName.toLowerCase().includes(filterText));
            
            tbody.innerHTML = filteredHistory.map(h => `
                <tr>
                    <td>${h.date}</td>
                    <td>${h.workOrderName}</td>
                    <td style="text-align: right;">
                        <button class="btn btn-sm btn-secondary" onclick="closeAllModals(); showResultDetailModal(${h.resultId}, ${equipmentId});">詳細表示</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="3" style="text-align: center; padding: 1rem;">履歴がありません。</td></tr>';
        }

        function confirmWorkOrderResult(resultId) {
            if (!confirm('この点検結果を確定し、完了しますか？完了後は編集できなくなります。')) return;

            const resultIndex = data.workOrderResults.findIndex(r => r.id === resultId);
            if (resultIndex !== -1) {
                data.workOrderResults[resultIndex].status = 'completed';
                alert('結果を完了にしました。');
                renderWorkResultsTable();
                showPage('work-results-management');
            }
        }
        
        function findItem(itemId) {
            for(const itemSet of data.itemSets) {
                const found = itemSet.items.find(i => i.id == itemId);
                if (found) return found;
            }
            return null;
        }

        function generateInputField(item, suffix, isReadonly, value, isExcluded = false, isPreview = false) {
            const id = `input_${suffix}_${item.id}`;

            if (isReadonly) {
                 const readonlyValue = isExcluded ? '対象外' : (value || '—');
                 return `<div class="readonly-value ${isExcluded ? 'text-secondary' : ''}">${readonlyValue}</div>`;
            }
            
            if (item.inputType === 'text') return `<input type="text" class="form-input" id="${id}" value="${value || ''}" ${isExcluded ? 'disabled' : ''}>`;
            if (item.inputType === 'select') return `<select class="form-select" id="${id}" ${isExcluded ? 'disabled' : ''}><option value="">選択</option>${item.options.map(o => `<option value="${o}" ${o === value ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
            if (item.inputType === 'number') {
                const unitHtml = item.unit ? `<span>${item.unit}</span>` : '';
                return `<div class="input-with-unit"><input type="number" class="form-input" id="${id}" value="${value || ''}" ${isExcluded ? 'disabled' : ''}>${unitHtml}</div>`;
            }
            return '';
        }

        function toggleInputDisabled(checkbox) {
            const cell = checkbox.closest('.inspection-input-cell');
            const field = cell.querySelector('.form-input, .form-select, .input-with-unit > input');
            if (field) {
                field.disabled = checkbox.checked;
                if (checkbox.checked) {
                    if (field.tagName === 'SELECT') field.selectedIndex = 0;
                    else field.value = '';
                }
            }
        }
       
        function renderTemplatePreview() {
            const buildingInput = document.getElementById('modalTemplateBuildingFilter');
            const buildingId = buildingInput.dataset.selectedId;
            const equipmentIds = Array.from(document.querySelectorAll('#equipmentCheckboxesTableContainer input:checked')).map(cb => +cb.value);
            const itemSetRadio = document.querySelector('#modal-item-set-list-container input[name="templateItemSet"]:checked');
            const itemSetId = itemSetRadio ? +itemSetRadio.value : null;

            const previewStep = document.getElementById('templatePreviewStep');

            if (!buildingId || equipmentIds.length === 0 || !itemSetId) {
                previewStep.style.display = 'none';
                return;
            }
            previewStep.style.display = 'block';

            const templateForPreview = {
                id: 'preview',
                buildingId: +buildingId,
                equipmentIds: equipmentIds,
                itemSetId: itemSetId,
            };

            const targetElements = {
                commonContainer: document.getElementById('templatePreviewCommonItems'),
                table: document.getElementById('templatePreviewGridTable')
            };

            generateInspectionGrid(templateForPreview, true, null, targetElements, false);
        }

        function renderWorkOrderPreview(){
            const previewStep = document.getElementById('workOrderPreviewStep');
            const previewContainer = document.getElementById('workOrderPreviewContainer');
            const selectedTemplateIds = Array.from(document.querySelectorAll('#templateCheckboxesContainer input:checked')).map(cb => +cb.value);

            previewContainer.innerHTML = '';
            if(selectedTemplateIds.length === 0){
                previewStep.style.display = 'none';
                return;
            }
            previewStep.style.display = 'block';

            selectedTemplateIds.forEach((templateId, index) => {
                const template = data.templates.find(t => t.id === templateId);
                if(template) {
                    const templateWrapper = document.createElement('div');
                    if(index > 0) templateWrapper.style.marginTop = '2rem';
                    
                    const title = document.createElement('h4');
                    title.textContent = `データセット: ${template.name}`;
                    title.style.marginBottom = '1rem';
                    
                    const commonContainer = document.createElement('div');
                    const table = document.createElement('table');
                    table.className = 'table inspection-grid-table';
                    
                    templateWrapper.appendChild(title);
                    templateWrapper.appendChild(commonContainer);
                    templateWrapper.appendChild(table);
                    previewContainer.appendChild(templateWrapper);
                    
                    generateInspectionGrid(template, true, null, { commonContainer, table }, false);
                }
            });
        }

        function handleBuildingSearchChange(buildingName) {
            const buildingInput = document.getElementById('equipmentBuildingSearch');
            const options = getDatalistOptionsFor('equipmentBuildingSearch');
            const selectedOption = options.find(b => b.value === buildingName);
            const buildingId = selectedOption ? selectedOption.id : null;
            if (buildingId) {
                buildingInput.dataset.selectedId = buildingId;
            } else {
                delete buildingInput.dataset.selectedId;
            }
            updateFloorSelect(buildingId);
        }

        function updateFloorSelect(buildingId, selectedFloor = '') {
            const floorSelect = document.getElementById('equipmentFloor');
            floorSelect.innerHTML = '<option value="">建物にのみ紐づけ (フロアなし)</option>';
            if (!buildingId) return;
            const building = data.buildings.find(b => b.id == buildingId);
            if (building && building.floors) {
                building.floors.forEach(floor => {
                    const option = new Option(floor.name, floor.name);
                    floorSelect.add(option);
                });
                floorSelect.value = selectedFloor;
            }
        }

        function addFloorToBuildingModal(floor = { name: '', photos: [] }) {
            const container = document.getElementById('buildingFloorsContainer');
            const floorRow = document.createElement('div');
            floorRow.className = 'floor-row';
            floorRow.dataset.originalName = floor.name || ''; // Store the original name

            let photosHtml = '';
            const floorPlanSrc = floor.photos && floor.photos.length > 0 ? floor.photos[0] : null;
            if (floorPlanSrc) {
                photosHtml = `<img src="${floorPlanSrc}" onclick="openPhotoModal('${floorPlanSrc}')">`;
            }

            const mappingButtonDisplay = floorPlanSrc ? '' : 'style="display:none;"';

            floorRow.innerHTML = `
                <input type="text" class="form-input floor-name-input" placeholder="フロア名 (例: 1F)" value="${floor.name || ''}" required>
                <label class="photo-upload-label btn btn-secondary btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path d="M10 3a.75.75 0 01.75.75v1.5h1.5a.75.75 0 010 1.5h-1.5v1.5a.75.75 0 01-1.5 0v-1.5h-1.5a.75.75 0 010-1.5h1.5v-1.5A.75.75 0 0110 3z" /><path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h9.5A2.25 2.25 0 0117 4.25v11.5A2.25 2.25 0 0114.75 18h-9.5A2.25 2.25 0 013 15.75V4.25zM5.25 3.5a.75.75 0 00-.75.75v11.5c0 .414.336.75.75.75h9.5a.75.75 0 00.75-.75V4.25a.75.75 0 00-.75-.75h-9.5z" clip-rule="evenodd" /></svg>
                    <span>平面図</span>
                    <input type="file" accept="image/*" onchange="handleBuildingPhotoUpload(event, this)">
                </label>
                <div class="photo-preview">${photosHtml}</div>
                <button type="button" class="btn btn-sm btn-secondary mapping-btn" ${mappingButtonDisplay} 
                        onclick="openMappingModal(document.getElementById('buildingId').value, this.closest('.floor-row').querySelector('.floor-name-input').value, this)">設備紐づけ</button>
                <button type="button" class="btn btn-sm btn-danger btn-icon" onclick="this.closest('.floor-row').remove()" title="このフロアを削除" style="margin-left: auto;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>
                </button>
            `;
            const previewContainer = floorRow.querySelector('.photo-preview');
            previewContainer.innerHTML = photosHtml;
            container.appendChild(floorRow);
        }

        function handleBuildingPhotoUpload(event, inputElement) {
            const row = inputElement.closest('.floor-row');
            const preview = row.querySelector('.photo-preview');
            const mappingBtn = row.querySelector('.mapping-btn');
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                preview.innerHTML = '';
                const img = document.createElement('img');
                img.src = e.target.result;
                img.onclick = () => openPhotoModal(e.target.result);
                preview.appendChild(img);
                if(mappingBtn) mappingBtn.style.display = 'inline-flex';
            };
            reader.readAsDataURL(file);
        }
        
        function setupFloorPlanResizer() {
            const handle = document.getElementById('resize-handle');
            const container = document.getElementById('floor-plan-display-container');
            let isResizing = false;

            const onResize = (entries) => {
                 if(inspectionExecutionCanvas && entries[0]) {
                    const { width, height } = entries[0].contentRect;
                    inspectionExecutionCanvas.setWidth(width).setHeight(height);
                    const bgImage = inspectionExecutionCanvas.backgroundImage;
                    if(bgImage) {
                         const scale = Math.min(width / bgImage.width, height / bgImage.height);
                         bgImage.scale(scale);
                         bgImage.set({
                            left: (width - bgImage.getScaledWidth()) / 2,
                            top: (height - bgImage.getScaledHeight()) / 2,
                        });
                        
                        const oldScale = inspectionExecutionCanvas.customScale || 1;
                        inspectionExecutionCanvas.getObjects().forEach(obj => {
                            obj.set({
                                left: obj.left * (scale / oldScale),
                                top: obj.top * (scale / oldScale),
                                scaleX: obj.scaleX * (scale / oldScale),
                                scaleY: obj.scaleY * (scale / oldScale),
                            });
                            obj.setCoords();
                        });
                        inspectionExecutionCanvas.customScale = scale;

                        inspectionExecutionCanvas.renderAll();
                    }
                 }
            };
            resizeObserver = new ResizeObserver(onResize);
            resizeObserver.observe(container);

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.userSelect = 'none'; 
                const startY = e.clientY;
                const startHeight = container.offsetHeight;

                function onMouseMove(e) {
                    if (!isResizing) return;
                    const newHeight = startHeight + e.clientY - startY;
                     const minHeight = parseInt(getComputedStyle(container).minHeight, 10);
                     const maxHeight = parseInt(getComputedStyle(container).maxHeight, 10);
                     if (newHeight >= minHeight && newHeight <= maxHeight) {
                        container.style.height = `${newHeight}px`; 
                     }
                }

                function onMouseUp() {
                    isResizing = false;
                    document.body.style.userSelect = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        function toggleFloorPlanDisplay() {
            const wrapper = document.getElementById('floor-plan-wrapper');
            const btn = document.getElementById('toggleFloorPlanBtn');
            wrapper.classList.toggle('hidden');
            if (wrapper.classList.contains('hidden')) {
                btn.textContent = '平面図を表示';
            } else {
                btn.textContent = '平面図を非表示';
            }
        }

        function getShapeDisplayName(shape) {
            if (!shape || !shape.customId) return 'N/A';
            let name = '図形';
            const type = shape.type;
            if (type === 'rect') name = '四角';
            else if (type === 'circle') name = '円';
            else if (type === 'triangle') name = '三角';
            else if (type === 'polygon') name = 'ひし形';
            return `${name}-${String(shape.customId).padStart(3, '0')}`;
        }

        function updateSelectedShapeInfo(activeObject, isPreview = false) {
            const infoDiv = document.getElementById(isPreview ? 'selected-shape-info-preview' : 'selected-shape-info');

            if (!activeObject) {
                infoDiv.innerHTML = '<h5>選択中の図形</h5><p>キャンバス上の図形を選択してください。</p>';
                return;
            }
            const displayName = getShapeDisplayName(activeObject);
            if (activeObject.equipmentId) {
                const equipment = data.equipment.find(e => e.id === activeObject.equipmentId);
                if (equipment) {
                    const typePath = getEquipmentTypePath(equipment.typeId);
                    infoDiv.innerHTML = `
                        <h5>選択中の図形: ${displayName} (紐付け済み)</h5>
                        <p>
                            <strong>設備名:</strong> ${equipment.name}<br>
                            <small><strong>分類:</strong> ${typePath}</small>
                        </p>
                    `;
                }
            } else {
                infoDiv.innerHTML = `<h5>選択中の図形: ${displayName} (未紐付け)</h5><p>この図形には設備が紐づいていません。</p>`;
            }
        }

        function updateSelectedEquipmentInfo(equipmentId, isPreview = false) {
            const infoDiv = document.getElementById(isPreview ? 'selected-equipment-info-preview' : 'selected-equipment-info');
            if (!equipmentId) {
                infoDiv.innerHTML = '<h5>選択中の設備</h5><p>リストから設備を選択してください。</p>';
                return;
            }
            const equipment = data.equipment.find(e => e.id === equipmentId);
            if (equipment) {
                const typePath = getEquipmentTypePath(equipment.typeId);
                 infoDiv.innerHTML = `
                    <h5>選択中の設備</h5>
                    <p>
                        <strong>設備名:</strong> ${equipment.name}<br>
                        <small><strong>分類:</strong> ${typePath}</small>
                    </p>
                `;
            }
        }

        function setupCanvasEventListeners(canvasInstance, isPreview = false) {
             const handleSelection = (e)  => {
                const activeObject = canvasInstance.getActiveObject();
                
                canvasInstance.getObjects().forEach(obj => {
                    obj.set({
                        stroke: obj.equipmentId ? '#3b82f6' : 'black',
                        strokeWidth: obj.equipmentId ? 2 : 1
                    });
                });
                
                if (activeObject) {
                    activeObject.set({ stroke: '#f59e0b', strokeWidth: 4 });
                }
                
                updateSelectedShapeInfo(activeObject, isPreview);

                const listContainerSelector = isPreview ? '#mappingPreviewModal' : '#mappingModal';
                document.querySelectorAll(`${listContainerSelector} .list-group-item.active`).forEach(item => item.classList.remove('active'));

                if (activeObject && activeObject.equipmentId) {
                    const itemEl = document.querySelector(`${listContainerSelector} .list-group-item[data-equipment-id='${activeObject.equipmentId}']`);
                    if (itemEl) {
                        itemEl.classList.add('active');
                        selectedEquipmentId = activeObject.equipmentId;
                        updateSelectedEquipmentInfo(selectedEquipmentId, isPreview);
                    }
                } else if(selectedEquipmentId){
                     const itemEl = document.querySelector(`${listContainerSelector} .list-group-item[data-equipment-id='${selectedEquipmentId}']`);
                     if(itemEl) itemEl.classList.add('active');
                }
                
                canvasInstance.renderAll();
            };
            
            canvasInstance.on({
                'selection:created': handleSelection,
                'selection:updated': handleSelection,
                'selection:cleared': handleSelection
            });
        }

        function openMappingModal(buildingId, floorName, element) {
            activeBuildingId = buildingId;
            activeFloorName = floorName;
            shapeIdCounter = 1;
            selectedEquipmentId = null;

            const floorRow = element.closest('.floor-row');
            const img = floorRow.querySelector('.photo-preview img');

            if (!img || !img.src) {
                alert('平面図の画像データが見つかりません。');
                return;
            }
            const imageUrl = img.src;

            let buildingName = "新規建物";
            let floorMappings = [];
            if (buildingId) {
                const building = data.buildings.find(b => b.id == buildingId);
                if (building) {
                    buildingName = building.name;
                    const floor = building.floors.find(f => f.name === floorName);
                    if (floor) {
                        floorMappings = floor.mappings || [];
                    }
                }
            }
            
            document.getElementById('mappingModalTitle').textContent = `「${buildingName} - ${floorName}」の設備紐づけ`;
            openModal('mappingModal');

            setTimeout(() => {
                if (mappingCanvas) mappingCanvas.dispose();
                mappingCanvas = setupFloorPlanCanvas('mappingCanvas', imageUrl, floorMappings);
                renderMappingEquipmentList(buildingId, false);
                updateSelectedShapeInfo(null, false);
                updateSelectedEquipmentInfo(null, false);
                setupCanvasEventListeners(mappingCanvas, false);
            }, 100);

            document.getElementById('mappingSearchName').oninput = () => renderMappingEquipmentList(buildingId, false);
            document.getElementById('mappingSearchCategory').oninput = () => renderMappingEquipmentList(buildingId, false);
        }

        function renderMappingEquipmentList(buildingId, isPreview = false) {
            const unlinkedContainer = document.getElementById(isPreview ? 'unlinked-equipment-list-preview' : 'unlinked-equipment-list');
            const linkedContainer = document.getElementById(isPreview ? 'linked-equipment-list-preview' : 'linked-equipment-list');
            const nameFilter = document.getElementById(isPreview ? 'mappingSearchNamePreview' : 'mappingSearchName').value.toLowerCase();
            const categoryFilter = document.getElementById(isPreview ? 'mappingSearchCategoryPreview' : 'mappingSearchCategory').value.toLowerCase();
            
            let linkedIdsInMappings = new Set();
            if (buildingId) {
                const building = data.buildings.find(b => b.id == buildingId);
                const floor = building ? building.floors.find(f => f.name === activeFloorName) : null;
                if(floor && floor.mappings) {
                    linkedIdsInMappings = new Set(floor.mappings.map(m => m.equipmentId));
                }
            } else { 
                if (mappingCanvas) {
                    linkedIdsInMappings = new Set(mappingCanvas.getObjects().filter(o => o.equipmentId).map(o => o.equipmentId));
                }
            }

            const equipmentInBuildingOrFloor = data.equipment.filter(eq => eq.buildingId == buildingId && (eq.floorName === activeFloorName || eq.floorName === '' || !eq.floorName));
            
            const filteredEquipment = equipmentInBuildingOrFloor.filter(eq => {
                const typePath = getEquipmentTypePath(eq.typeId, ' ').toLowerCase();
                const nameMatch = eq.name.toLowerCase().includes(nameFilter);
                const categoryMatch = typePath.includes(categoryFilter);
                return nameMatch && categoryMatch;
            });

            let unlinkedHtml = '';
            let linkedHtml = '';
            const onclickAction = `selectEquipmentInMapping(this, ${isPreview})`;

            filteredEquipment.forEach(eq => {
                const itemHtml = `<div class="list-group-item" data-equipment-id="${eq.id}" onclick="${onclickAction}">
                                    ${eq.name}
                                    <br><small style="color: var(--color-text-secondary);">${getEquipmentTypePath(eq.typeId)}</small>
                                </div>`;
                if (linkedIdsInMappings.has(eq.id)) {
                    linkedHtml += itemHtml;
                } else {
                    unlinkedHtml += itemHtml;
                }
            });
            
            unlinkedContainer.innerHTML = unlinkedHtml || `<div class="list-group-item" style="text-align:center; padding: 1rem; color: var(--color-text-secondary);">該当なし</div>`;
            linkedContainer.innerHTML = linkedHtml || `<div class="list-group-item" style="text-align:center; padding: 1rem; color: var(--color-text-secondary);">該当なし</div>`;
        }
        
        function setupFloorPlanCanvas(canvasId, imageUrl, mappings = [], isPreview = false, highlightEquipmentId = null) {
            const canvasEl = document.getElementById(canvasId);
            const container = canvasEl.parentElement;
            
            canvasEl.width = container.clientWidth;
            canvasEl.height = container.clientHeight;

            let canvasInstance = new fabric.Canvas(canvasId, { backgroundColor: '#f0f0f0' });
            
            fabric.Image.fromURL(imageUrl, (img) => {
                const scale = Math.min(canvasEl.width / img.width, canvasEl.height / img.height);
                img.set({
                    scaleX: scale,
                    scaleY: scale,
                    left: (canvasEl.width - img.width * scale) / 2,
                    top: (canvasEl.height - img.height * scale) / 2,
                    selectable: false,
                    evented: false,
                });
                canvasInstance.setBackgroundImage(img, canvasInstance.renderAll.bind(canvasInstance));
                
                canvasInstance.customScale = scale; 

                loadShapesToCanvas(canvasInstance, mappings, isPreview, scale, img.left, img.top);

                if (highlightEquipmentId) {
                     const targetShape = canvasInstance.getObjects().find(obj => obj.equipmentId === highlightEquipmentId);
                     if (targetShape) {
                        targetShape.set({
                            stroke: '#ef4444', 
                            strokeWidth: 5,
                            shadow: '0 0 10px rgba(239, 68, 68, 0.8)'
                        });
                        canvasInstance.viewportCenterObject(targetShape);
                        const zoom = canvasInstance.getZoom();
                        if(zoom < 1.5) {
                            canvasInstance.zoomToPoint(new fabric.Point(targetShape.getCenterPoint().x, targetShape.getCenterPoint().y), 1.5);
                        }
                        canvasInstance.renderAll();
                     }
                }
            });
            return canvasInstance;
        }

        function loadShapesToCanvas(canvasInstance, mappings, isPreview = false, scale = 1, imgLeft = 0, imgTop = 0) { 
            mappings.forEach(shapeData => {
                let shape;
                const props = {
                    left: (shapeData.left * scale) + imgLeft,
                    top: (shapeData.top * scale) + imgTop,
                    fill: shapeData.fill,
                    angle: shapeData.angle,
                    scaleX: shapeData.scaleX * scale,
                    scaleY: shapeData.scaleY * scale,
                    equipmentId: shapeData.equipmentId,
                    stroke: shapeData.equipmentId ? '#3b82f6' : 'black',
                    strokeWidth: shapeData.equipmentId ? 2 : 1,
                    customId: shapeIdCounter++,
                    selectable: true, 
                    evented: true, 
                    lockMovementX: isPreview,
                    lockMovementY: isPreview,
                    lockScalingX: isPreview,
                    lockScalingY: isPreview,
                    lockRotation: isPreview,
                    hasControls: !isPreview,
                    hasBorders: !isPreview, 
                };

                switch (shapeData.type) {
                    case 'rect':
                        shape = new fabric.Rect({ ...props, width: shapeData.width, height: shapeData.height });
                        break;
                    case 'circle':
                        shape = new fabric.Circle({ ...props, radius: shapeData.radius });
                        break;
                    case 'triangle':
                        shape = new fabric.Triangle({ ...props, width: shapeData.width, height: shapeData.height });
                        break;
                    case 'rhombus':
                        const points = [
                            { x: 0, y: shapeData.height / 2 },
                            { x: shapeData.width / 2, y: 0 },
                            { x: shapeData.width, y: shapeData.height / 2 },
                            { x: shapeData.width / 2, y: shapeData.height }
                        ];
                        shape = new fabric.Polygon(points, { ...props });
                        break;
                }
                if (shape) canvasInstance.add(shape);
            });
            canvasInstance.renderAll();
        }

        function addShapeToCanvas(shapeType) {
            const color = document.getElementById('shapeColorPicker').value;
            let shape;
            const commonProps = {
                left: 50,
                top: 50,
                fill: color,
                stroke: 'black',
                strokeWidth: 1,
                objectCaching: false,
                customId: shapeIdCounter++
            };
            switch (shapeType) {
                case 'rect':
                    shape = new fabric.Rect({ ...commonProps, width: 80, height: 60 });
                    break;
                case 'circle':
                    shape = new fabric.Circle({ ...commonProps, radius: 40 });
                    break;
                case 'triangle':
                    shape = new fabric.Triangle({ ...commonProps, width: 70, height: 80 });
                    break;
                case 'rhombus':
                     shape = new fabric.Polygon([
                        { x: 0, y: 40 }, { x: 50, y: 0 }, { x: 100, y: 40 }, { x: 50, y: 80 }
                     ], { ...commonProps });
                     break;
            }
            if (shape) mappingCanvas.add(shape).setActiveObject(shape);
        }

        function changeSelectedShapeColor(color) {
            const activeObj = mappingCanvas.getActiveObject();
            if (activeObj) {
                activeObj.set('fill', color);
                mappingCanvas.renderAll();
            }
        }

        function deleteSelectedShape() {
            const activeObj = mappingCanvas.getActiveObject();
            if (activeObj && confirm('選択中の図形を削除しますか？')) {
                mappingCanvas.remove(activeObj);
                renderMappingEquipmentList(activeBuildingId, false);
                updateSelectedShapeInfo(null, false);
            }
        }

        function linkEquipmentToShape() {
            const activeShape = mappingCanvas.getActiveObject();
            
            if (!activeShape || !selectedEquipmentId) {
                alert('平面図上の図形と、リスト内の設備の両方を選択してください。');
                return;
            }
            
            //他の図形に紐付いていたら、それを解除
            mappingCanvas.getObjects().forEach(obj => {
                if (obj.equipmentId === selectedEquipmentId) {
                    delete obj.equipmentId;
                    obj.set({ stroke: 'black', strokeWidth: 1 });
                }
            });

            activeShape.set('equipmentId', selectedEquipmentId);
            activeShape.set({ stroke: '#3b82f6', strokeWidth: 2 });
            
            saveMappingData(false); 
            mappingCanvas.renderAll();
            renderMappingEquipmentList(activeBuildingId, false);
            updateSelectedShapeInfo(activeShape, false);
        }

        function unlinkEquipmentFromShape() {
            const activeShape = mappingCanvas.getActiveObject();
            if (activeShape && activeShape.equipmentId) {
                delete activeShape.equipmentId;
                activeShape.set({ stroke: 'black', strokeWidth: 1 });
                
                saveMappingData(false); 
                mappingCanvas.renderAll();
                renderMappingEquipmentList(activeBuildingId, false);
                updateSelectedShapeInfo(activeShape, false);
            } else {
                alert('紐づけられた図形を選択してください。');
            }
        }

        function selectEquipmentInMapping(element, isPreview = false) {
            const equipmentId = parseInt(element.dataset.equipmentId, 10);
            
            if (element.classList.contains('active')) {
                element.classList.remove('active');
                selectedEquipmentId = null;
                updateSelectedEquipmentInfo(null, isPreview);
                return;
            }

            const listContainerSelector = isPreview ? '#mappingPreviewModal' : '#mappingModal';
            document.querySelectorAll(`${listContainerSelector} .list-group-item.active`).forEach(item => item.classList.remove('active'));

            element.classList.add('active');
            selectedEquipmentId = equipmentId;
            updateSelectedEquipmentInfo(selectedEquipmentId, isPreview);

            const canvasInstance = isPreview ? resultDetailModalCanvas : mappingCanvas;
            if(canvasInstance) {
                const activeShape = canvasInstance.getActiveObject();
                if (!activeShape || activeShape.equipmentId !== equipmentId) {
                    const shape = canvasInstance.getObjects().find(obj => obj.equipmentId === equipmentId);
                    if (shape) {
                        canvasInstance.setActiveObject(shape).renderAll();
                    }
                }
            }
        }

        function saveMappingData(showAlert = true) {
            const building = data.buildings.find(b => b.id == activeBuildingId);
            if (!building) {
                if(showAlert) alert('建物の保存が完了していないため、紐づけ情報を保存できません。先に建物情報を保存してください。');
                return;
            };

            const floorIndex = building.floors.findIndex(f => f.name === activeFloorName);
            if (floorIndex === -1) return;

            const image = mappingCanvas.backgroundImage;
            const scale = image.scaleX;

            building.floors[floorIndex].mappings = mappingCanvas.getObjects().map(obj => {
                let specificProps = {};
                const type = obj.type === 'polygon' ? 'rhombus' : obj.type;

                const width = obj.getScaledWidth() / scale;
                const height = obj.getScaledHeight() / scale;

                switch(type) {
                    case 'rect':
                    case 'triangle':
                    case 'rhombus':
                        specificProps = { width: width, height: height };
                        break;
                    case 'circle':
                        specificProps = { radius: (obj.radius * obj.scaleX) / scale };
                        break;
                }
                
                const relativeLeft = (obj.left - image.left) / scale;
                const relativeTop = (obj.top - image.top) / scale;


                return {
                    type: type,
                    left: relativeLeft,
                    top: relativeTop,
                    scaleX: 1,
                    scaleY: 1,
                    angle: obj.angle,
                    fill: obj.fill,
                    equipmentId: obj.equipmentId || null,
                    ...specificProps
                };
            });

            if(showAlert){
                alert('紐づけ情報を保存しました。');
                closeAllModals();
                renderBuildingTable();
            }
        }

        function openMappingPreviewModal(buildingId, floorName) {
            activeBuildingId = buildingId;
            activeFloorName = floorName;
            selectedEquipmentId = null;

            const building = data.buildings.find(b => b.id === +buildingId);
            if (!building) return;
            const floor = building.floors.find(f => f.name === floorName);

            if (!floor || !floor.photos || floor.photos.length === 0) {
                alert('平面図の画像データが見つかりません。');
                return;
            }
            const imageUrl = floor.photos[0];

            document.getElementById('mappingPreviewModalTitle').textContent = `「${building.name} - ${floor.name}」のフロア設備参照`;
            openModal('mappingPreviewModal');
            
            setTimeout(() => {
                if(resultDetailModalCanvas) resultDetailModalCanvas.dispose();
                resultDetailModalCanvas = setupFloorPlanCanvas('mappingPreviewCanvas', imageUrl, floor.mappings || [], true);
                renderMappingEquipmentList(buildingId, true);
                updateSelectedShapeInfo(null, true);
                updateSelectedEquipmentInfo(null, true);
                setupCanvasEventListeners(resultDetailModalCanvas, true); 
            }, 100);

            document.getElementById('mappingSearchNamePreview').oninput = () => renderMappingEquipmentList(buildingId, true);
            document.getElementById('mappingSearchCategoryPreview').oninput = () => renderMappingEquipmentList(buildingId, true);
        }

        function openWorkOrderPreviewModal(workOrderId) {
            openWorkOrderPreviewDetail(workOrderId);
        }

        function showResultDetailModal(resultId, highlightEquipmentId = null) {
            const result = data.workOrderResults.find(r => r.id === resultId);
            if (!result) return;
            
            const workOrder = data.workOrders.find(wo => wo.id === result.workOrderId);
            if (!workOrder) return;

            document.getElementById('resultDetailModalTitle').textContent = `「${result.workOrderName}」の結果詳細 (実施日: ${result.executionDate})`;

            const allEquipmentIdsInResult = [...new Set(Object.values(result.templateResults).flatMap(tr => tr.equipmentResults.map(er => er.equipmentId)))];
            const allFloors = [...new Set(allEquipmentIdsInResult.map(eqId => {
                const eq = data.equipment.find(e => e.id === eqId);
                return (eq && eq.floorName) ? eq.floorName : 'フロア指定なし';
            }))].sort();

            const floorTabsContainer = document.getElementById('result-detail-modal-floor-tabs-container');
            let floorTabsHtml = `<div class="inspection-tab active" data-floor="all">すべて</div>`;
            allFloors.forEach(floor => {
                const floorId = floor.replace(/[^a-zA-Z0-9]/g, '-');
                floorTabsHtml += `<div class="inspection-tab" data-floor="${floor}">${floor}</div>`;
            });
            floorTabsContainer.innerHTML = floorTabsHtml;

            const templateTabsContainer = document.getElementById('result-detail-modal-tabs');
            templateTabsContainer.innerHTML = '';
            workOrder.templateIds.forEach(templateId => {
                const template = data.templates.find(t => t.id === templateId);
                if (template && result.templateResults[templateId]) {
                    templateTabsContainer.innerHTML += `<div class="inspection-tab" data-template="${templateId}">${template.name}</div>`;
                }
            });

            openModal('resultDetailModal');
            
            // Event delegation for tabs
            floorTabsContainer.onclick = (e) => {
                if (e.target.classList.contains('inspection-tab')) {
                    const floorName = e.target.dataset.floor;
                    switchResultDetailModalView({ resultId, highlightEquipmentId, floorName });
                }
            };
            templateTabsContainer.onclick = (e) => {
                if (e.target.classList.contains('inspection-tab')) {
                    const templateId = +e.target.dataset.template;
                    switchResultDetailModalView({ resultId, highlightEquipmentId, templateId });
                }
            };
            document.getElementById('toggleResultDetailModalFloorPlanBtn').onclick = () => {
                document.getElementById('result-detail-modal-floor-plan-wrapper').classList.toggle('hidden');
            };

            const firstTemplateId = workOrder.templateIds.find(tid => result.templateResults[tid]);
            switchResultDetailModalView({ resultId, highlightEquipmentId, templateId: firstTemplateId, floorName: 'all' });
        }
        
        function switchResultDetailModalView({ resultId, highlightEquipmentId, floorName, templateId }) {
            const currentFloor = floorName !== undefined ? floorName : document.querySelector('#result-detail-modal-floor-tabs-container .active').dataset.floor;
            const currentTemplate = templateId !== undefined ? templateId : +document.querySelector('#result-detail-modal-tabs .active').dataset.template;
            
            const result = data.workOrderResults.find(r => r.id === resultId);
            const workOrder = data.workOrders.find(wo => wo.id === result.workOrderId);
            const template = data.templates.find(t => t.id === currentTemplate);
            const resultForTemplate = result.templateResults[currentTemplate];

            document.querySelectorAll('#result-detail-modal-floor-tabs-container .inspection-tab, #result-detail-modal-tabs .inspection-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#result-detail-modal-floor-tabs-container [data-floor="${currentFloor}"]`).classList.add('active');
            document.querySelector(`#result-detail-modal-tabs [data-template="${currentTemplate}"]`).classList.add('active');

            const targetElements = {
                commonContainer: document.getElementById('result-common-items-container-modal'),
                table: document.getElementById('resultGridTableModal')
            };

            if (template && resultForTemplate) {
                generateInspectionGrid(template, true, resultForTemplate, targetElements, true, currentFloor);
            }

            const floorPlanWrapper = document.getElementById('result-detail-modal-floor-plan-wrapper');
            const toggleBtn = document.getElementById('toggleResultDetailModalFloorPlanBtn');
            const canvasContainer = floorPlanWrapper.querySelector('#result-floor-plan-container');
            if (resultDetailModalCanvas) { resultDetailModalCanvas.dispose(); resultDetailModalCanvas = null; }
            canvasContainer.innerHTML = '<canvas id="resultDetailModalCanvas"></canvas>';
            
            if (currentFloor !== 'all') {
                const building = data.buildings.find(b => b.id === workOrder.buildingId);
                const floor = building.floors.find(f => f.name === currentFloor);
                if (floor && floor.photos && floor.photos.length > 0) {
                    floorPlanWrapper.classList.remove('hidden');
                    toggleBtn.style.display = 'inline-flex';
                    setTimeout(() => {
                        resultDetailModalCanvas = setupFloorPlanCanvas('resultDetailModalCanvas', floor.photos[0], floor.mappings || [], true, highlightEquipmentId);
                    }, 100);
                } else {
                    floorPlanWrapper.classList.add('hidden');
                    toggleBtn.style.display = 'none';
                }
            } else {
                 floorPlanWrapper.classList.add('hidden');
                 toggleBtn.style.display = 'none';
            }
        }
    </script>
</body>
</html>
